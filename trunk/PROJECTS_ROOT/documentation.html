<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 4, revision: 0, date: new Date("May 9, 2008"), extensions: {}};
//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) UnaMesa Association 2004-2008

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>
<!--}}}-->
<!--PRE-HEAD-END-->
<title> Office villagers - MonkeyGTD </title>
<style id="styleArea" type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}
</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.checkUnsavedChanges) checkUnsavedChanges(); if(window.scrubNodes) scrubNodes(document.body);">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston, Copyright &copy; 2007 UnaMesa Association
</div>
<noscript>
	<div id="javascriptWarning">This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected{color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
	border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}
.sparktick {background:[[ColorPalette::PrimaryDark]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}
.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:'alpha(opacity:60)';}
/*}}}*/</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0em 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0em 1em 1em; left:0px; top:0px;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0em 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 .3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0em 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0em 0em 0em; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0em;}
.wizardFooter .status {padding:0em 0.4em 0em 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em 0.1em 0.2em;}

#messageArea {position:fixed; top:2em; right:0em; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}
.messageToolbar {display:block; text-align:right; padding:0.2em 0.2em 0.2em 0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em 0.2em 0.2em 0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em 1em 1em 1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0em;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0em 0em 0.5em;}
.tab {margin:0em 0em 0em 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0em 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0em 1em;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0em 0.25em; padding:0em 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0em; font-size:.9em;}
.editorFooter .button {padding-top:0px; padding-bottom:0px;}

.fieldsetFix {border:0; padding:0; margin:1px 0px 1px 0px;}

.sparkline {line-height:1em;}
.sparktick {outline:0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em 0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em 0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0em; right:0em;}
#backstageButton a {padding:0.1em 0.4em 0.1em 0.4em; margin:0.1em 0.1em 0.1em 0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; margin:0em 3em 0em 3em; padding:1em 1em 1em 1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em 0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea {display: none ! important;}
#displayArea {margin: 1em 1em 0em 1em;}
/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
noscript {display:none;}
}
/*}}}*/</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:
* SiteTitle &amp; SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* MainMenu: The menu (usually on the left)
* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="OptionsPanel">
<pre>These InterfaceOptions for customising TiddlyWiki are saved in your browser

Your username for signing your edits. Write it as a WikiWord (eg JoeBloggs)

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; SaveBackups
&lt;&lt;option chkAutoSave&gt;&gt; AutoSave
&lt;&lt;option chkRegExpSearch&gt;&gt; RegExpSearch
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; CaseSensitiveSearch
&lt;&lt;option chkAnimate&gt;&gt; EnableAnimations

----
Also see AdvancedOptions</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;</pre>
</div>
</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="(No Area)" modifier="YourName" created="200805021304" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList startTag:Project title:'Projects with no area' tags:'!Complete' view:Project mode:global
	group:ProjectStatus
	gView:bold
	where:tiddler.getByIndex('Area').length==0
	&gt;&gt;
</pre>
</div>
<div title="(No Context)" modifier="YourName" created="200805021303" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList startTag:Action title:'You should give these actions a context' tags:'!Done' view:DoneAction mode:global
	where:tiddler.getByIndex('Context').length==0&amp;&amp;tiddler.hasActiveProject()
	&gt;&gt;
</pre>
</div>
<div title="(No Project)" modifier="YourName" created="200805021304" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList startTag:Action title:'Actions with no project' tags:'!Done' view:DoneAction mode:global
	where:tiddler.getByIndex('Project').length==0
	&gt;&gt;

</pre>
</div>
<div title="3coltemplate" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

}}}

{{col{

}}}

{{col{

}}}

}}}

</pre>
</div>
<div title="About Quick Add" modifier="YourName" created="200805021307" modified="200805221358" tags="View excludeSearch">
<pre>Enter projects and actions here. Click 'create these items' to create them.
Example usage:
{{{
Paint House
.Buy ladder and brushes|@Errand
.Choose colours|@Home|W
}}}
By default actions are next actions. 
Specify W or F to make them future or Waiting For. You can create multiple projects and project-less actions.

You can also specify area for projects. Order dosn't matter, as there can only be one uniquely named tiddler. The following is valid:
{{{
Paint House|Home Maintenance|Personal
.Buy ladder and brushes|@Errand
.Choose colours|W|@Home
}}}
To specify multiple projects and tasks, along with project-less actions, the below is an example of one way create two projects with tasks, and then a stand alone action.
{{{
Clean up yard|Personal|Home Maintenance
.Pick up sticks|@Weekend
.Bag all the sticks|@Weekend
Check out latest SAN offerings|Research|Work
.Read up on all major vendors offerings|@Reading
.Call Doug for opinion|@Call
.Check budget|@Work|F

.Call Tara about tickets
}}}
If you want to add an action to an already existing project, you can specify the project name to do so:
{{{
.Pick up lumber at Home Depot|Build toolshed|@Errand
}}}

</pre>
</div>
<div title="Action" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Action Dashboard" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

&lt;&lt;tiddler 'Ticklers Requiring Action'&gt;&gt;

&lt;&lt;mgtdList
	title:'Next Actions'
	startTag:Action tags:'Next &amp;&amp; !Done'
	view:ActionProj
	mode:global
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Next'
&gt;&gt;

&lt;&lt;mgtdList
	title:'Waiting Actions'
	startTag:Action
	tags:'[(Waiting For)] &amp;&amp; !Done'
	view:ActionProj
	mode:global
	where:tiddler.hasActiveProject()
	newButtonTags:'Action [(Waiting For)]'
&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList
	title:'Future Actions'
	startTag:Action
	tags:'Future &amp;&amp; !Done'
	view:ActionProj
	mode:global
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Future'
&gt;&gt;

{{scroll10{

&lt;&lt;mgtdList
	title:'Done Actions'
	startTag:Action
	tags:'Done'
	view:DoneAction
	mode:global
	newButtonTags:'Action Next Done'
	sort:-modified
&gt;&gt;

}}}

}}}

{{col{

&lt;&lt;mgtdList
	title:'Active Projects'
	startTag:Project
	tags:'!Complete &amp;&amp; !Someday/Maybe'
	view:ProjectBare
	mode:global
	newButtonTags:'Project Active'
&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="Action Dashboard by Context" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

&lt;&lt;tiddler 'Ticklers Requiring Action'&gt;&gt;

&lt;&lt;mgtdList title:'Next Actions' startTag:Action tags:'Next &amp;&amp; !Done' view:ActionProj mode:global
	group:Context
	gView:Context
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Next'
	&gt;&gt;

&lt;&lt;mgtdList title:'Waiting Actions' startTag:Action tags:'[(Waiting For)] &amp;&amp; !Done' view:ActionProj mode:global
	group:Context
	gView:Context
	where:tiddler.hasActiveProject()
	newButtonTags:'Action [(Waiting For)]'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Future Actions' startTag:Action tags:'Future &amp;&amp; !Done' view:ActionProj mode:global
	group:Context
	gView:Context
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Future'
	&gt;&gt;

{{scroll10{
&lt;&lt;mgtdList title:'Done Actions' startTag:Action tags:'Done' view:DoneAction mode:global
	newButtonTags:'Action Next Done'
	sort:-modified
&gt;&gt;
}}}

}}}

{{col{

&lt;&lt;mgtdList title:'Active Projects' startTag:Project tags:'!Complete &amp;&amp; !Someday/Maybe' view:ProjectBare mode:global
	newButtonTags:'Project Active'
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="Action Dashboard by Project" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

&lt;&lt;tiddler 'Ticklers Requiring Action'&gt;&gt;

&lt;&lt;mgtdList title:'Next Actions' startTag:Action tags:'Next &amp;&amp; !Done' view:Action mode:global
	group:Project
	gView:bold
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Next'
	&gt;&gt;

&lt;&lt;mgtdList title:'Waiting Actions' startTag:Action tags:'[(Waiting For)] &amp;&amp; !Done' view:Action mode:global
	group:Project
	gView:bold
	where:tiddler.hasActiveProject()
	newButton:'Action [(Waiting For)]'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Future Actions' startTag:Action tags:'Future &amp;&amp; !Done' view:Action mode:global
	group:Project
	gView:bold
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Future'
	&gt;&gt;

}}}

{{col{

{{scroll10{

&lt;&lt;mgtdList title:'Done Actions' startTag:Action tags:'Done' view:DoneAction mode:global
	group:Project
	gView:bold
	sort:-modified
	newButtonTags:'Action Next Done'
	where:tiddler.hasActiveProject()
	&gt;&gt;

}}}

}}}

}}}
</pre>
</div>
<div title="Active" modifier="YourName" created="200805221358" modified="200805221358" tags="ProjectStatus">
<pre>order:1
button:a
buttonLong:active
</pre>
</div>
<div title="Active Projects With No Next Action" modifier="YourName" created="200805091505" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList startTag:Project title:'You must assign a next action to these projects (or make them into Someday/Maybe)'
	tags:'!Complete &amp;&amp; !Someday/Maybe' view:Project mode:global
	where:!tiddler.hasNextActionOrSubProject()
	&gt;&gt;
</pre>
</div>
<div title="Area" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Cleanup" modifier="YourName" created="200805091241" modified="200805221358" tags="View excludeSearch">
<pre>!!Actions
Done actions older than 14 days.  &lt;&lt;deleteAllTagged 'Delete old actions' 'Action' '' 'Done' 'tiddler.olderThanDays(14)'&gt;&gt;
&lt;&lt;mgtdList title:'Done actions older than 14 days'
	view:DoneAction
	mode:global
	sort:-modified
	startTag:Action
	tags:'Done'
	where:'tiddler.olderThanDays(14)'
	&gt;&gt;
!!Ticklers
Inactive ticklers older than 14 days.  &lt;&lt;deleteAllTagged 'Delete old ticklers' 'Tickler' '' 'Actioned' 'tiddler.olderThanDays(14)'&gt;&gt;
&lt;&lt;mgtdList title:'Inactive ticklers older than 14 days'
	startTag:Tickler
	tags:'Actioned'
	view:Tickler
	mode:global
	sort:-tickleDate
	where:'tiddler.olderThanDays(14)'
	&gt;&gt;
!!Projects
Completed projects older than 14 days. (Delete individually).
&lt;&lt;mgtdList title:'Completed projects older than 14 days'
	mode:global
	sort:-modified
	startTag:Project
	tags:'Complete'
	view:ProjectComplete
	where:'tiddler.olderThanDays(14)'
	&gt;&gt;
</pre>
</div>
<div title="CloseOnCancelPlugin" modifier="MPTW" created="200803080053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|CloseOnCancelPlugin|
|Description:|Closes the tiddler if you click new tiddler then cancel. Default behaviour is to leave it open|
|Version:|3.0.1 ($Rev: 3861 $)|
|Date:|$Date: 2008-03-08 10:53:09 +1000 (Sat, 08 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#CloseOnCancelPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
***/
//{{{
merge(config.commands.cancelTiddler,{

	handler_mptw_orig_closeUnsaved: config.commands.cancelTiddler.handler,

	handler: function(event,src,title) {
		this.handler_mptw_orig_closeUnsaved(event,src,title);
		if (!store.tiddlerExists(title) &amp;&amp; !store.isShadowTiddler(title))
			story.closeTiddler(title,true);
	 	return false;
	}

});

//}}}

</pre>
</div>
<div title="CollectItemsMenu" modifier="YourName" created="200803100039" modified="200805221358" tags="excludeSearch">
<pre>!Collect Items
* ...
</pre>
</div>
<div title="ColorPalette" modifier="MPTW" created="200803062257" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwBlue
Background: #fff
Foreground: #000
PrimaryPale: #cdf
PrimaryLight: #57c
PrimaryMid: #114
PrimaryDark: #012
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88

</pre>
</div>
<div title="CommonMenu" modifier="YourName" created="200804231348" modified="200805221358" tags="excludeSearch">
<pre>&lt;&lt;saveChanges&gt;&gt;
&lt;&lt;search&gt;&gt;
&lt;&lt;closeAll&gt;&gt;
</pre>
</div>
<div title="ConfigMenu" modifier="YourName" created="200805072223" modified="200805221358" tags="excludeSearch">
<pre>&lt;&lt;tiddler 'MgtdSettings'&gt;&gt;
!!Theme
(Currently &lt;&lt;eval {{config.options.txtTheme}}&gt;&gt;)
&lt;&lt;selectTheme&gt;&gt;
</pre>
</div>
<div title="Contact" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Context" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Daily" modifier="YourName" created="200805221358" modified="200805221358" tags="TicklerRepeatType">
<pre>order:1
button:none
buttonLong:daily
</pre>
</div>
<div title="DashboardSelector" modifier="YourName" created="200805221358" modified="200805221358" tags="excludeSearch">
<pre>&lt;div macro=&quot;showWhenTagged 'Project'&quot;&gt;[[TagDashboards##Project]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Context'&quot;&gt;[[TagDashboards##Context]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Contact'&quot;&gt;[[TagDashboards##Contact]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Area'&quot;&gt;[[TagDashboards##Area]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Reference'&quot;&gt;[[TagDashboards##Reference]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Ticklers Requiring Action'&quot;&gt;[[TagDashboards##Ticklers Requiring Action]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Upcoming Ticklers '&quot;&gt;[[TagDashboards##Upcoming Ticklers ]]&lt;/div&gt;
</pre>
</div>
<div title="DatePicker" modifier="YourName" created="200804061125" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|''Name:''|DatePickerLibrary|
|''Description:''|DatePicker library for use with macros|
|''Author:''|Saq Imtiaz ( lewcid@gmail.com )|
|''Code Repository:''|http://svn.tiddlywiki.org/Trunk/contributors/SaqImtiaz/libraries/DatePicker.js|
|''Version:''|0.9|
|''Date:''|06/04/2007|
|''License:''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''~CoreVersion:''|2.3.0|
***/

// /%
//!BEGIN-PLUGIN-CODE
//{{{
function $id(n) {
	return document.getElementById(n);
}

DatePicker = {
	
	days : ['S','M','T','W','T','F','S'],
		
	cells : new Array(42),
	
	setup : function(){
		var cte = createTiddlyElement;
		var table = this.table = cte(null,&quot;table&quot;,&quot;datePickerTable&quot;);
		table.style.display = 'none';
        document.body.appendChild(table);
		var thead = cte(table,&quot;thead&quot;);
		var hRow = cte(thead,&quot;tr&quot;);
		hRow.onclick = stopEvent;
		cte(hRow,&quot;td&quot;,null,&quot;datePickerNav&quot;,&quot;&lt;&lt;&quot;).onclick = DatePicker.prevm;
		cte(hRow,&quot;td&quot;,&quot;datePickerMNS&quot;,null,null,{colSpan:&quot;5&quot;});
		cte(hRow,&quot;td&quot;,null,&quot;datePickerNav&quot;,&quot;&gt;&gt;&quot;,{align:&quot;right&quot;}).onclick=DatePicker.nextm; 
		
		var tbody = cte(table,&quot;tbody&quot;,&quot;datePickerTableBody&quot;);
		var dayRow = cte(tbody,&quot;tr&quot;,null,&quot;datePickerDaysHeader&quot;);
		
		for (var i=0; i&lt;this.days.length; i++){
			cte(dayRow,&quot;td&quot;,null,null,this.days[i]);
		}      
	},
	
	show : function(el,dateObj,cb) {
		var me = DatePicker;
		var now = me.now = new Date();
		if (!dateObj)
			dateObj = now;
		me.root = el;
		if (cb)
			me.root.datePickerCallback = cb;
		me.scc = { m : now.getMonth(), y : now.getFullYear(), d : now.getDate() };
				
		Popup.place(el,me.table,{x:0,y:1});

		
		var cur = [dateObj.getDate(),dateObj.getMonth()+1,dateObj.getFullYear()];

		me.cc = { m : cur[1]-1, y : cur[2] };
		me.sd = { m : cur[1]-1, y : cur[2], d : cur[0] };   
		me.fillCalendar(cur[0],me.scc.d,cur[1]-1,cur[2]);
	},
	
	fillCalendar : function(hd,today,cm,cy) {
		var me = DatePicker;
		
		var sd = me.now.getDate();
		var td = new Date(cy,cm,1)
		var cd = td.getDay();

		$id('datePickerMNS').innerHTML = td.formatString('MMM YYYY')
		
		var tbody = $id('datePickerTableBody');
		removeChildren(tbody);
		
		var days = (new Date(cy, cm+1, 0)).getDate();
		var day = 1;
		for (var j=1;j&lt;=6;j++) { //rows
			var row = createTiddlyElement(tbody,&quot;tr&quot;,null,&quot;datePickerDayRow&quot;);
			for (var t=1; t&lt;=7; t++) { //cells
				var d = 7 * (j-1) - (-t); //id key      
				if ( (d &gt;= (cd -(-1))) &amp;&amp; (d&lt;=cd-(-(days))) ) {
					var dip = ( ((d-cd &lt; sd) &amp;&amp; (cm == me.scc.m) &amp;&amp; (cy == me.scc.y)) || (cm &lt; me.scc.m &amp;&amp; cy == me.scc.y) || (cy &lt; me.scc.y) );
					var htd = ( (hd != '') &amp;&amp; (d-cd == hd) );
					var hToday = ( (today != '') &amp;&amp; (d-cd == today) &amp;&amp; cy == me.scc.y &amp;&amp; cm == me.scc.m );
					if (htd)
						_class = 'highlightedDate';                
					else if (dip)
						_class = 'oldDate';
					else if (hToday &amp;&amp; ! htd)
						_class = 'todayDate';
					else
						_class = 'defaultDate';
					var cell = createTiddlyElement(row,&quot;td&quot;,&quot;datePickerDay&quot;+d,_class,d-cd);
					cell.onmouseover = function(e){addClass(this,'tdover');};
					cell.onmouseout = function(e){removeClass(this,'tdover');};
					cell.onclick = me.selectDate;
					me.cells[d] = new Date(cy,cm,d-cd);
				}
				else {
					var cell = createTiddlyElement(row,&quot;td&quot;,&quot;datePickerDay&quot;+d,&quot;emptyDate&quot;);
				}
				day++;
			}
			if(day &gt; days + cd)
				break;
		} 
	},
	
	nextm : function() {
		var me = DatePicker;        
		me.cc.m += 1;
		if (me.cc.m &gt;= 12) {
			me.cc.m = 0;
			me.cc.y++;
		}
		me.fillCalendar(me.getDayStatus(me.cc.m,me.cc.y),me.scc.d,me.cc.m,me.cc.y);
		return false;
	},
	
	prevm : function() {
		var me = DatePicker;
		me.cc.m -= 1;
		if (me.cc.m &lt; 0) {
			me.cc.m = 11;
			me.cc.y--;
		}
		me.fillCalendar(me.getDayStatus(me.cc.m,me.cc.y),me.scc.d,me.cc.m,me.cc.y);
		return false;
	},
	
	getDayStatus : function(ccm,ccy){
		return (ccy == this.sd.y &amp;&amp; ccm == this.sd.m)? this.sd.d : '';
	},
	
	selectDate : function(ev){
		var e = ev ? ev : window.event;
		var me = DatePicker;
		var date = me.cells[resolveTarget(e).id.substring(13,resolveTarget(e).id.length)];
		if (me.root.datePickerCallback &amp;&amp; typeof me.root.datePickerCallback == 'function')
			me.root.datePickerCallback(me.root,date);
		$id('datePickerTable').style.display = 'none';
		return false;
	},
	
	onclick : function(ev){
		$id(&quot;datePickerTable&quot;).style.display = 'none';
		return false;
	},
	
	create : function(el,dateObj,cb){
		el.onclick = el.onfocus = function(e){DatePicker.show(el,dateObj,cb);stopEvent(e)};
	},
	
	css: &quot;table#datePickerTable td.datePickerNav {\n&quot;+
		&quot;    cursor:pointer;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;.datePickerDaysHeader td {\n&quot;+
		&quot;    text-align:center;\n&quot;+
		&quot;    background:#ABABAB;\n&quot;+
		&quot;    font:12px Arial;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;.datePickerDayRow td {\n&quot;+
		&quot;    width:18px;\n&quot;+
		&quot;    height:18px;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;td#datePickerMNS, td.datePickerNav {\n&quot;+
		&quot;    font:bold 13px Arial;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;table#datePickerTable {\n&quot;+
		&quot;    position:absolute;\n&quot;+
		&quot;    border-collapse:collapse;\n&quot;+
		&quot;    background:#FFFFFF;\n&quot;+
		&quot;    border:1px solid #ABABAB;\n&quot;+
		&quot;    display:none;   \n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;table#datePickerTable td{\n&quot;+
		&quot;    padding: 3px;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;td#datePickerMNS {\n&quot;+
		&quot;    text-align: center;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;tr.datePickerDayRow td {\n&quot;+
		&quot;    background-color : #C4D3EA;\n&quot;+
		&quot;    cursor : pointer;\n&quot;+
		&quot;    border : 1px solid #6487AE;\n&quot;+
		&quot;    text-align : center;\n&quot;+
		&quot;	font : 10px Arial;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;tr.datePickerDayRow td.defaultDate {\n&quot;+
		&quot;	color : #333333;	\n&quot;+
		&quot;	text-decoration : none;   \n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;tr.datePickerDayRow td.emptyDate {\n&quot;+
		&quot;    cursor:default; \n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;tr.datePickerDayRow td.oldDate {\n&quot;+
		&quot;	color : #ABABAB;\n&quot;+
		&quot;    text-decoration : line-through;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;tr.datePickerDayRow td.highlightedDate {\n&quot;+
		&quot;    background : #FFF799;\n&quot;+
		&quot;	font-weight : bold;\n&quot;+
		&quot;	color : #333333;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;tr.datePickerDayRow td.todayDate {\n&quot;+
		&quot;	font-weight : bold;\n&quot;+
		&quot;	color : red;\n&quot;+
		&quot;}\n&quot;+
		&quot;\n&quot;+
		&quot;table#datePickerTable tr.datePickerDayRow td.tdover {\n&quot;+
		&quot;    background:#fc6;\n&quot;+
		&quot;}&quot;,
	
	init : function(){
		this.setup();
		addEvent(document,'click',DatePicker.onclick);
		config.shadowTiddlers['StyleSheetDatePicker'] = this.css;
		if(store)
			store.addNotification('StyleSheetDatePicker',refreshStyles);
	}
};

DatePicker.init();
//}}}
//!END-PLUGIN-CODE
// %/</pre>
</div>
<div title="DefaultTiddlers" modifier="YourName" created="200803251554" modified="200805261158" tags="excludeSearch" changecount="1">
<pre>[[Index page]]
</pre>
</div>
<div title="Delegated Tasks Dashboard" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols2{

{{col{

&lt;&lt;mgtdList
	title:'Delegated/Waiting For'
	startTag:Action
	tags:'[(Waiting For)] &amp;&amp; !Done'
	view:ActionProj
	mode:global
	where:tiddler.getByIndex(&quot;Contact&quot;).length &gt; 0'
	group:Contact
	gView:bold
	newButtonTags:'Action &amp;&amp; [(Waiting For)]'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Done' startTag:Action tags:'Done &amp;&amp; [(Waiting For)]' view:DoneAction mode:global
	where:tiddler.getByIndex('Contact').length&gt;0
	group:Contact
	gView:bold
	newButtonTags:'Action &amp;&amp; Done &amp;&amp; [(Waiting For)]'
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="DeleteAllTagged" modifier="YourName" created="200805062211" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name|DeleteAllTaggedPlugin|
|Based on|http://ido-xp.tiddlyspot.com/#DeleteAllTaggedPlugin|
|Version|MGTD Hacked|

An adaptation of DeleteDoneTasks (Simon Baird) by Ido Magal
To use this insert {{{&lt;&lt;deleteAllTagged&gt;&gt;}}} into the desired tiddler.

Modified quite a bit by Simon for MonkeyGTD
Now only works with MgtdIndexedTags...

Example usage:
{{{&lt;&lt;deleteAllTagged&gt;&gt;}}}
&lt;&lt;deleteAllTagged&gt;&gt;
***/
//{{{

config.macros.deleteAllTagged = {
	handler: function ( place,macroName,params,wikifier,paramString,tiddler ) {
		var buttonTitle = params[0] ? params[0] : &quot;Delete tiddlers tagged '&quot;+tiddler.title+&quot;'&quot;; // simon's tweak
		var tagToDelete = params[1] ? params[1] : tiddler.title;
		var alsoDeleteThisTiddler = params[2] ? params[2] : &quot;&quot;;
		var tagExpr = params[3] ? params[3] : tagToDelete;
		var whereExpr = params[4] ? params[4] : &quot;true&quot;;
		createTiddlyButton( place, buttonTitle, &quot;Delete every tiddler tagged with '&quot;+tiddler.title+&quot;'&quot;,
			this.deleteAllTagged( tagToDelete, alsoDeleteThisTiddler == &quot;delete&quot;, tagExpr, whereExpr ));
	},

	deleteAllTagged: function(tag,deleteMe,tagExpr,whereExpr) {
		return function() {
			var collected = fastTagged(tag).filterByTagExpr('[['+tagExpr+']]').filterByEval(whereExpr).toTitleList();
			if (collected.length == 0) {
				alert( &quot;None found.&quot; );
			}
			else {
				if (confirm( &quot;Found these tiddlers:\n'&quot;
						+ collected.join( &quot;', '&quot; ) + &quot;'\n\n\n&quot;
						+ &quot;Are you sure you want to delete these?&quot; )) {
					store.suspendNotifications();
					for ( var i=0;i&lt;collected.length;i++ ) {
						store.removeTiddler( collected[i] );
						story.closeTiddler( collected[i], true );
						displayMessage( &quot;Deleted '&quot;+collected[i]+&quot;'&quot; );
					}
					store.resumeNotifications();
				}
			}
			if (deleteMe) {
				if (confirm(&quot;Also delete this tiddler, '&quot;+tag+&quot;'?&quot;)) {
					store.removeTiddler( tag );
					story.closeTiddler( tag, true );
					displayMessage( &quot;Deleted '&quot;+tag+&quot;'&quot; );
				}
			}
		}
	}
};

//}}}

</pre>
</div>
<div title="DoWorkMenu" modifier="YourName" created="200805210959" modified="200805261156" tags="excludeSearch" changecount="8">
<pre>[[Index page]]
----
[[Starred Items]]
[[Reference Items]]
[[Tickler Dashboard]]
----
&lt;slider+ Contexts&gt;
&lt;&lt;mgtdList startTag:Action tags:'Next &amp;&amp; !Done' groupCountOnly:yes group:Context gView:plain where:tiddler.hasActiveProject()&gt;&gt;
&lt;/slider&gt;

/%&quot;&quot;&quot;
[[Next Actions|Next Actions by Context]]
[[Starred Next Actions|Starred Next Actions]]
[[Next and Waiting Actions|Next and Waiting Actions by Context]]
[[Action Dashboard|Action Dashboard by Context]]
[[Delegated Tasks Dashboard]]
[[Done Actions]]

&lt;slider Grouped by Project&gt;
[[Next Actions|Next Actions by Project]]
[[Next and Waiting Actions|Next and Waiting Actions by Project]]
[[Action Dashboard|Action Dashboard by Project]]
&lt;/slider&gt;
&lt;slider Ungrouped&gt;
[[Next Actions]]
[[Next and Waiting Actions]]
[[Action Dashboard]]
&lt;/slider&gt;
&lt;slider All contexts&gt;
&lt;&lt;mgtdList startTag:Context&gt;&gt;
&lt;/slider&gt;
&quot;&quot;&quot;%/

/%&quot;&quot;&quot;
[[Projects Dashboard]]
[[Projects Dashboard by Area]]
[[Action Dashboard by Project]]
[[Active Projects With No Next Action]]
[[Delegated Tasks Dashboard]]
[[Cleanup]]
[[Mismatched Realms]]
[[Subprojects]]

&lt;slider+ Areas&gt;
&lt;&lt;mgtdList startTag:Project tags:'Active &amp;&amp; !Complete' groupCountOnly:yes group:Area gView:plain&gt;&gt;
&lt;/slider&gt;
&lt;slider All areas&gt;
&lt;&lt;mgtdList startTag:Area&gt;&gt;
&lt;/slider&gt;
&quot;&quot;&quot;%/</pre>
</div>
<div title="Done Actions" modifier="YourName" created="200805091459" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList
	title:'Done'
	mode:global
	startTag:Action
	tags:'Done'
	view:DoneAction
	group:day
	gView:DoneAction
	gSort:-title
	newButtonTags:'Action Next Done'
	sort:-modified
	&gt;&gt;
</pre>
</div>
<div title="ExtendTagButtonPlugin" modifier="MPTW" created="200803080053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|ExtentTagButtonPlugin|
|Description:|Adds a New tiddler button in the tag drop down|
|Version:|3.2 ($Rev: 3861 $)|
|Date:|$Date: 2008-03-08 10:53:09 +1000 (Sat, 08 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#ExtendTagButtonPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License|http://mptw.tiddlyspot.com/#TheBSDLicense|
***/
//{{{

window.onClickTag_mptw_orig = window.onClickTag;
window.onClickTag = function(e) {
	window.onClickTag_mptw_orig.apply(this,arguments);
	var tag = this.getAttribute(&quot;tag&quot;);
	var title = this.getAttribute(&quot;tiddler&quot;);
	// Thanks Saq, you're a genius :)
	var popup = Popup.stack[Popup.stack.length-1].popup;
	createTiddlyElement(createTiddlyElement(popup,&quot;li&quot;,null,&quot;listBreak&quot;),&quot;div&quot;);
	wikify(&quot;&lt;&lt;newTiddler label:'New tiddler' tag:'&quot;+tag+&quot;'&gt;&gt;&quot;,createTiddlyElement(popup,&quot;li&quot;));
	return false;
}

//}}}

</pre>
</div>
<div title="Future" modifier="YourName" created="200805221358" modified="200805221358" tags="ActionStatus">
<pre>order:3
button:f
buttonLong:future
</pre>
</div>
<div title="HideWhenPlugin" modifier="MPTW" created="200803121603" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|HideWhenPlugin|
|Description:|Allows conditional inclusion/exclusion in templates|
|Version:|3.1 ($Rev: 3919 $)|
|Date:|$Date: 2008-03-13 02:03:12 +1000 (Thu, 13 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#HideWhenPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
For use in ViewTemplate and EditTemplate. Example usage:
{{{&lt;div macro=&quot;showWhenTagged Task&quot;&gt;[[TaskToolbar]]&lt;/div&gt;}}}
{{{&lt;div macro=&quot;showWhen tiddler.modifier == 'BartSimpson'&quot;&gt;&lt;img src=&quot;bart.gif&quot;/&gt;&lt;/div&gt;}}}
***/
//{{{

window.hideWhenLastTest = false;

window.removeElementWhen = function(test,place) {
	window.hideWhenLastTest = test;
	if (test) {
		removeChildren(place);
		place.parentNode.removeChild(place);
	}
};


merge(config.macros,{

	hideWhen: { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( eval(paramString), place);
	}},

	showWhen: { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( !eval(paramString), place);
	}},

	hideWhenTagged: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( tiddler.tags.containsAll(params), place);
	}},

	showWhenTagged: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( !tiddler.tags.containsAll(params), place);
	}},

	hideWhenTaggedAny: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( tiddler.tags.containsAny(params), place);
	}},

	showWhenTaggedAny: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( !tiddler.tags.containsAny(params), place);
	}},

	hideWhenTaggedAll: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( tiddler.tags.containsAll(params), place);
	}},

	showWhenTaggedAll: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( !tiddler.tags.containsAll(params), place);
	}},

	hideWhenExists: { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( store.tiddlerExists(params[0]) || store.isShadowTiddler(params[0]), place);
	}},

	showWhenExists: { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( !(store.tiddlerExists(params[0]) || store.isShadowTiddler(params[0])), place);
	}},

	hideWhenTitleIs: { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( tiddler.title == params[0], place);
	}},

	showWhenTitleIs: { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( tiddler.title != params[0], place);
	}},

	'else': { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		removeElementWhen( !window.hideWhenLastTest, place);
	}}

});

//}}}

</pre>
</div>
<div title="Index page" modifier="YourName" created="200805261153" modified="200901060946" changecount="10">
<pre>[[WK-баги-1]]
[[WK-идеи-1]]
[[WС-идеи-1]]
[[WN-идеи-1]]
----
[[Копилка]]
</pre>
</div>
<div title="InstantTimestampPlugin" modifier="MPTW" created="200803240239" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|InstantTimestampPlugin|
|Description:|A handy way to insert timestamps in your tiddler content|
|Version:|1.0.10 ($Rev: 3646 $)|
|Date:|$Date: 2008-02-27 02:34:38 +1000 (Wed, 27 Feb 2008) $|
|Source:|http://mptw.tiddlyspot.com/#InstantTimestampPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
!!Usage
If you enter {ts} in your tiddler content (without the spaces) it will be replaced with a timestamp when you save the tiddler. Full list of formats:
* {ts} or {t} -&gt; timestamp
* {ds} or {d} -&gt; datestamp
* !ts or !t at start of line -&gt; !!timestamp
* !ds or !d at start of line -&gt; !!datestamp
(I added the extra ! since that's how I like it. Remove it from translations below if required)
!!Notes
* Change the timeFormat and dateFormat below to suit your preference.
* See also http://mptw2.tiddlyspot.com/#AutoCorrectPlugin
* You could invent other translations and add them to the translations array below.
***/
//{{{

config.InstantTimestamp = {

	// adjust to suit
	timeFormat: 'DD/0MM/YY 0hh:0mm',
	dateFormat: 'DD/0MM/YY',

	translations: [
		[/^!ts?$/img,  &quot;'!!{{ts{'+now.formatString(config.InstantTimestamp.timeFormat)+'}}}'&quot;],
		[/^!ds?$/img,  &quot;'!!{{ds{'+now.formatString(config.InstantTimestamp.dateFormat)+'}}}'&quot;],

		// thanks Adapted Cat
		[/\{ts?\}(?!\}\})/ig,&quot;'{{ts{'+now.formatString(config.InstantTimestamp.timeFormat)+'}}}'&quot;],
		[/\{ds?\}(?!\}\})/ig,&quot;'{{ds{'+now.formatString(config.InstantTimestamp.dateFormat)+'}}}'&quot;]
		
	],

	excludeTags: [
		&quot;noAutoCorrect&quot;,
		&quot;noTimestamp&quot;,
		&quot;html&quot;,
		&quot;CSS&quot;,
		&quot;css&quot;,
		&quot;systemConfig&quot;,
		&quot;systemConfigDisabled&quot;,
		&quot;zsystemConfig&quot;,
		&quot;Plugins&quot;,
		&quot;Plugin&quot;,
		&quot;plugins&quot;,
		&quot;plugin&quot;,
		&quot;javascript&quot;,
		&quot;code&quot;,
		&quot;systemTheme&quot;,
		&quot;systemPalette&quot;
	],

	excludeTiddlers: [
		&quot;StyleSheet&quot;,
		&quot;StyleSheetLayout&quot;,
		&quot;StyleSheetColors&quot;,
		&quot;StyleSheetPrint&quot;
		// more?
	]

}; 

TiddlyWiki.prototype.saveTiddler_mptw_instanttimestamp = TiddlyWiki.prototype.saveTiddler;
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created) {

	tags = (typeof(tags) == &quot;string&quot;) ? tags.readBracketedList() : tags;
	var conf = config.InstantTimestamp;

	if ( !tags.containsAny(conf.excludeTags) &amp;&amp; !conf.excludeTiddlers.contains(newTitle) ) {

		var now = new Date();
		var trans = conf.translations;
		for (var i=0;i&lt;trans.length;i++) {
			newBody = newBody.replace(trans[i][0], eval(trans[i][1]));
		}
	}

	// TODO: use apply() instead of naming all args?
	return this.saveTiddler_mptw_instanttimestamp(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created);
}

// you can override these in StyleSheet 
setStylesheet(&quot;.ts,.ds { background-color:#ddd; font-style:italic; }&quot;,&quot;instantTimestampStyles&quot;);

//}}}

</pre>
</div>
<div title="LessBackupsPlugin" modifier="MPTW" created="200803240532" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|LessBackupsPlugin|
|Description:|Intelligently limit the number of backup files you create|
|Version:|3.0.1 ($Rev: 2320 $)|
|Date:|$Date: 2007-06-18 22:37:46 +1000 (Mon, 18 Jun 2007) $|
|Source:|http://mptw.tiddlyspot.com/#LessBackupsPlugin|
|Author:|Simon Baird|
|Email:|simon.baird@gmail.com|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
!!Description
You end up with just backup one per year, per month, per weekday, per hour, minute, and second.  So total number won't exceed about 200 or so. Can be reduced by commenting out the seconds/minutes/hours line from modes array
!!Notes
Works in IE and Firefox only.  Algorithm by Daniel Baird. IE specific code by by Saq Imtiaz.
***/
//{{{

var MINS  = 60 * 1000;
var HOURS = 60 * MINS;
var DAYS  = 24 * HOURS;

if (!config.lessBackups) {
	config.lessBackups = {
		// comment out the ones you don't want or set config.lessBackups.modes in your 'tweaks' plugin
		modes: [
			[&quot;YYYY&quot;,  365*DAYS], // one per year for ever
			[&quot;MMM&quot;,   31*DAYS],  // one per month
			[&quot;ddd&quot;,   7*DAYS],   // one per weekday
			//[&quot;d0DD&quot;,  1*DAYS],   // one per day of month
			[&quot;h0hh&quot;,  24*HOURS], // one per hour
			[&quot;m0mm&quot;,  1*HOURS],  // one per minute
			[&quot;s0ss&quot;,  1*MINS],   // one per second
			[&quot;latest&quot;,0]         // always keep last version. (leave this).
		]
	};
}

window.getSpecialBackupPath = function(backupPath) {

	var now = new Date();

	var modes = config.lessBackups.modes;

	for (var i=0;i&lt;modes.length;i++) {

		// the filename we will try
		var specialBackupPath = backupPath.replace(/(\.)([0-9]+\.[0-9]+)(\.html)$/,
				'$1'+now.formatString(modes[i][0]).toLowerCase()+'$3')

		// open the file
		try {
			if (config.browser.isIE) {
				var fsobject = new ActiveXObject(&quot;Scripting.FileSystemObject&quot;)
				var fileExists  = fsobject.FileExists(specialBackupPath);
				if (fileExists) {
					var fileObject = fsobject.GetFile(specialBackupPath);
					var modDate = new Date(fileObject.DateLastModified).valueOf();
				}
			}
			else {
				netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
				var file = Components.classes[&quot;@mozilla.org/file/local;1&quot;].createInstance(Components.interfaces.nsILocalFile);
				file.initWithPath(specialBackupPath);
				var fileExists = file.exists();
				if (fileExists) {
					var modDate = file.lastModifiedTime;
				}
			}
		}
		catch(e) {
			// give up
			return backupPath;
		}

		// expiry is used to tell if it's an 'old' one. Eg, if the month is June and there is a
		// June file on disk that's more than an month old then it must be stale so overwrite
		// note that &quot;latest&quot; should be always written because the expiration period is zero (see above)
		var expiry = new Date(modDate + modes[i][1]);
		if (!fileExists || now &gt; expiry)
			return specialBackupPath;
	}
}

// hijack the core function
window.getBackupPath_mptw_orig = window.getBackupPath;
window.getBackupPath = function(localPath) {
	return getSpecialBackupPath(getBackupPath_mptw_orig(localPath));
}

//}}}

</pre>
</div>
<div title="MGTDMoreTab" modifier="YourName" created="200804280922" modified="200805221358" tags="excludeSearch">
<pre>&lt;&lt;tabs txtMGTDMore
	&quot;Timeline&quot; &quot;Timeline&quot; TabTimeline
	&quot;MGTD&quot; &quot;Configuration Options&quot; ConfigMenu
	&quot;TW&quot; &quot;TiddlyWiki SideBar&quot; TWSideBar
	&gt;&gt;
</pre>
</div>
<div title="MGTDSidebar" modifier="YourName" created="200804271027" modified="200805261202" tags="excludeSearch" changecount="1">
<pre>&lt;&lt;tabs txtMGTDMain
	&quot;Work&quot; &quot;Do Work&quot; DoWorkMenu
	&quot;Process&quot; &quot;Process Inbox&quot; ProcessInboxMenu
	&quot;More...&quot; &quot;More...&quot; MGTDMoreTab
	&gt;&gt;
</pre>
</div>
<div title="MPTW" modifier="MPTW" created="200803080020" modified="200805101525" tags="excludeSearch">
<pre>MPTW is a distribution or edition of TiddlyWiki that includes a standard TiddlyWiki core packaged with some plugins designed to improve usability and provide a better way to organise your information. For more information see http://mptw.tiddlyspot.com/.
</pre>
</div>
<div title="MgtdAppFramework" modifier="YourName" created="200805210947" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>merge(Array.prototype,{

	each: function(func) {
		for (var i=0;i&lt;this.length;i++)
			func(this[i]);
	},

	// TODO, there is a map in the core now. Is it same as this or different?
	map: function(func) {
		var result = [];
		this.each(function(item) {
			result.push(func(item));
		});
		return result;
	},

	select: function(func) {
		var result = [];
		this.each(function(item) {
			if (func(item))
				result.push(item);
		});
		return result;
	},

	reject: function(func) {
		var result = [];
		this.each(function(item) {
			if (!func(item))
				result.push(item);
		});
		return result;
	}

});

//------------------------------------------

merge(String.prototype,{

	parseTagExpr: function(debug) {

		if (this.trim() == &quot;&quot;)
			return &quot;(true)&quot;;

		var logicOps = /(!|&amp;&amp;|\|\||\(|\))/g;

		var spaced = this.
 			// because square brackets in templates are no good
			// this means you can use [(With Spaces)] instead of [[With Spaces]]
			replace(/\[\(/g,&quot; [[&quot;).
			replace(/\)\]/g,&quot;]] &quot;). 
			// space things out so we can use readBracketedList. tricky eh?
			replace(logicOps,&quot; $1 &quot;);


		var expr = &quot;&quot;;

		var tokens = spaced.readBracketedList(false); // false means not unique. nice one JR!

		tokens.each(function(tok) {

			if (tok.match(logicOps)) {
				expr += tok;
			}
			else if (tok.match(/^parent:/)) {
				// experimental
				var lookForTagInParent = tok.split(&quot;:&quot;)[1];
				expr += &quot;tiddler.parents().anyHasTag('&quot;+lookForTagInParent+&quot;')&quot;;
			}					
			else {
				expr += &quot;tiddler.tags.contains('%0')&quot;.format([
						// fix single quote bug. hurrah
						// but still have nasty round bracket bug
						tok.replace(/'/,&quot;\\'&quot;)
					]);
			}
		});

		if (debug)
			alert(expr);

		return '('+expr+')';
	}

});

merge(Tiddler.prototype,{

	matchesEvalExpr: function(evalExpr) {
		var tiddler = this;
		return eval(evalExpr);
	},

	matchesTagExpr: function(tagExpr) {
		return this.matchesEvalExpr(tagExpr.parseTagExpr());
	},

	olderThanDays: function(days) {
		return this.modified.getTime() &lt; (new Date()).getTime() - days*1000*60*60*24;
	}

});

//------------------------------------

merge(Tiddler.prototype,{

	render: function(method,renderOptions) {
		var renderMethod = &quot;render_&quot;+method;
		if (this[renderMethod])
			return this[&quot;render_&quot;+method](renderOptions);
		else
			return &quot;*** cant render &quot;+renderMethod+&quot; ***&quot;;
	},

	renderUtil: function(formatString,formatValues) {
		return formatString.format(formatValues);
	},

	sorter: function(field) {
		var sortMethod = &quot;sort_&quot;+field;
		if (this[sortMethod])
			return this[sortMethod]();
		else
			return this[field];
	},

	sorterUtil: function(otherTiddler,method) {
		var desc = false;

		if (method.substring(0,1) == &quot;-&quot;) {
			desc = true;
			method = method.substring(1);
		}

		if (this.sorter(method) &gt; otherTiddler.sorter(method))
			return (desc ? -1 : +1);
		else if (this.sorter(method) &lt; otherTiddler.sorter(method))
			return (desc ? +1 : -1);
		else
			return 0;
	}

});

merge(String.prototype,{
	sorterUtil: function(otherTiddler,method) {

		var t1 = store.getTiddler(this);
		var t2 = store.getTiddler(otherTiddler);

		if (t1 &amp;&amp; t2)
			return t1.sorterUtil(t2,method);
		// this part is a little flakey but I'm aiming to
		// put the None heading last in all cases
		else if (t2)
			return +1;
		else if (t1)
			return -1;
		else
			return 0;
	}
});

//------------------------------------------

merge(Array.prototype,{

	// returns a hash
	groupBy_hash: function(func) {
		var result = {};
		var leftOverGroup = '__NONE__';
		this.each(function(item) {
			var groups = func(item);
			if (groups.length &gt; 0) {
				groups.each(function(group) {
					if (!result[group])
						result[group] = [];
					result[group].push(item);
				});
			}
			else {
				if (!result[leftOverGroup])
					result[leftOverGroup] = [];
				result[leftOverGroup].push(item);
			}
		});
		return result;
	},

	// returns an array of arrays, like Hash#sort in ruby
	groupBy: function(func,itemSort,groupSort) {

		if (!itemSort) itemSort = &quot;title&quot;;
		if (!groupSort) groupSort = &quot;-title&quot;;

		var result = this.groupBy_hash(func);
		var sortedResult = [];
		for (var g in result)
			sortedResult.push([g,result[g].sort(function(a,b){return a.sorterUtil(b,itemSort);})]);
		return sortedResult.sort(function(a,b){return a[0].sorterUtil(b[0],groupSort);});
	},

	// for convenience since it's mostly what we want
	groupByTag: function(tag,itemSort,groupSort) {
		return this.groupBy(function(t){return t.getByIndex(tag);},itemSort,groupSort);
 	}

});

//------------------------------------------

// for lists of tiddlers
merge(Array.prototype,{
	
	filterByEval: function(evalExpr) {
		return this.select(function(t) {
			return t.matchesEvalExpr(evalExpr);
		});
	},

	filterByTagExpr: function(tagExpr) {
		return this.filterByEval(tagExpr.parseTagExpr());
	},

	filterGroupsByEval: function(evalExpr) {
		// presumes the group name is a tiddler
		return this.select(function(tGroup) {
			var tiddler = store.getTiddler(tGroup[0]);
			return tiddler &amp;&amp; tiddler.matchesEvalExpr(evalExpr);
		});
	},

	filterGroupsByTagExpr: function(tagExpr) {
		return this.filterGroupsByEval(tagExpr.parseTagExpr());
	},

	render: function(renderMethod,renderOptions) {
		return this.map(function(tiddler){
			return tiddler.render(renderMethod,renderOptions);
		}).join(&quot;\n&quot;);
	},

	renderGrouped: function(listRenderMethod,headingRenderMethod,noneHeading,renderOptions,groupCountOnly,nbTags) {
		// do I ever use renderOptions??
		// this lost some elegance when I shoehorned the groupCountOnly part in. todo refactor
		// then lost some more with the nbTags addition...
		// might need some reworking
		var result = &quot;&quot;;
		this.each(function(g) {
			var groupName = g[0];
			var groupItems = g[1];

			var showCount = &quot;&quot;;
			if (groupCountOnly &amp;&amp; groupCountOnly != &quot;&quot;)
				showCount = groupItems.length &gt; 0 ? &quot; (&quot;+groupItems.length+&quot;)&quot; : &quot;&quot;;

			var makeHeading = (groupCountOnly&amp;&amp;groupCountOnly!=&quot;&quot;) ? &quot;&quot; : &quot;!!&quot;;
			var newButtonMarkup = &quot;&quot;;

			// this sucks
			if (nbTags &amp;&amp; nbTags != '') {
				newButtonMarkup = &quot; &quot;+config.macros.mgtdList.getNewButton(nbTags + &quot; [[&quot;+groupName+&quot;]]&quot;);
			}

			if (groupName == &quot;__NONE__&quot;) {
				result = result + makeHeading + &quot;{{noneHeading{[[(&quot;+(noneHeading?noneHeading:&quot;No &quot;+headingRenderMethod)+&quot;)]]}}}&quot;+showCount+&quot;\n&quot;;
			}
			else {
				var gTiddler = store.getTiddler(groupName);
				if (gTiddler) {
					result = result + makeHeading+gTiddler.render(headingRenderMethod)+showCount+newButtonMarkup+&quot;\n&quot;;
				}
				else {
					result = result + makeHeading+&quot;[[&quot;+groupName+&quot;]]&quot;+showCount+newButtonMarkup+&quot;\n&quot;;
				}
			}
			if (!groupCountOnly || groupCountOnly == &quot;&quot;)
				result = result + groupItems.render(listRenderMethod,renderOptions) + &quot;\n&quot;;
		});
			
		if (groupCountOnly &amp;&amp; groupCountOnly != &quot;&quot;)
			result = result.replace(/\n$/,''); // hack. remove trailing linefeed

		return result;
	},

	tiddlerSort: function(sortBy) {
		return this.sort(function(a,b) { return a.sorterUtil(b,sortBy); });
	},

	toTitleList: function() {
		return this.map(function(t){return t.title;});
	}


});

//------------------------------------------


</pre>
</div>
<div title="MgtdConf" modifier="YourName" created="200805180514" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>		
config.options.txtTheme = 'MonkeyGTDTheme';

if (!config.mGTD) config.mGTD = {};

config.mGTD.specialTags = [
		&quot;Action&quot;,
		&quot;Project&quot;,
		&quot;Area&quot;,
		&quot;Realm&quot;,
		&quot;Context&quot;,
		&quot;View&quot;,
        &quot;Tickler&quot;,
		&quot;Reference&quot;,
		&quot;Contact&quot;
]
config.mGTD.tagsToIndex = [
		&quot;Project&quot;,
		&quot;Area&quot;,
		&quot;Realm&quot;,
		&quot;Context&quot;,
		&quot;ActionStatus&quot;,
		&quot;TicklerStatus&quot;,
		&quot;ProjectStatus&quot;,
		&quot;GTDComponent&quot;,
		&quot;Sidebar&quot;,
		&quot;Contact&quot;,
        &quot;TicklerRepeatType&quot;
];

config.mgtdVersion = &quot;3.0 alpha r522235&quot;;

config.macros.mgtdVersion={handler:function(place){wikify(config.mgtdVersion,place);}};

config.toggleTagAlwaysTouchModDate = true; // see ToggleTagPlugin



config.shadowTiddlers.SiteTitle = 'Office villagers';
config.shadowTiddlers.SiteSubtitle = 'MonkeyGTD';

config.mGTD.getOptChk = function(option) { return store.fetchTiddler('MgtdSettings').tags.contains(option); }
config.mGTD.getOptTxt = function(fieldName) { return store.fetchTiddler('MgtdSettings').fields[fieldName.toLowerCase()]; }
config.mGTD.setOptTxt = function(fieldName,fieldValue) { store.fetchTiddler('MgtdSettings').fields[fieldName.toLowerCase()] = fieldValue; }

// from tiddlytools.com/#CoreTweaks, thanks Eric
window.coreWikify = wikify;
window.wikify = function(source,output,highlightRegExp,tiddler)
{
	if (source) arguments[0]=source.replace(/\\\\\n/mg,&quot;&lt;br&gt;&quot;);
	coreWikify.apply(this,arguments);
}

readOnly = false;
showBackstage = true;

</pre>
</div>
<div title="MgtdDateUtils" modifier="YourName" created="200805221354" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>merge(Date.prototype,{
	addDay:   function(n) { this.setDate(  this.getDate()      + n   ); },
	addWeek:  function(n) { this.setDate(  this.getDate()      + n*7 ); },
	addMonth: function(n) { this.setMonth( this.getMonth()     + n   ); },
	addYear:  function(n) { this.setYear(  this.getFullYear()  + n   ); }
});

// TODO. this doesn't really belong here
merge(Tiddler.prototype,{
	touch: function() {
		this.changed();
		this.modified = new Date();
		store.setDirty(true);
		store.notify(this.title,true);
	}
});

</pre>
</div>
<div title="MgtdEditField" modifier="YourName" created="200804271227" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>// it works in view mode, that's why we can't just use edit macro
merge(config.macros, {
	mgtdEditField: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			var fieldName = params[0];
			var useTiddler = tiddler;
			if (params[1])
				useTiddler = store.fetchTiddler(params[1]);
			var curVal = useTiddler.fields[fieldName] || '';
			var editBox = createTiddlyElement(place,'input',null,'editBox');            
			editBox.value = curVal;
			var callback = function(){
				useTiddler.fields[fieldName] = this.value;
				useTiddler.touch();	// see MgtdDateUtils
			}
			editBox.onchange = callback;
		}
	}
});
</pre>
</div>
<div title="MgtdHelp" modifier="YourName" created="200804191238" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>function wikifiedMessage(message) {
	wikify(message,getMessageDiv());
}

merge(config.macros,{

	help: {

		handler: function (place,macroName,params,wikifier,paramString,tiddler) {
			createTiddlyButton(place,&quot;?&quot;,&quot;help&quot;,function() {
				var useThis = params[0]?params[0]:tiddler.title;
				var helpContent = &quot;{{help{\n''~MonkeyGTD Help''\n!&quot;+useThis+&quot;\n&quot;+store.getTiddlerText(&quot;MonkeyGTDHelp##&quot;+useThis)+&quot;\n}}}\n&quot;;

				// doesn't work at all. I have no idea how to use TW popups apparently ...
				//var popup = Popup.create(place,&quot;div&quot;,&quot;popupTiddler&quot;);
				//wikify(helpContent,popup,null,tiddler);
				//Popup.show();

				// stick with this for now
				clearMessage();
				wikifiedMessage(&quot;{{help{\n''~MonkeyGTD Help''\n!&quot;+useThis+&quot;\n&quot;+store.getTiddlerText(&quot;MonkeyGTDHelp##&quot;+useThis)+&quot;\n}}}\n&quot;);

				return false;
			});
		}
	}

});

</pre>
</div>
<div title="MgtdIndexedTags" modifier="YourName" created="200805091505" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>config.indexedTags = {

	// will be populated with our tag lists
	tagLists: {},

	// will be populated with our tag indexes
	indexes: {},

	// will be populated with the tags that need indexing
	tagsToIndex: [],

	saveTiddlerHijack: function(title,newTitle,newBody,modifier,modified,tags,fields) {
		var before = store.getTiddler(title);
		var oldTags = before ? [].concat(before.tags) : null;  // concat so we get a dup

		store.suspendNotifications();
		var result = this.saveTiddler_orig_indexedTags(title,newTitle,newBody,modifier,modified,tags,fields);
		var newTags = store.getTiddler(newTitle).tags;

		config.indexedTags.updateTagLists(title,oldTags,newTitle,newTags);
		config.indexedTags.updateIndexes(title,newTitle,newTags);

		store.resumeNotifications();
		store.notify(title,true);

		return result;
	},

	removeTiddlerHijack: function(title) {
		var before = store.getTiddler(title);
		var oldTags = before ? [].concat(before.tags) : null;  // concat so we get a dup

		store.suspendNotifications();
		this.removeTiddler_orig_indexedTags(title);

		config.indexedTags.updateTagLists(title,oldTags);
		config.indexedTags.updateIndexes(title);

		store.resumeNotifications();
		store.notify(title,true);
	},

	setTiddlerTagHijack: function(title,status,tag) {
		var before = store.getTiddler(title);
		var oldTags = before ? [].concat(before.tags) : null;  // concat so we get a dup

		store.suspendNotifications();
		this.setTiddlerTag_orig_indexedTags(title,status,tag);

		var after = store.getTiddler(title);
		var newTags = after ? after.tags : null;

		config.indexedTags.updateTagLists(title,oldTags,title,newTags);
		config.indexedTags.updateIndexes(title,title,newTags);

		store.resumeNotifications();
		store.notify(title,true);

	},

	updateTagLists: function(title,oldTags,newTitle,newTags) {
		if (oldTags)
			oldTags.each(function(tagName) {
				config.indexedTags.tagLists[tagName].remove(title);
			});
		if (newTags)
			newTags.each(function(tagName) {
				if (!config.indexedTags.tagLists[tagName])
					config.indexedTags.tagLists[tagName] = [];
				config.indexedTags.tagLists[tagName].pushUnique(newTitle);
			});
	},

	updateIndexes: function(title,newTitle,newTags) {
		delete config.indexedTags.indexes[title];
		if (newTags) {
			config.indexedTags.indexes[newTitle] = {};
			config.indexedTags.tagsToIndex.each(function(tagToIndex) {
				config.indexedTags.indexes[newTitle][tagToIndex] = [];
				newTags.each(function(tag) {
					if (config.indexedTags.tagLists[tagToIndex] &amp;&amp; config.indexedTags.tagLists[tagToIndex].contains(tag)) {
						config.indexedTags.indexes[newTitle][tagToIndex].pushUnique(tag);
					}
				});
			});
		}
	},

	initTagLists: function() {
		store.getTags().map(function(pair) { return pair[0]; }).each(function(t) {
			config.indexedTags.tagLists[t] = store.getTaggedTiddlers(t).map(function(tt) { return tt.title; });
		});
	},

	initIndexes: function() {
		store.forEachTiddler(function(title,tiddler) {
			config.indexedTags.updateIndexes(title,title,tiddler.tags);
		});
	},

	dump: function() {
		alert(this.indexes[&quot;Buy petrol for mower&quot;][&quot;Project&quot;]);
		alert(this.indexes[&quot;Buy petrol for mower&quot;][&quot;Realm&quot;]);
	},

	tiddlerMethods: {
		getByIndex: function(tag) {
			return config.indexedTags.indexes[this.title][tag];
		},

		hasParent: function(tag) {
			return this.getByIndex(tag).length &gt; 0
		},

		hasNoParent: function(tag) {
			return !this.hasParent(tag);
		},

		hasActiveProject: function() {
			var projs = this.getByIndex(&quot;Project&quot;);

			if (projs.length == 0)
				// no project but we will say it's active
				// because otherwise it will not show up anywhere
				return true;

			for (var i=0;i&lt;projs.length;i++)
				if (
					(config.indexedTags.indexes[projs[i]]['ProjectStatus'].contains('Active'))
					&amp;&amp;
					!store.fetchTiddler(projs[i]).tags.contains('Complete') // seems stupid
					)
					return true;
			return false;
		},

		getAreasForAction: function() {
			// we will go to some trouble to permit actions in multiple areas
			// either explicitly or via their project...
			// also permit multiple projects......
			// explicit:
			var result = [];
			result = result.concat(this.getByIndex(&quot;Area&quot;));
			// implicit (via project/s):
			var projs = this.getByIndex(&quot;Project&quot;);
			for (var i=0;i&lt;projs.length;i++)
				result = result.concat(store.fetchTiddler(projs[i]).getByIndex(&quot;Area&quot;));
			return result;
		},

		hasNextAction: function() {
			var children = fastTagged(this.title).filterByTagExpr('Action &amp;&amp; !Done &amp;&amp; (Next || [(Waiting For)])');
			return children.length &gt; 0;
		},

		hasSubProject: function() {
			var children = fastTagged(this.title).filterByTagExpr('Project &amp;&amp; !Complete &amp;&amp; Active');
			return children.length &gt; 0;
		},

		hasNextActionOrSubProject: function() {
			return (this.hasSubProject() || this.hasNextAction());
		}
	},

	globalMethods: {
		fastTagged: function(tag) {
			var list = config.indexedTags.tagLists[tag];
			return (list?list:[]).map(function(t){return store.getTiddler(t);});
		}
	},

	init: function(tagsToIndex) {

		merge(window,this.globalMethods);
		merge(Tiddler.prototype,this.tiddlerMethods);

		this.tagsToIndex = tagsToIndex;
		this.initTagLists();
		this.initIndexes();

		TiddlyWiki.prototype.saveTiddler_orig_indexedTags = TiddlyWiki.prototype.saveTiddler;
		TiddlyWiki.prototype.removeTiddler_orig_indexedTags = TiddlyWiki.prototype.removeTiddler;
		TiddlyWiki.prototype.setTiddlerTag_orig_indexedTags = TiddlyWiki.prototype.setTiddlerTag;
		TiddlyWiki.prototype.saveTiddler = this.saveTiddlerHijack;
		TiddlyWiki.prototype.removeTiddler = this.removeTiddlerHijack;
		TiddlyWiki.prototype.setTiddlerTag = this.setTiddlerTagHijack;

	}
};

config.indexedTags.init(config.mGTD.tagsToIndex);
</pre>
</div>
<div title="MgtdList" modifier="YourName" created="200805211435" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>merge(config.macros,{

	ticklerAlert: {
		handler: function (place,macroName,params,wikifier,paramString,tiddler) {
			var realmFilter = '';
			if (!config.mGTD.getOptChk('AlertsIgnoreRealm'))
				realmFilter = ' &amp;&amp; tiddler.tags.containsAny(config.macros.mgtdList.getActiveRealms())';
			var theList = fastTagged('Tickler').
						filterByTagExpr('!Actioned').
								filterByEval('tiddler.fields.mgtd_date &lt;= (new Date()).convertToYYYYMMDDHHMM()'+realmFilter);
			if (theList.length &gt; 0) {
				var blinker = createTiddlyElement(place,'blink');
				wikify('{{ticklerAlert{[[*ticklers*|Ticklers Requiring Action]]}}}',blinker,null,tiddler);
			}
		}
	},
	mgtdList: {

		getActiveRealms: function() {
			return store.fetchTiddler(&quot;MgtdSettings&quot;).getByIndex(&quot;Realm&quot;);
		},

		noActiveRealmMessage: function() {
			// this doesn't work like it ought to?????
			if (this.getActiveRealms().length == 0) {
				//clearMessage();
				displayMessage(&quot;Error: No active realms. Please activate at least one realm.&quot;); 
			}
		},
		
		getRealm: function(tiddlerTitle) {

			// if we're in a project inherit the realm from the project
			var inTiddler = store.fetchTiddler(tiddlerTitle);
			if (inTiddler &amp;&amp; inTiddler.tags.contains('Project')) {
				// get the realm from the project
				return inTiddler.getByIndex('Realm');
			}	

			// otherwise use the active realm 
			var active = config.macros.mgtdList.getActiveRealms();

			if (active.length == 1) {
				return active[0];
			}
			else if (active.length == 0) {
				var fudge = fastTagged('Realm')[0].title;	 // this is a little bit random but they should be seeing the warning by now and fixing it
				return fudge;
			}
			else {
				// if there's more than one active realm use a slice to get the realm priority and choose the highest one
				// TODO, make this prettier
				var toBeat = &quot;zzzzzzz&quot;;
				var soFar = active[0];
				for (var i=0;i&lt;active.length;i++) {
					var pri = store.getTiddlerSlice(active[i],&quot;priority&quot;);
					if (pri &amp;&amp; pri &lt; toBeat) {
						toBeat = pri;
						soFar = active[i];
					}
				}
				return soFar;
			}
		},

		getNewButton: function(tags,extraTags) {
			if (typeof tags != 'string')
				tags = String.encodeTiddlyLinkList(tags);
			return '&lt;&lt;newSavedTiddler label:+ tag:&quot;'+tags+'&quot;&gt;&gt;'; // newSavedTiddler wants tags in one param?
		},

		handler: function (place,macroName,params,wikifier,paramString,tiddler) {

			this.noActiveRealmMessage();

			var pp = paramString.parseParams(&quot;tags&quot;,null,true);

			// title of the list
			var title = getParam(pp,&quot;title&quot;,&quot;&quot;);

			// local means only look at tiddlers tagged with this tiddler
			// global means look at every tiddler
			var tagMode = getParam(pp,&quot;mode&quot;,&quot;local&quot;);

			// optional. ignored unless mode global. specify for speed gains
			var startTag = getParam(pp,&quot;startTag&quot;);

			// eg, &quot;Next &amp;&amp; !Done&quot;
			var tagExpr = getParam(pp,&quot;tags&quot;,&quot;&quot;);

			// additional filter. gets eval'ed
			var whereExpr = getParam(pp,&quot;where&quot;,&quot;&quot;);

			// group by another tag
			var groupBy = getParam(pp,&quot;group&quot;,&quot;&quot;);

			// group by count only mode
			var groupCountOnly = getParam(pp,&quot;groupCountOnly&quot;,&quot;&quot;);

			// filter the groups by tag expr
			var gTagExpr = getParam(pp,&quot;gTag&quot;,&quot;&quot;);

			// or eval'ed expression
			var gWhereExpr = getParam(pp,&quot;gWhere&quot;,&quot;&quot;);

			// how to render list items
			var viewType = getParam(pp,&quot;view&quot;,&quot;plain&quot;);

			// how to render headings
			var gViewType = getParam(pp,&quot;gView&quot;,groupBy);

			// if there are tiddlers who aren't grouped then give them this title
			// mainly used to label future actions...
			var leftoverTitle = getParam(pp,&quot;leftoverTitle&quot;,&quot;No &quot;+groupBy);

			// if set to &quot;yes&quot; then we ignore the realm and show everthing
			var ignoreRealm = getParam(pp, &quot;ignoreRealm&quot;,&quot;&quot;);

			// sort items
			var sortBy = getParam(pp,&quot;sort&quot;,&quot;title&quot;);

			// sort groups
			var gSortBy = getParam(pp,&quot;gSort&quot;,&quot;title&quot;);

			// new button
			var newButton = getParam(pp,&quot;newButton&quot;,&quot;&quot;); // not using 
			var newButtonTags = getParam(pp,&quot;newButtonTags&quot;,&quot;&quot;);

			// don't show empty list
			var dontShowEmpty = getParam(pp,&quot;dontShowEmpty&quot;,&quot;&quot;);

			newButtonTags = newButtonTags.replace(/\[\(/g,&quot; [[&quot;).replace(/\)\]/g,&quot;]] &quot;); // change [(..)] to [[..]]

			if (!startTag)
				if (tagMode != &quot;global&quot;)
					startTag = tiddler.title;

			var listRefreshContainer = createTiddlyElement(place,&quot;div&quot;);

			// TODO one big attribute?
			listRefreshContainer.setAttribute(&quot;refresh&quot;,&quot;macro&quot;);
			listRefreshContainer.setAttribute(&quot;macroName&quot;,macroName);

			listRefreshContainer.setAttribute(&quot;title&quot;,title);
			listRefreshContainer.setAttribute(&quot;startTag&quot;,startTag);
			listRefreshContainer.setAttribute(&quot;tagMode&quot;,tagMode);
			listRefreshContainer.setAttribute(&quot;tagExpr&quot;,tagExpr);
			listRefreshContainer.setAttribute(&quot;groupBy&quot;,groupBy);
			listRefreshContainer.setAttribute(&quot;groupCountOnly&quot;,groupCountOnly);
			listRefreshContainer.setAttribute(&quot;gTagExpr&quot;,gTagExpr);
			listRefreshContainer.setAttribute(&quot;whereExpr&quot;,whereExpr);
			listRefreshContainer.setAttribute(&quot;gWhereExpr&quot;,gWhereExpr);
			listRefreshContainer.setAttribute(&quot;sortBy&quot;,sortBy);
			listRefreshContainer.setAttribute(&quot;gSortBy&quot;,gSortBy);
			listRefreshContainer.setAttribute(&quot;viewType&quot;,viewType);
			listRefreshContainer.setAttribute(&quot;gViewType&quot;,gViewType);
			listRefreshContainer.setAttribute(&quot;ignoreRealm&quot;,ignoreRealm);
			listRefreshContainer.setAttribute(&quot;leftoverTitle&quot;,leftoverTitle);
			listRefreshContainer.setAttribute(&quot;newButton&quot;,newButton);
			listRefreshContainer.setAttribute(&quot;newButtonTags&quot;,newButtonTags);
			if (tiddler)
				listRefreshContainer.setAttribute(&quot;tiddlerTitle&quot;,tiddler.title);
			listRefreshContainer.setAttribute(&quot;dontShowEmpty&quot;,dontShowEmpty);

			this.refresh(listRefreshContainer);
		},

		refresh: function(place) {

			removeChildren(place);

			var title = place.getAttribute(&quot;title&quot;);
			var startTag = place.getAttribute(&quot;startTag&quot;);
			var tagMode = place.getAttribute(&quot;tagMode&quot;);
			var tagExpr = place.getAttribute(&quot;tagExpr&quot;);
			var groupBy = place.getAttribute(&quot;groupBy&quot;);
			var groupCountOnly = place.getAttribute(&quot;groupCountOnly&quot;);
			var gTagExpr = place.getAttribute(&quot;gTagExpr&quot;);
			var whereExpr = place.getAttribute(&quot;whereExpr&quot;);
			var gWhereExpr = place.getAttribute(&quot;gWhereExpr&quot;);
			var sortBy = place.getAttribute(&quot;sortBy&quot;);
			var gSortBy = place.getAttribute(&quot;gSortBy&quot;);
			var viewType = place.getAttribute(&quot;viewType&quot;);
			var gViewType = place.getAttribute(&quot;gViewType&quot;);
			var ignoreRealm = place.getAttribute(&quot;ignoreRealm&quot;);
			var leftoverTitle = place.getAttribute(&quot;leftoverTitle&quot;);
			var newButton = place.getAttribute(&quot;newButton&quot;);
			var newButtonTags = place.getAttribute(&quot;newButtonTags&quot;);
			var tiddlerTitle = place.getAttribute(&quot;tiddlerTitle&quot;);
			var dontShowEmpty = place.getAttribute(&quot;dontShowEmpty&quot;);

			var wikifyThis = &quot;&quot;;

			wikifyThis += &quot;{{mgtdList{\n&quot;;

            if (title != &quot;&quot;)
			    wikifyThis += &quot;!&quot;+title

			var nbTags;
			if (newButtonTags != '') {
				nbTags = [
						newButtonTags,                                  // the tags specified in the macro params
						'[['+config.macros.mgtdList.getRealm(tiddlerTitle)+']]',    // the realm. always want a realm
						(tagMode=='global'?'':'[['+tiddlerTitle+']]')   // if not global, then the add tiddler we're in, new here style
					].join(' ');


				var nbList = nbTags.readBracketedList();

				var nbExtra = nbTags;

				// also we want an area. another hack. darn you subprojects.. :)
				if (nbList.contains('Project') &amp;&amp; !nbList.containsAny(fastTagged('Area').toTitleList())) {
					var foo = store.fetchTiddler(tiddlerTitle).getByIndex('Area');
					if (foo.length &gt; 0) {
						nbExtra += ' [[' + foo[0] + ']]';
					}
				}

				if (nbList.contains('Project') &amp;&amp; !nbList.containsAny(fastTagged('ProjectStatus').toTitleList())) {
					// stupid hack for subprojects list in project dashboards
 					// don't want to create a project with no status
					// this is the hack:
					nbExtra += ' Active';
				}

				// same hack thing for actions
				if (nbList.contains('Action') &amp;&amp; !nbList.containsAny(fastTagged('ActionStatus').toTitleList())) {
					nbExtra += ' Next';
				}

				wikifyThis += this.getNewButton(nbExtra);
				// but still use nbTags later on in group headings...

			}


            if (title != &quot;&quot; || newButton != &quot;&quot;)
			    wikifyThis += &quot;\n&quot;;

			wikifyThis += &quot;{{innerList{\n&quot;;

			var checkForContent = wikifyThis;

			var theList = [];
			if (startTag &amp;&amp; startTag != 'undefined'/* this sucks */) {
				theList = fastTagged(startTag);
			}
			else {
				// why so hard to get an array of all tiddlers?
				store.forEachTiddler(function(t_title,t_tiddler) { theList.push(t_tiddler); });
			}


			if (tagExpr != &quot;&quot;) theList = theList.filterByTagExpr(tagExpr);
			if (whereExpr != &quot;&quot;) theList = theList.filterByEval(whereExpr);

			if (ignoreRealm != &quot;yes&quot;) {
				var activeRealms = config.macros.mgtdList.getActiveRealms();
				theList = theList.select(function(t) {
					var realm = t.getByIndex(&quot;Realm&quot;);
					return (
						realm.length == 0 ||  // so something with no realm shows up
						realm.containsAny(activeRealms)
					);
				});
			}

            if (groupBy == &quot;day&quot;) {
                // experimental. changing a tag doesn't update modified so
                // this isn't as useful
                theList = theList.groupBy(function(t){return [t.modified.formatString('YYYY-0MM-0DD')];});
				wikifyThis += theList.renderGrouped(viewType,gViewType,leftoverTitle);
            }
			else if (groupBy != &quot;&quot;) {
				theList = theList.groupByTag(groupBy,sortBy,gSortBy);
				if (gTagExpr != &quot;&quot;) theList = theList.filterGroupsByTagExpr(gTagExpr);
				if (gWhereExpr != &quot;&quot;) theList = theList.filterGroupsByEval(gWhereExpr);
				wikifyThis += theList.renderGrouped(viewType,gViewType,leftoverTitle,null,groupCountOnly,nbTags);
			}
			else {
				theList = theList.tiddlerSort(sortBy);
				wikifyThis += theList.render(viewType);
			}

			var emptyList = false;
			if (wikifyThis == checkForContent) {
				emptyList = true;
				wikifyThis += &quot;{{none{none}}}&quot;;
			}

			wikifyThis += &quot;}}}\n&quot;;
			wikifyThis += &quot;}}}\n&quot;;

			if (!(dontShowEmpty == &quot;yes&quot; &amp;&amp; emptyList))
				wikify(wikifyThis,place,null,tiddler);

			forceReflow(); // fixes rendering issues. (but probably doubles up rendering time??)

		}
	}

});

</pre>
</div>
<div title="MgtdProcessInbox" modifier="YourName" created="200805161346" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>merge(config.macros,{
	processInbox: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {

			var shortHand = {
				'W': 'Waiting For',
				'N': 'Next',
				'F': 'Future',
				'S': 'Starred'
			};

			wikify(&quot;Quick add projects and actions (See [[About Quick Add]] for more info):\n&quot;,place);
			var pi = createTiddlyElement(place,&quot;textarea&quot;,null,&quot;piBox&quot;);
			
			wikify(&quot;\n&quot;,place);

			var a1 = createTiddlyCheckbox(place,&quot;Open created projects&quot;,true,null);
			a1.id = 'piShowProjects';

			var a2 = createTiddlyCheckbox(place,&quot;Open created actions&quot;,true,null);
			a2.id = 'piShowActions';

			wikify(&quot;\n&quot;,place);

			var btn = createTiddlyButton(place,&quot;quick add now&quot;,&quot;create these items&quot;,function(e) {
				var lines = pi.value.split(&quot;\n&quot;);
				var currentProject = &quot;&quot;;
				var displayThese = [];

				for (var i=0;i&lt;lines.length;i++) {
					//alert(lines[i]);
					var fields = lines[i].split(/[|;]/);

					if (!fields[0] || fields[0].trim() == &quot;&quot;) {
						currentProject = &quot;&quot;;
					}
					else {

						var title = fields.shift();
						//alert(title);

						// add the realm
						fields.push(config.macros.mgtdList.getRealm());

						if (title[0] != '.') {
							//alert(&quot;project &quot;+title);
							currentProject = title;

							if (document.getElementById('piShowProjects').checked)
								displayThese.push(title);

							fields.push(&quot;Project&quot;); // make it a project
							fields.push(&quot;Active&quot;); // make it active
							if (store.tiddlerExists(title))
								alert(&quot;Warning: '&quot;+title+&quot;' already exists, did not create&quot;);
							else
								store.saveTiddler(
									title,title,
									&quot;&quot;, // content
									config.options.txtUserName,
									new Date(),
									fields, // tags
									null // extra fields
								);
						}
						else {

							// default to next actions
							if (!fields.containsAny(['N','F','W']))
								fields.push('N');

							fields = fields.map(function(f) {
								if (shortHand[f] &amp;&amp; shortHand[f] != '')
									return shortHand[f];
								else
									return f;
							});

							//alert(&quot;action &quot;+title);
							title = title.trim();
							title = title.replace(/^\.+/,'');

							if (document.getElementById('piShowActions').checked)
								displayThese.push(title);

							fields.push(&quot;GTD&quot;); // make it a GTD item
							fields.push(&quot;Action&quot;); // make it an action 
							if (currentProject.trim() != &quot;&quot;)
								fields.push(currentProject); // make it in this project

							if (store.tiddlerExists(title))
								alert(&quot;Warning: '&quot;+title+&quot; already exists, did not create&quot;);
							else
								store.saveTiddler(
									title,title,
									&quot;&quot;, // content
									config.options.txtUserName,
									new Date(),
									fields, // tags
									null // extra fields
								);
						}
					}
				}

				for (var ii=0;ii&lt;displayThese.length;ii++)
					story.displayTiddler(&quot;bottom&quot;,displayThese[ii]);

				alert(&quot;Done creating items&quot;);
				return false;
			}); // end of createTiddlyButton

		}
	}
});



</pre>
</div>
<div title="MgtdSettings" modifier="YourName" created="200805211343" modified="200805221358" tags="excludeSearch Personal AlertsIgnoreRealm MultipleContexts" newjournaldateformat="ddd DD-mmm-YY, 0hh:0mm" ticklerdateformat="ddd, DD-mmm-YY" changecount="1">
<pre>!!Options
Show tickler alerts regardless of realm settings.
&lt;&lt;toggleTag AlertsIgnoreRealm MgtdSettings&gt;&gt;

Actions can have multiple contexts. 
&lt;&lt;toggleTag MultipleContexts MgtdSettings&gt;&gt;

Show full project name next to actions in action lists instead of just [P].
&lt;&lt;toggleTag FullProjectInActionLists MgtdSettings&gt;&gt;

Show full contact name next to actions in action lists instead of just [C].
&lt;&lt;toggleTag FullContactInActionLists MgtdSettings&gt;&gt;

Enter the date format for ticklers.
Tickler date format:&lt;&lt;mgtdEditField ticklerdateformat MgtdSettings&gt;&gt;
(see [[Date Formats|http://tiddlywiki.org/wiki/Date_Formats]]) 

Enter the date format for 'new journal'.
Tickler date format:&lt;&lt;mgtdEditField newjournaldateformat MgtdSettings&gt;&gt;
(see [[Date Formats|http://tiddlywiki.org/wiki/Date_Formats]]) 

</pre>
</div>
<div title="MgtdTagControls" modifier="YourName" created="200805211214" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>// requires MgtdIndexedTags for the fastTagged and getByIndex methods
// TODO make these usable without MgtdIndexedTags if it doesn't exist

merge(Tiddler.prototype,{


	addTag: function(tag) {
		store.setTiddlerTag(this.title,true,tag);
	},

	removeTag: function(tag) {
		store.setTiddlerTag(this.title,false,tag);
	},

	setTagFromGroup: function(tagGroup,tag) {
		var tagList = fastTagged(tagGroup);

		// it goes slow if you don't do this
		store.suspendNotifications();

		// remove all the tags in the group
		for (var i=0;i&lt;tagList.length;i++)
			this.removeTag(tagList[i].title);

		// add the one selected
		if (tag)
			this.addTag(tag);

		// touch the modified date so we can sort usefully
		this.modified = new Date();

		// resume notification and notify
		store.resumeNotifications();
		store.notify(this.title,true);
	},

	toggleTag: function(tag) {
		store.setTiddlerTag(this.title,!this.hasTag(tag),tag);
		// touch the modified date
		this.modified = new Date();
	},

	hasTag: function(tag) {
		return this.tags.contains(tag);
	},

	getParent: function(tag) {
		return this.getByIndex(tag);
	},

	realmMismatchWithParent: function(tag) {
		var myRealm = this.getParent('Realm')[0];

		if (!myRealm)
			return true; // no realm, should be fixed..

		var myParent = this.getParent(tag)[0];
		if (!myParent)
			return false; // nothing to be mismatched with

		var parentTiddler = store.fetchTiddler(this.getParent(tag)[0]);
		if (!parentTiddler)
			return true; // doubt it would ever happen but...

		parentRealm = parentTiddler.getParent('Realm')[0]; // we assume one realm only...
		if (!parentRealm)
			return true;

		return parentRealm != myRealm;
	}

});

merge(config.macros,{
	
	singleToggleTag: {

		handler: function(place,macroName,params,wikifier,paramString,tiddler) {

			var pp = paramString.parseParams(&quot;tag&quot;,null,true);
			
			if (!tiddler)
				tiddler = store.getTiddler(getParam(pp,&quot;title&quot;));
			
			var tag = getParam(pp,&quot;tag&quot;);
			var t = store.fetchTiddler(tag);

			var title = getParam(pp,&quot;title&quot;,tiddler.title);


			var actOnTiddler = store.getTiddler(title);

			var label = store.getTiddlerSlice(t.title,&quot;button&quot;);
			var labelOff = store.getTiddlerSlice(t.title,&quot;buttonOff&quot;);

			// dreadful hack
			if (tag == &quot;Starred&quot;)
				label = &quot;\u2605&quot;;

			var autoClass = &quot;button &quot; + t.title.replace(/[\/ ]/g,'') 

			if (!label) label = t.title;
			if (!labelOff) labelOff = label;


			var curState = actOnTiddler.hasTag(tag);

			var cl = createTiddlyButton(place, curState?label:labelOff, t.title, function(e) {
					actOnTiddler.toggleTag(tag);
					return false;
				},
				autoClass + &quot; &quot; + (curState ? &quot;on&quot; : &quot;off&quot;)
				);
		}
		
	},

	groupOfSingleToggleTags: {

		handler: function(place,macroName,params,wikifier,paramString,tiddler) {

			var pp = paramString.parseParams(&quot;tag&quot;,null,true);

			var useCheckbox = getParam(pp,&quot;useCheckbox&quot;,&quot;&quot;);
			
			if (!tiddler)
				tiddler = store.getTiddler(getParam(pp,&quot;title&quot;));
			
			var tag = getParam(pp,&quot;tag&quot;);

			var title = getParam(pp,&quot;title&quot;,tiddler.title);
			var refresh = getParam(pp,&quot;refresh&quot;); // stupid bit for pagetemplate hack

			var actOnTiddler = store.getTiddler(title);

			var getValues = fastTagged(tag).sort(function(a,b){
				return a.sorterUtil(b,&quot;orderSlice&quot;);
			});

			getValues.each(function(t) {

				var label = store.getTiddlerSlice(t.title,&quot;button&quot;);
				var autoClass = &quot;button &quot; + t.title.replace(/[\/ ]/g,'') 

				if (!label)
					label = t.title;

				if (useCheckbox == &quot;yes&quot;) {
					// checkbox style toggle tags
					wikify(&quot;&lt;&lt;toggleTag [[&quot;+t.title+&quot;]] [[&quot;+tiddler.title+&quot;]] -&gt;&gt;[[&quot;+label+&quot;]]&amp;nbsp;&quot; ,place,null,tiddler);
				}
				else {
					// button style toggle tags
					var cl = createTiddlyButton(place, label, t.title, function(e) {
							actOnTiddler.toggleTag(t.title);
							if (refresh == &quot;page&quot;)
								refreshPageTemplate();
							return false;
						},
						autoClass + &quot; &quot; + (actOnTiddler.getByIndex(tag).contains(t.title) ? &quot;on&quot; : &quot;off&quot;)
						);
			 	}
			 });
		}
		
	},

	multiToggleTag: {

		handler: function(place,macroName,params,wikifier,paramString,tiddler) {

			var pp = paramString.parseParams(&quot;tag&quot;,null,true);
			
			if (!tiddler)
				tiddler = store.getTiddler(getParam(pp,&quot;title&quot;));
			
			var tag = getParam(pp,&quot;tag&quot;);

			var refresh = getParam(pp,&quot;refresh&quot;); // stupid bit for pagetemplate hack
			var longVersion = getParam(pp,&quot;longVersion&quot;);

			var title = getParam(pp,&quot;title&quot;,tiddler.title);
			var actOnTiddler = store.getTiddler(title);

			var getValues = fastTagged(tag).sort(function(a,b){
				return a.sorterUtil(b,&quot;orderSlice&quot;);
			});


			getValues.each(function(t) {
				var label = store.getTiddlerSlice(t.title,longVersion?&quot;buttonLong&quot;:&quot;button&quot;);

				var extraClass = store.getTiddlerSlice(t.title,&quot;buttonClass&quot;);
				var autoClass = (extraClass ? extraClass : &quot;&quot;) + &quot; button &quot; + t.title.replace(/[\/ ]/g,'') 
				if (!label) label = t.title;
				var cl = createTiddlyButton(place, label, t.title, function(e) {
						actOnTiddler.setTagFromGroup(tag,t.title);
						if (refresh == &quot;page&quot;)
							refreshPageTemplate();
						return false;
					},
					autoClass + &quot; &quot; + (actOnTiddler.getByIndex(tag).contains(t.title) ? &quot;on&quot; : &quot;off&quot;)
					);
			});

		}
	},

	multiSelectTag: {

		handler: function(place,macroName,params,wikifier,paramString,tiddler) {

			var pp = paramString.parseParams(&quot;tag&quot;,null,true);
			
			if (!tiddler)
				tiddler = store.getTiddler(getParam(pp,&quot;title&quot;));
			
			var tag = getParam(pp,&quot;tag&quot;);
			var refresh = getParam(pp,&quot;refresh&quot;); // stupid bit for pagetemplate hack

			var allowNone = getParam(pp,&quot;allowNone&quot;);

			var title = getParam(pp,&quot;title&quot;,tiddler.title);
			var actOnTiddler = store.getTiddler(title);

			var selectOptions = [];

			if (allowNone)
				selectOptions.push({name: null, caption:'-'});// TODO this doesn't work right?

			var getValues = fastTagged(tag).sort(function(a,b){
				return a.sorterUtil(b,&quot;orderSlice&quot;);
			});

			getValues.each(function(t) {
				var useTitle = store.getTiddlerSlice(t.title,&quot;button&quot;);
				if (!useTitle) useTitle = t.title;
				selectOptions.push({name: t.title, caption:useTitle});
			});

			var dd = createTiddlyDropDown(place, function(e) {
					actOnTiddler.setTagFromGroup(
						tag,
						selectOptions[this.selectedIndex].name
						);
					if (refresh == &quot;page&quot;)
						refreshPageTemplate();
					return false;
				},
				selectOptions,
				actOnTiddler.getByIndex(tag)[0]
			);

		}
	},

	multiCheckboxTag: {

		handler: function(place,macroName,params,wikifier,paramString,tiddler) {

			var pp = paramString.parseParams(&quot;tag&quot;,null,true);
			
			if (!tiddler)
				tiddler = store.getTiddler(getParam(pp,&quot;title&quot;));
			
			var tag = getParam(pp,&quot;tag&quot;);

			var title = getParam(pp,&quot;title&quot;,tiddler.title);
			var actOnTiddler = store.getTiddler(title);

			var getValues = fastTagged(tag).sort(function(a,b){
				return a.sorterUtil(b,&quot;orderSlice&quot;);
			});

			var output = &quot;&quot;;
			getValues.each(function(t) {
				output += &quot;&lt;&lt;toggleTag [[%0]] [[%1]] [[%0]]&gt;&gt;&quot;.format([
					t.title,
					actOnTiddler.title
				]);
			});

			wikify(output,place,null,tiddler);

		}
	},

	// these don't really belong here but never mind..
	convertToFromTickler: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			if (tiddler.tags.contains('Tickler')) {

				createTiddlyButton(place, &quot;make action&quot;, &quot;make this tickler into a next action&quot;, function(e) {
						tiddler.removeTag(&quot;Tickler&quot;);                      
						tiddler.addTag(&quot;Action&quot;);                      
						tiddler.removeTag(&quot;Done&quot;);                     
						tiddler.setTagFromGroup(&quot;ActionStatus&quot;,&quot;Next&quot;); 
						return false;
					});

				createTiddlyButton(place, &quot;make project&quot;, &quot;make this tickler into an active project&quot;, function(e) {
						tiddler.removeTag(&quot;Tickler&quot;);                      
						tiddler.addTag(&quot;Project&quot;);                       
						tiddler.removeTag(&quot;Complete&quot;);                   
						tiddler.setTagFromGroup(&quot;ProjectStatus&quot;,'Active');
						return false;
					});
			}
			if (tiddler.tags.containsAny(['Action','Project'])) {
				createTiddlyButton(place, &quot;make tickler&quot;, &quot;make this item into a tickler&quot;, function(e) {
						tiddler.removeTag(&quot;Action&quot;);
						tiddler.removeTag(&quot;Project&quot;);
						tiddler.addTag(&quot;Tickler&quot;);                          
						tiddler.addTag(&quot;Once&quot;);                          
						return false;
					});
			}
		}
	},

	convertActionToSubProj: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			if (tiddler.tags.contains('Action')) {

				createTiddlyButton(place, &quot;make subj project&quot;, &quot;make this action into a sub project&quot;, function(e) {
						tiddler.removeTag(&quot;Action&quot;);                      
						tiddler.removeTag(&quot;Next&quot;);                     
						tiddler.removeTag(&quot;Future&quot;);                     
						tiddler.removeTag(&quot;Waiting For&quot;);                     
						tiddler.removeTag(&quot;Done&quot;);                     
						tiddler.addTag(&quot;Project&quot;);                      
						tiddler.addTag(&quot;Active&quot;);                      
						return false;
					});

			}
		}
	},


	linkToParent: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			var label = params[1] ? params[1] : '&gt;&gt;';
			var useTiddler = params[2] ? store.fetchTiddler(params[2]) : tiddler;
			var links = useTiddler.getByIndex(params[0]);
			var output = &quot;&quot;;
			for (var i=0;i&lt;links.length;i++)
				output += ( (i==0?'':' ') + &quot;[[%1|%0]]&quot;.format([links[i], label == 'title' ? '['+links[i]+']' : label]) );
			if (output != &quot;&quot;)
				wikify(output,place,null,useTiddler);
		}
	}

});

setStylesheet([&quot;&quot;,
&quot;.button.off {font-weight:bold;border-color:#eee;background:#fff;color:#ccc;margin:0px;font-size:100%}&quot;,
&quot;.button.on {font-weight:bold;border-color:#444;background:#888;color:#fff;margin:0px;font-size:100%}&quot;,
&quot;.button.tiny { font-size:75%; }&quot;,
// TODO move this css elsewhere
&quot;#realmSelector .button.off {margin:0 0.5em;padding:0 1em;border:2px solid #aaa;background:#eee;color:#333;}&quot;, // actually reversed, ie off is &quot;on&quot;
&quot;#realmSelector .button.on {margin:0 0.5em;padding:0 1em;border:2px solid #999;background:#999;color:#ccc;}&quot;, // actually reversed, ie off is &quot;on&quot;

// TODO put into styles instead of here?
// actions
&quot;.viewer .Next.button.on {border-color:#55c;background:#cfa;color:#4a4;}&quot;,
&quot;.viewer .WaitingFor.button.on {border-color:#b84;background:#fdb;color:#b84;}&quot;,
&quot;.viewer .Future.button.on {border-color:#48b;background:#bdf;color:#48b;}&quot;,

// projects
&quot;.viewer .Active.button.on {border-color:#55c;background:#cfa;color:#4a4;}&quot;,
&quot;.viewer .SomedayMaybe.button.on {border-color:#48b;background:#bdf;color:#48b;}&quot;,

// ticklers
&quot;.viewer .Enabled.button.on {border-color:#55c;background:#cfa;color:#4a4;}&quot;,
&quot;.viewer .Disabled.button.on {border-color:#b84;background:#fdb;color:#b84;}&quot;,

&quot;.viewer .Starred.button {padding:0;font-size:100%;}&quot;,
&quot;.viewer .Starred.button.on {border-color:#fff;background:#fff;color:#f80;}&quot;,
&quot;.viewer .Starred.button.off {border-color:#fff;background:#fff;color:#ddd;}&quot;,

&quot;&quot;].join(&quot;\n&quot;),&quot;tTag&quot;);

//}}}




</pre>
</div>
<div title="MgtdUpgradeUrl" modifier="YourName" created="200804160018" modified="200805221358" tags="systemServer excludeSearch">
<pre>URL: http://monkeygtd.tiddlyspot.com/upgrade.html
</pre>
</div>
<div title="MgtdUserConf" modifier="YourName" created="200805221358" modified="200805221358" tags="systemConfig">
<pre>// won't be overwritten by updates

 // eg:

//// config.options.txtTheme = 'MonkeyGTDPrint3x5';</pre>
</div>
<div title="MgtdWikify" modifier="YourName" created="200804020731" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>//{{{

merge(config.macros, {
	eval: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			wikify(eval(paramString),place,null,tiddler);
		}
	}
});

//}}}

</pre>
</div>
<div title="Mismatched Realms" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>Fix these manually. These have either no realm or a different realm to their parent.
{{cols3{

{{col{

&lt;&lt;mgtdList
	title:'Action/Project mismatch'
	startTag:Action
	view:star
	mode:global
	ignoreRealm:yes
	where:&quot;tiddler.realmMismatchWithParent('Project')&quot;
	group:Project
	gView:bold
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList
	title:'Projects/Area mismatch'
	startTag:Project
	view:star
	mode:global
	ignoreRealm:yes
	where:&quot;tiddler.realmMismatchWithParent('Area')&quot;
	group:Area
	gView:bold
	&gt;&gt;


}}}

{{col{

&lt;&lt;mgtdList
	title:'Subproject/parent project mismatch'
	startTag:Project
	view:star
	mode:global
	ignoreRealm:yes
	where:&quot;tiddler.realmMismatchWithParent('Project')&quot;
	&gt;&gt;


}}}

}}}
</pre>
</div>
<div title="MonkeyGTDHelp" modifier="YourName" created="200804191227" modified="200805221358" tags="excludeSearch">
<pre>/%
This is the contents of the help you get when you click the question mark button
%/

!Project
No help yet for Project

!Action
No help yet for Action

!Tickler
No help yet for Tickler

!View
No help yet for View

!Context
No help yet for Context

!Area
No help yet for Area

!Realm
No help yet for Realm

!Reference
No help yet for Reference



!Action Dashboard
This Dashboard is the place where you can get an overview of your next actions.  

!Action Dashboard by Project
This Dashboard is the place where you can get an overview of your next actions organised by Project. Note that when doing work you shouldn't be really be using this view. You should be focussed on context rather than project.

!Action Dashboard by Context
This Dashboard is the place where you can get an overview of your next actions organised by Context. This might be too cluttered if you have a lot of actions.  If you know you are in a particular context consider just clicking the context to focus on that context.

!Next Actions
No help yet for Next Actions

!Next Actions by Context
No help yet for Next Actions by Context

!Next Actions by Project
No help yet for Next Actions by Project

!Projects Dashboard
No help yet for Projects Dashboard

!Projects Dashboard by Area
No help yet for Projects Dashboard by Area

!Next and Waiting Actions
No help yet for Next and Waiting Actions

!Next and Waiting Actions by Context
No help yet for Next and Waiting Actions by Context

!Next and Waiting Actions by Project
No help yet for Next and Waiting Actions by Project

!Done Actions
No help yet for Done Actions

!Active Projects With No Next Action
No help yet for Active Projects With No Next Action

!Quick Add
No help yet for Quick Add

!About Quick Add
No help yet for About Quick Add

!Tickler Dashboard
No help yet for Tickler Dashboard

!Ticklers Requiring Action
No help yet for Ticklers Requiring Action

!Reference Items
No help yet for Reference Items

!Starred Items
No help yet for Starred Items

</pre>
</div>
<div title="MonkeyGTDNarrow" modifier="YourName" created="200805061400" modified="200805221358" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MonkeyGTD Narrow|
|Description|MonkeyGTD Theme for Narrow Screens|
|PageTemplate|MonkeyGTDTheme##PageTemplate|
|StyleSheet|MonkeyGTDNarrow##StyleSheet|
|ViewTemplate|MonkeyGTDTheme##ViewTemplate|
|EditTemplate|MptwTheme##EditTemplate|

!StyleSheet
/*{{{*/

[[MonkeyGTDTheme##StyleSheet]]

/* give a little less space for menu */
#sidebar { width: 16em; /* instead of 16em */ }
#displayArea { margin-right:15.7em; /* instead of 15.7em */ }
#sidebarTabs .tabContents { width:15em; /* instead of 15em */ }

.txtMGTDMain .tab {
	font-size:80%!important;
}
.txtMGTDMain .tabContents {
	font-size:90%;
}


[[StyleSheet]]

/*}}}*/

</pre>
</div>
<div title="MonkeyGTDPrint3x5" modifier="YourName" created="200805071346" modified="200805221358" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MonkeyGTD Print 3x5|
|Description|MonkeyGTD Theme for Printing 3x5 Cards|
|PageTemplate|MonkeyGTDTheme##PageTemplate|
|StyleSheet|MonkeyGTDPrint3x5##StyleSheet|
|ViewTemplate|MonkeyGTDTheme##ViewTemplate|
|EditTemplate|MptwTheme##EditTemplate|

!StyleSheet
/*{{{*/

[[MonkeyGTDTheme##StyleSheet]]

[[MonkeyGTDTheme##Printing3x5Styles]]

[[StyleSheet]]

/*}}}*/


</pre>
</div>
<div title="MonkeyGTDTheme" modifier="YourName" created="200805221307" modified="200805221358" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MonkeyGTD|
|Description|MonkeyGTD Theme|
|PageTemplate|MonkeyGTDTheme##PageTemplate|
|StyleSheet|MonkeyGTDTheme##StyleSheet|
|ViewTemplate|MonkeyGTDTheme##ViewTemplate|
|EditTemplate|MptwTheme##EditTemplate|

!ViewTemplate
&lt;!--{{{--&gt;
&lt;div macro=&quot;showWhen tiddler.tags.containsAny(config.mGTD.specialTags)&quot;&gt;
	[[MonkeyGTDTheme##ViewTemplateToolbar]]
	&lt;div class='titleContainer viewer'&gt;[[TitleButtonsSelector]]&lt;/div&gt;
	[[MonkeyGTDTheme##Panel]]
	&lt;div macro=&quot;showWhenTaggedAny Reference View&quot;&gt;
		&lt;!--- just make it look like a normal tiddler ---&gt;
		&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
	&lt;/div&gt;
	&lt;div macro=&quot;else&quot;&gt;
		&lt;div macro=&quot;showWhen tiddler.text != ''&quot;&gt;
			&lt;div class='viewer'&gt;Notes:&lt;/div&gt;
			&lt;div class='viewer postityellow' macro='view text wikified'&gt;&lt;/div&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;div class='viewer'&gt;[[DashboardSelector]]&lt;/div&gt;
&lt;/div&gt;
&lt;div macro=&quot;hideWhen tiddler.tags.containsAny(config.mGTD.specialTags)&quot;&gt;
	&lt;!--- use standard template for non gtd tiddlers ---&gt;
	[[MptwTheme##ViewTemplate]]
&lt;/div&gt;
&lt;!--}}}--&gt;

!ViewTemplateToolbar
&lt;!--{{{--&gt;
&lt;!-- it's identical to Mptw at present except add Reference tag to new journal and new tiddler. will probably tweak it more later. --&gt;
&lt;div class='toolbar'&gt;
	&lt;span macro=&quot;showWhenTagged systemConfig&quot;&gt;
		&lt;span macro=&quot;toggleTag systemConfigDisable . '[[disable|systemConfigDisable]]'&quot;&gt;&lt;/span&gt;
	&lt;/span&gt;
	&lt;span macro=&quot;showWhenTagged systemTheme&quot;&gt;&lt;span macro=&quot;applyTheme&quot;&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;span macro=&quot;showWhenTagged systemPalette&quot;&gt;&lt;span macro=&quot;applyPalette&quot;&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;span macro=&quot;showWhen tiddler.tags.contains('css') || tiddler.title == 'StyleSheet'&quot;&gt;&lt;span macro=&quot;refreshAll&quot;&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;span style=&quot;padding:1em;&quot;&gt;&lt;/span&gt;
	&lt;span macro='toolbar closeTiddler closeOthers +editTiddler deleteTiddler &gt; fields syncing permalink references jump'&gt;&lt;/span&gt;
	&lt;span macro='newHere label:&quot;new here&quot; tag:Reference'&gt;&lt;/span&gt;
	&lt;span macro='newJournalHere {{config.mGTD.getOptTxt(&quot;newjournaldateformat&quot;)?config.mGTD.getOptTxt(&quot;newjournaldateformat&quot;):&quot;DD-mmm-YY 0hh:0mm&quot;}} tag:Reference'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Panel
&lt;!--{{{--&gt;
&lt;!--- nothing as yet? ---&gt;
&lt;!--}}}--&gt;

!Dashboard
&lt;!-- check if is this obsolete now then delete it. I think it is. ??? --&gt;
&lt;!--{{{--&gt;
&lt;div macro=&quot;showWhenTagged Project&quot; class=&quot;viewer&quot;          &gt;[[Dashboards##Project]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged Area&quot; class=&quot;viewer&quot;             &gt;[[Dashboards##Area]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged Realm&quot; class=&quot;viewer&quot;            &gt;[[Dashboards##Realm]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged Context&quot; class=&quot;viewer&quot;          &gt;[[Dashboards##Context]]&lt;/div&gt;

&lt;div macro=&quot;showWhenTitleIs 'Action Dashboard'&quot;             &gt;[[Dashboards##Action Dashboard]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTitleIs 'Action Dashboard by Context'&quot;  &gt;[[Dashboards##Action Dashboard by Context]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTitleIs 'Just Next Actions'&quot;            &gt;[[Dashboards##Just Next Actions]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTitleIs 'Just Next Actions by Context'&quot; &gt;[[Dashboards##Just Next Actions by Context]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTitleIs 'Projects'&quot;                     &gt;[[Dashboards##Projects]]&lt;/div&gt;
&lt;!--- many more. but fix DRY issues ---&gt;
&lt;!--}}}--&gt;

!Subtitle
&lt;span class='subtitle'&gt;
	Updated
	&lt;span macro='view modified date {{config.mptwDateFormat?config.mptwDateFormat:&quot;MM/0DD/YY&quot;}}'&gt;&lt;/span&gt;
	(&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt;
	&lt;span macro='view created date {{config.mptwDateFormat?config.mptwDateFormat:&quot;MM/0DD/YY&quot;}}'&gt;&lt;/span&gt;)
&lt;/span&gt;

!PageTemplate
&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
	&lt;div style=&quot;float:right&quot; id='searchBox' macro=&quot;search Search...&quot;&gt;&lt;/div&gt;
	&lt;div class='header2'&gt;MonkeyGTD &lt;span style=&quot;font-size:75%;font-weight:normal;&quot; macro=&quot;mgtdVersion&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div macro='gradient vert [[ColorPalette::PrimaryMid]] [[ColorPalette::PrimaryDark]]'&gt;
	&lt;div style=&quot;float:right&quot; id=&quot;toggleSideBar&quot;&gt;&lt;span macro=&quot;toggleSideBar&quot;&gt;&lt;/span&gt;&lt;/div&gt;
	&lt;div class='mtoolbar'&gt;
	&lt;div&gt;
	&lt;span class=&quot;label&quot;&gt;REALM&lt;/span&gt;&lt;span id='arealmSelector' macro=&quot;groupOfSingleToggleTags tag:Realm title:MgtdSettings refresh:page&quot;&gt;&lt;/span&gt;
	&lt;span id='ticklerAlert' refresh='content' tiddler='TicklerAlert' force=&quot;true&quot;&gt;&lt;/span&gt;
	&lt;span id='newButtons' refresh='content' tiddler='NewButtons'&gt;&lt;/span&gt;
	&lt;/div&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
	&lt;div id='sidebarOptions'&gt;
		&lt;span macro=&quot;saveChanges&quot;&gt;&lt;/span&gt;
		&lt;span macro=&quot;closeAll&quot;&gt;&lt;/span&gt;
		&lt;span macro=&quot;showWhen store.tiddlerExists('TspotSidebar')||store.isShadowTiddler('TspotSidebar')&quot;&gt;&lt;span refresh='content' tiddler='TspotSidebar'&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;/div&gt;
	&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='MGTDSidebar'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
	&lt;div id='messageArea'&gt;&lt;/div&gt;
	&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!SidebarMenus
&lt;!--{{{--&gt;
&lt;!--- not using ---&gt;
&lt;div id='twsidebar' macro=&quot;showWhen store.fetchTiddler('MgtdSettings').tags.contains('TW')&quot;&gt;
	&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
	&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='twsidebar' macro=&quot;hideWhen store.fetchTiddler('MgtdSettings').tags.contains('TW')&quot;&gt;
	&lt;div id='sidebarOptions'&gt;
		&lt;span macro=&quot;showWhen store.tiddlerExists('TspotSidebar')||store.isShadowTiddler('TspotSidebar')&quot;&gt;&lt;span refresh='content' tiddler='TspotSidebar'&gt;&lt;/span&gt;&lt;/span&gt;
		&lt;span refresh='content' tiddler='CommonMenu'&gt;&lt;/span&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;div id='monkeygtdsidebar' macro=&quot;showWhen store.fetchTiddler('MgtdSettings').tags.contains('Do Work')&quot;&gt;
	&lt;div class=&quot;menu&quot; refresh='content' tiddler='DoWorkMenu'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='monkeygtdsidebar' macro=&quot;showWhen store.fetchTiddler('MgtdSettings').tags.contains('Review')&quot;&gt;
	&lt;div class='menu' refresh='content' tiddler='ReviewMenu'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='monkeygtdsidebar' macro=&quot;showWhen store.fetchTiddler('MgtdSettings').tags.contains('Process Inbox')&quot;&gt;
	&lt;div class='menu' refresh='content' tiddler='ProcessInboxMenu'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!---
&lt;div id='monkeygtdsidebar' macro=&quot;showWhen store.fetchTiddler('MgtdSettings').tags.contains('Collect Items')&quot;&gt;
	&lt;div class='menu' refresh='content' tiddler='CollectItemsMenu'&gt;&lt;/div&gt;
&lt;/div&gt;
---&gt;
&lt;div id='monkeygtdsidebar' macro=&quot;showWhen store.fetchTiddler('MgtdSettings').tags.contains('Config')&quot;&gt;
	&lt;div class='menu' refresh='content' tiddler='ConfigMenu'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Printing3x5Styles
/*{{{*/
@media print {

.cols3 .col {width: 100%; float:none;}
.cols2 .col {width: 100%; float:none;}

.titleContainer {text-align:center;}

/* LAYOUT ELEMENTS
========================================================== */
*
{
 margin: 0;
 padding: 0;

}

body {
 background: #fff;
 color: #000;
 font-size: 6.2pt;
 font-family: &quot;Lucida Grande&quot;, &quot;Bitstream Vera Sans&quot;, Helvetica,
Verdana, Arial, sans-serif;

}

img {
 max-width: 2.5in;
 max-height: 4.5in;

}

.tiddler {
 margin: 0 0 2em 0;
 border-top: 1px solid #000;
 page-break-before: always;

}

.tiddler:first-child {
 page-break-before: avoid;

}

p, blockquote, ul, li, ol, dt, dd, dl, table
{
 margin: 0 0 .3em 0;

}

h1, h2, h3, h4, h5, h6
{
 margin: .2em 0;

}

h1
{
 font-size: 1.5em;

}

h2
{
 font-size: 1.3em;

}

h3
{
 font-size: 1.25em;

}

h4
{
 font-size: 1.15em;

}

h5
{
 font-size: 1.1em;

}

blockquote
{
 margin: .6em;
 padding-left: .6em;
 border-left: 1px solid #ccc;

}

ul
{
 list-style-type: circle;

}

li
{
 margin: .1em 0 .1em 2em;
 line-height: 1.4em;

}

table
{
 border-collapse: collapse;
 font-size: 1em;

}

hr {
 border: none;
 border-top: dotted 1px #777;
 height: 1px;
 color: #777;
 margin: .6em 0;
}

}/* end @media print */

/*}}}*/


!StyleSheet
/*{{{*/

[[MptwTheme##StyleSheet]]

.header2 {
	background:url(http://simonbaird.com/images/monkeygtd/logo-trans.gif) no-repeat -15px 2px transparent;
	padding:5px;
	padding-left:80px;
	color:white;
	font-size:1.3em;
	font-weight:bold;
}

#backstageShow { color:[[ColorPalette::PrimaryLight]] ! important; }

/* the png is superior due to alpha transparency. stupid IE */
html&gt;body .header2 {background-image:url(http://simonbaird.com/images/monkeygtd/logo-trans.png)}

.headerShadow, .headerForeground {
	padding:0;
}

.mtoolbar { padding:0.1em; padding-top:0.5em;}
.mtoolbar .button { margin-left:0.5em; padding:0.2em 0.3em; margin:0.2em 0.3em;  }
.mtoolbar .button.off {background-color:[[ColorPalette::TertiaryMid]]!important; color:black; font-weight:normal;border-color:[[ColorPalette::PrimaryDark]];}
.mtoolbar .button.on {background-color:[[ColorPalette::TertiaryLight]]; color:black; border-color:[[ColorPalette::PrimaryDark]];} 

.mtoolbar .button {
	-moz-border-radius-topleft: 0.5em;
	-moz-border-radius-topright: 0.5em;
}

#newButtons { padding-left:3em; }
#newButtons br { display:none; }
#newButtons .button { background-color:transparent; color:white; border-color:transparent; }

.txtMGTDMain .tabContents {
	font-size:120%;
}

.txtMGTDMore .tabContents {
	font-size:90%;
}

.tabContents .sliderButton {
	font-size:120%;
	background-color:[[ColorPalette::TertiaryLight]];
}



.mtoolbar .label { font-size:80%; color:[[ColorPalette::PrimaryLight]]; padding:0.5em;}


#displayArea {
	margin: 1em 15.7em 0em 1em; /* use the freed up space */
}

#sidebar, #sidebarOptions
	width:18em;
}

#sidebarTabs {
	width:100%;
}

#mainMenu { display:none; }

#sidebar .menu a {
	font-size:140%;
}

#sidebar .menu ul {
	padding-left:2em;
	padding-top:0;
	margin-top:0;
}
#sidebar .menu h1,
#sidebar .menu h2
{
	color:[[ColorPalette::PrimaryDark]];
	margin:0;
	padding:0;
	margin-top:0.25em;
}
#sidebar .menu h1 {
	font-size:180%;
}
#sidebar .menu h2 {
	font-size:140%;
	margin-left:0.5em;
}


.viewer table.twocol,
.viewer table.threecol {
	border-style:none ! important;
	border-collapse:no-collapse;
	width:100%;
	padding:0; margin:0;
}

.viewer table.twocol td,
.viewer table.threecol td {
	border-style:none ! important;
	vertical-align:top;
	padding-right:1em;
}

.viewer table.twocol tr,
.viewer table.threecol tr {
	border-style:none ! important;
}

.viewer table.twocol td {
	width:50%;
}
.viewer table.threecol td {
	width:33%;
}


.mgtdList h1 {
	border-bottom:1px solid #aaa;
	color:#444;
	font-size:110%;
	margin:0;
	padding:0;
}

.mgtdList h1 br {
	display:none;
}

.mgtdList h1 .button {
	border-color:transparent;
	font-weight:bold;
	font-size:110%;
}

.mgtdList h1 .button:hover {
	border-color:#999;
}

.mgtdList h2 {
	border-style:none!important;
	font-size:100%;
	margin:0; padding:0;
	margin-top:0.7em;
	margin-left:-0.2em;
	color:#444;
}

.mgtdList h2 .button {
	border-style:none!important;
}

.mgtdList {
	padding:0;
	padding-right:1em;
}

.mgtdList .innerList {
	padding:0.5em 1em 0em 1em;
}

.tabContents .sliderPanel {
	margin-left:2em;
}
.txtMGTDMain .mgtdList .innerList {
	font-size:80%;
	padding-left:0em;
}

.tabContents li {
	margin-left:2em;
}


.mgtdList .plain { padding-left:1em; }

#sidebar .mgtdList .plain { padding-left:0em; }
#sidebar .tabContents .sliderPanel { margin-left:1em; }
#sidebar .sliderPanel .mgtdList .plain { padding-left:0em; }
#sidebar .mgtdList .noneHeading .tiddlyLink { font-weight:normal!important; }

/* TODO why not just make it all of them... */
.mgtdList .action .tiddlyLinkExisting,
.mgtdList .plain .tiddlyLinkExisting,
.mgtdList .tickler .tiddlyLinkExisting,
.mgtdList .project .tiddlyLinkExisting
{
	font-weight: normal ! important;
}

/* TODO why not just make it all of them... */
.mgtdList .action .tiddlyLink,
.mgtdList .plain .tiddlyLink,
.mgtdList .tickler .tiddlyLink,
.mgtdList .project .tiddlyLink
{
	font-weight: normal ! important;
}

.mgtdList .button {
	font-weight: normal;
	margin:1px;
}

body {
	background: [[ColorPalette::TertiaryLight]];
}

.title { font-size:150%; color:black; }

#monkeygtdsidebar h1 {
	font-size:120%; color:green;
}

.none { color:[[ColorPalette::TertiaryMid]]; font-size:90%; font-style:italic; }

.postityellow {
	background-color:#ffa;
	border:2px solid #dd8;
	padding-left:1em;
	padding-bottom:0.5em;
}
.postityellow h1,
.postityellow h2,
.postityellow h3,
.postityellow h4
{
	border-style:none;
}

#sidebar .sliderButton { font-weight:bold; padding-left:0.25em; }
#sidebar .sliderPanel ul { margin-bottom:0px; }
#sidebar .sliderPanel li { font-weight:medium; font-size:90%; }

#sidebar .mgtdList .innerList .tiddlyLink {
	font-size:120%;
}

.innerList h3 {
    font-size:80%;
    margin:0; padding:0;
    
}

#newButtons .sliderPanel {
	background-color:[[ColorPalette::TertiaryMid]];
	margin-top:4px;
	padding:1em;
	border-top:2px solid #444;
	border-bottom:2px solid #444;
}

#newButtons .sliderPanel br {
	display:inline;
}

#newButtons .sliderPanel .button {
	font-weight:bold;
	color:black
	border:1px solid black;
	background-color:#666;
}

.piBox {
	width:95%;
	height:8em;
}

.smaller { font-size: 85%; }

.scroll10 .innerList {
	overflow:auto;
	height:12em;
}

.dateBox {
	/* TODO make prettier */
	font-weight:medium; font-size:120%; margin:0.1em; background-color:#ffd;
	border:1px solid #ccc;
	background-color:#fff;
	text-align:center;
	width:8em;
}
.mgtdList .dateBox { font-weight:medium; font-size:100%; }

#ticklerAlert br { display:none; }

.ticklerAlert { padding-left:3em; }
.ticklerAlert .tiddlyLink { color:white; }

/* give a little more space for menu */
#sidebar { width: 21em; /* instead of 16em */ }
#displayArea { margin-right:20.7em; /* instead of 15.7em */ }
#sidebarTabs .tabContents { width:94%; /*16.5em;  instead of 15em */ } /* this seems silly */

#messageArea .help { width:40em; font-size:90%; }

#searchBox {
	position:absolute;
	top: 2px;
	right: 7em;
	z-index:200;
	/* make room for backstage link? */
}
#searchBox .button {
	display:none;
}

.tabContents .button {
	display:block;
}
.tabContents .li .button {
	display:inline; /* hack to make for quickopentags in tabTags look right... */
}
.tabContents li .button {
	display:inline; /* hack to make for quickopentags in tabTags look right... */
}

.txtMGTDMain .tab {
	font-size:120%;
}

.projLink .tiddlyLinkExisting, .projLink {
	font-weight:normal;
	color:[[ColorPalette::TertiaryDark]];
}

.projLinkFull .tiddlyLinkExisting, .projLinkFull {
	font-weight:normal;
	color:[[ColorPalette::TertiaryDark]];
	font-size:90%;
}

/* ============= new div based columns ================= */
.col {
  float: left;
  vertical-align:top;
}

.cols3, .cols2 {
	overflow: auto; /* contains floats. tnx FND */
}

/* IE not doing these right :( */
/* .cols3&gt;br, .col&gt;br { display:none; } */

/* so try this instead. it's annoying and will mean you have trouble 
with brs in non-mgtdlist content. .normal might help */
.cols2 br, .cols3 br  { display:none; }
.mgtdList br, .normal { display:block!important; }
.col .mgtdList { margin-bottom:1.5em; } /* since we're no longer seeing the brs... */

.cols3 .col {
  width: 33%;
}
.cols2 .col {
  width: 49%; /* 50% makes IE put them under each other */
}
.clear {
  clear: left;
}
/* ============= */

#toggleSideBar {
	margin-top:0.5em;
	margin-right:0.5em;
}
.button.HideSideBarButton {
	color:[[ColorPalette::PrimaryLight]];
	border-style:none;
	font-weight:bold;
	font-size:80%;
	padding:0em 1em;
	background-color:[[ColorPalette::PrimaryMid]];
	-moz-border-radius: 0.5em;
}

/* applicable for any printing. (moved from the 3x5 section) */
@media print {

	.viewer .tiddlyLink,
	.mgtdList .tiddlyLink,
	.tiddlyLink
	  { color:black ! important; }

	#sidebar, .mtoolbar, .header2, #toggleSideBar, #backstageArea,
	#backstageButton, #searchBox, .subtitle, .button
	  {display: none !important;}

	#displayArea {margin: 0;}
	#contentWrapper .chkOptionInput {border:0; width:0.25cm;}
	.titleContainer {border-bottom: 1px dotted #000;}

}


.controls {
	margin: auto;
	margin:0; padding:0;
}
.controls tr, .controls td, .controls {
	border-style:none!important;
	border-collapse:no-collapse;
}

.controls {
	clear:right;
	padding:0.5em;
	margin-top:1em;
	padding-bottom:0.5em;
}

.controlstint {
	background-color:#f0f0f0;
	border:1px solid #ccc!important; 
}

.toolbar .button {
	border-style:none!important;
}

.controls .subtitle {
	margin-left:0;
	padding-left:0;
}

.controls .button {
	background-color:#fff;
}

.controls .label {
	color:#888; font-size:90%;
}

.controls .floatleft {
	padding-right:1em;
	float:left;
}

.controls .floatright {
	padding-left:1em;
	float:right;
}


.controls .clearleft { clear:left; }
.controls .clearright { clear:right; }
.controls .clearboth { clear:both; }

.controls .button.on {
	background-color:#555; border-style:none!important;
}

.controlstint .button.Starred.off,
.controlstint .button.Starred.on
{ background-color:#f0f0f0; border-style:none!important;}

.unboldLinks .tiddlyLink {
	font-weight:normal;
}

.smaller select { font-size:90%; }

.buttonsLikeLinks .button {
	border-style:none!important;
	background:transparent;
	color:#008;
}

.buttonsLikeLinks .button:hover {
	text-decoration:underline;
}


/* for user styles */
[[StyleSheet]]

/*}}}*/

</pre>
</div>
<div title="Monthly" modifier="YourName" created="200805221358" modified="200805221358" tags="TicklerRepeatType">
<pre>order:3
button:month
buttonLong:monthly
</pre>
</div>
<div title="MptwBlack" modifier="MPTW" created="200803062257" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwBlack
Background: #000
Foreground: #fff
PrimaryPale: #333
PrimaryLight: #555
PrimaryMid: #888
PrimaryDark: #aaa
SecondaryPale: #111
SecondaryLight: #222
SecondaryMid: #555
SecondaryDark: #888
TertiaryPale: #222
TertiaryLight: #666
TertiaryMid: #888
TertiaryDark: #aaa
Error: #300

This is in progress. Help appreciated.


</pre>
</div>
<div title="MptwBlue" modifier="MPTW" created="200803062257" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwBlue
Background: #fff
Foreground: #000
PrimaryPale: #cdf
PrimaryLight: #57c
PrimaryMid: #114
PrimaryDark: #012
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88

</pre>
</div>
<div title="MptwConfigPlugin" modifier="MPTW" created="200804250243" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|MptwConfigPlugin|
|Description:|Miscellaneous tweaks used by MPTW|
|Version:|1.0 ($Rev: 3646 $)|
|Date:|$Date: 2008-02-27 02:34:38 +1000 (Wed, 27 Feb 2008) $|
|Source:|http://mptw.tiddlyspot.com/#MptwConfigPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#MptwConfigPlugin|
!!Note: instead of editing this you should put overrides in MptwUserConfigPlugin
***/
//{{{
var originalReadOnly = readOnly;

config.options.chkHttpReadOnly = false; 		// means web visitors can experiment with your site by clicking edit
readOnly = false;								// needed because the above doesn't work any more post 2.1 (??)

config.options.chkInsertTabs = true;    		// tab inserts a tab when editing a tiddler
config.views.wikified.defaultText = &quot;&quot;;			// don't need message when a tiddler doesn't exist
config.views.editor.defaultText = &quot;&quot;;			// don't need message when creating a new tiddler 

config.options.chkAutoSave = true;				// do autosave
config.options.chkSaveBackups = true;			// do save backups
config.options.txtBackupFolder = 'twbackup';	// put backups in a backups folder

config.mptwVersion = &quot;2.3.7&quot;;

config.macros.mptwVersion={handler:function(place){wikify(config.mptwVersion,place);}};

if (config.options.txtTheme == '')
	config.options.txtTheme = 'MptwTheme';

// add to default GettingStarted
config.shadowTiddlers.GettingStarted += &quot;\n\nSee also [[MPTW]].&quot;;

// add select theme and palette controls in default OptionsPanel
config.shadowTiddlers.OptionsPanel = config.shadowTiddlers.OptionsPanel.replace(/(\n\-\-\-\-\nAlso see AdvancedOptions)/, &quot;{{select{&lt;&lt;selectTheme&gt;&gt;\n&lt;&lt;selectPalette&gt;&gt;}}}$1&quot;);

// these are used by ViewTemplate
config.mptwDateFormat = 'DD/MM/YY';
config.mptwJournalFormat = 'Journal DD/MM/YY';

//}}}
</pre>
</div>
<div title="MptwGreen" modifier="MPTW" created="200803062256" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwGreen
Background: #fff
Foreground: #000
PrimaryPale: #9b9
PrimaryLight: #385
PrimaryMid: #031
PrimaryDark: #020
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88

</pre>
</div>
<div title="MptwRed" modifier="MPTW" created="200803062256" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwRed
Background: #fff
Foreground: #000
PrimaryPale: #eaa
PrimaryLight: #c55
PrimaryMid: #711
PrimaryDark: #500
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88

</pre>
</div>
<div title="MptwRoundTheme" modifier="MPTW" created="200804271350" modified="200805101525" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MptwRounded|
|Description|Mptw Theme with some rounded corners (Firefox only)|
|ViewTemplate|MptwTheme##ViewTemplate|
|EditTemplate|MptwTheme##EditTemplate|
|PageTemplate|MptwTheme##PageTemplate|
|StyleSheet|##StyleSheet|

!StyleSheet
/*{{{*/

[[MptwTheme##StyleSheet]]

.tiddler,
.sliderPanel,
.button,
.tiddlyLink,
.tabContents
{ -moz-border-radius: 1em; }

.tab {
	-moz-border-radius-topleft: 0.5em;
	-moz-border-radius-topright: 0.5em;
}
#topMenu {
	-moz-border-radius-bottomleft: 2em;
	-moz-border-radius-bottomright: 2em;
}

/*}}}*/

</pre>
</div>
<div title="MptwSmoke" modifier="MPTW" created="200803062256" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwSmoke
Background: #fff
Foreground: #000
PrimaryPale: #aaa
PrimaryLight: #777
PrimaryMid: #111
PrimaryDark: #000
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88

</pre>
</div>
<div title="MptwStandardTheme" modifier="MPTW" created="200804250142" modified="200805101525" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MptwStandard|
|Description|Mptw Theme with the default TiddlyWiki PageLayout and Styles|
|ViewTemplate|MptwTheme##ViewTemplate|
|EditTemplate|MptwTheme##EditTemplate|
</pre>
</div>
<div title="MptwTeal" modifier="MPTW" created="200803062256" modified="200805101525" tags="systemPalette excludeSearch">
<pre>Name: MptwTeal
Background: #fff
Foreground: #000
PrimaryPale: #B5D1DF
PrimaryLight: #618FA9
PrimaryMid: #1a3844
PrimaryDark: #000
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #f8f8f8
TertiaryLight: #bbb
TertiaryMid: #999
TertiaryDark: #888
Error: #f88
</pre>
</div>
<div title="MptwTheme" modifier="MPTW" created="200804250140" modified="200805101525" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MptwTheme|
|Description|Mptw Theme including custom PageLayout|
|PageTemplate|##PageTemplate|
|ViewTemplate|##ViewTemplate|
|EditTemplate|##EditTemplate|
|StyleSheet|##StyleSheet|

http://mptw.tiddlyspot.com/#MptwTheme ($Rev: 1829 $)

!PageTemplate
&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
	&lt;div class='headerShadow'&gt;
		&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
		&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
	&lt;/div&gt;
	&lt;div class='headerForeground'&gt;
		&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
		&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;!-- horizontal MainMenu --&gt;
&lt;div id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;!-- original MainMenu menu --&gt;
&lt;!-- &lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt; --&gt;
&lt;div id='sidebar'&gt;
	&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
	&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
	&lt;div id='messageArea'&gt;&lt;/div&gt;
	&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!ViewTemplate
&lt;!--{{{--&gt;
[[MptwTheme##ViewTemplateToolbar]]

&lt;div class=&quot;tagglyTagged&quot; macro=&quot;tags&quot;&gt;&lt;/div&gt;

&lt;div class='titleContainer'&gt;
	&lt;span class='title' macro='view title'&gt;&lt;/span&gt;
	&lt;span macro=&quot;miniTag&quot;&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;div class='subtitle'&gt;
	(updated &lt;span macro='view modified date {{config.mptwDateFormat?config.mptwDateFormat:&quot;MM/0DD/YY&quot;}}'&gt;&lt;/span&gt;
	by &lt;span macro='view modifier link'&gt;&lt;/span&gt;)
	&lt;!--
	(&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt;
	&lt;span macro='view created date {{config.mptwDateFormat?config.mptwDateFormat:&quot;MM/0DD/YY&quot;}}'&gt;&lt;/span&gt;)
	--&gt;
&lt;/div&gt;

&lt;div macro=&quot;showWhen tiddler.tags.containsAny(['css','html','pre','systemConfig']) &amp;&amp; !tiddler.text.match('{{'+'{')&quot;&gt;
	&lt;div class='viewer'&gt;&lt;pre macro='view text'&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div macro=&quot;else&quot;&gt;
	&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;tagglyTagging&quot; macro=&quot;tagglyTagging&quot;&gt;&lt;/div&gt;

&lt;!--}}}--&gt;

!ViewTemplateToolbar
&lt;!--{{{--&gt;
&lt;div class='toolbar'&gt;
	&lt;span macro=&quot;showWhenTagged systemConfig&quot;&gt;
		&lt;span macro=&quot;toggleTag systemConfigDisable . '[[disable|systemConfigDisable]]'&quot;&gt;&lt;/span&gt;
	&lt;/span&gt;
	&lt;span macro=&quot;showWhenTagged systemTheme&quot;&gt;&lt;span macro=&quot;applyTheme&quot;&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;span macro=&quot;showWhenTagged systemPalette&quot;&gt;&lt;span macro=&quot;applyPalette&quot;&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;span macro=&quot;showWhen tiddler.tags.contains('css') || tiddler.title == 'StyleSheet'&quot;&gt;&lt;span macro=&quot;refreshAll&quot;&gt;&lt;/span&gt;&lt;/span&gt;
	&lt;span style=&quot;padding:1em;&quot;&gt;&lt;/span&gt;
	&lt;span macro='toolbar closeTiddler closeOthers +editTiddler deleteTiddler &gt; fields syncing permalink references jump'&gt;&lt;/span&gt; &lt;span macro='newHere label:&quot;new here&quot;'&gt;&lt;/span&gt;
	&lt;span macro='newJournalHere {{config.mptwJournalFormat?config.mptwJournalFormat:&quot;MM/0DD/YY&quot;}}'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!EditTemplate
&lt;!--{{{--&gt;
&lt;div class=&quot;toolbar&quot; macro=&quot;toolbar +saveTiddler saveCloseTiddler closeOthers -cancelTiddler cancelCloseTiddler deleteTiddler&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;title&quot; macro=&quot;view title&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;editLabel&quot;&gt;Title&lt;/div&gt;&lt;div class=&quot;editor&quot; macro=&quot;edit title&quot;&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class=&quot;editLabel&quot;&gt;Content&lt;/div&gt;&lt;div class=&quot;editor&quot; macro=&quot;edit text&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;editLabel&quot;&gt;Tags&lt;/div&gt;&lt;div class=&quot;editor&quot; macro=&quot;edit tags&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;editorFooter&quot;&gt;&lt;span macro=&quot;message views.editor.tagPrompt&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;tagChooser&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;

!StyleSheet
/*{{{*/

/* a contrasting background so I can see where one tiddler ends and the other begins */
body {
	background: [[ColorPalette::TertiaryLight]];
}

/* sexy colours and font for the header */
.headerForeground {
	color: [[ColorPalette::PrimaryPale]];
}
.headerShadow, .headerShadow a {
	color: [[ColorPalette::PrimaryMid]];
}

/* separate the top menu parts */
.headerForeground, .headerShadow {
	padding: 1em 1em 0;
}

.headerForeground, .headerShadow {
	font-family: 'Trebuchet MS' sans-serif;
	font-weight:bold;
}
.headerForeground .siteSubtitle {
	color: [[ColorPalette::PrimaryLight]];
}
.headerShadow .siteSubtitle {
	color: [[ColorPalette::PrimaryMid]];
}

/* make shadow go and down right instead of up and left */
.headerShadow {
	left: 1px;
	top: 1px;
}

/* prefer monospace for editing */
.editor textarea, .editor input {
	font-family: 'Consolas' monospace;
	background-color:[[ColorPalette::TertiaryPale]];
}


/* sexy tiddler titles */
.title {
	font-size: 250%;
	color: [[ColorPalette::PrimaryLight]];
	font-family: 'Trebuchet MS' sans-serif;
}

/* more subtle tiddler subtitle */
.subtitle {
	padding:0px;
	margin:0px;
	padding-left:1em;
	font-size: 90%;
	color: [[ColorPalette::TertiaryMid]];
}
.subtitle .tiddlyLink {
	color: [[ColorPalette::TertiaryMid]];
}

/* a little bit of extra whitespace */
.viewer {
	padding-bottom:3px;
}

/* don't want any background color for headings */
h1,h2,h3,h4,h5,h6 {
	background-color: transparent;
	color: [[ColorPalette::Foreground]];
}

/* give tiddlers 3d style border and explicit background */
.tiddler {
	background: [[ColorPalette::Background]];
	border-right: 2px [[ColorPalette::TertiaryMid]] solid;
	border-bottom: 2px [[ColorPalette::TertiaryMid]] solid;
	margin-bottom: 1em;
	padding:1em 2em 2em 1.5em;
}

/* make options slider look nicer */
#sidebarOptions .sliderPanel {
	border:solid 1px [[ColorPalette::PrimaryLight]];
}

/* the borders look wrong with the body background */
#sidebar .button {
	border-style: none;
}

/* this means you can put line breaks in SidebarOptions for readability */
#sidebarOptions br {
	display:none;
}
/* undo the above in OptionsPanel */
#sidebarOptions .sliderPanel br {
	display:inline;
}

/* horizontal main menu stuff */
#displayArea {
	margin: 1em 15.7em 0em 1em; /* use the freed up space */
}
#topMenu br {
	display: none;
}
#topMenu {
	background: [[ColorPalette::PrimaryMid]];
	color:[[ColorPalette::PrimaryPale]];
}
#topMenu {
	padding:2px;
}
#topMenu .button, #topMenu .tiddlyLink, #topMenu a {
	margin-left: 0.5em;
	margin-right: 0.5em;
	padding-left: 3px;
	padding-right: 3px;
	color: [[ColorPalette::PrimaryPale]];
	font-size: 115%;
}
#topMenu .button:hover, #topMenu .tiddlyLink:hover {
	background: [[ColorPalette::PrimaryDark]];
}

/* make 2.2 act like 2.1 with the invisible buttons */
.toolbar {
	visibility:hidden;
}
.selected .toolbar {
	visibility:visible;
}

/* experimental. this is a little borked in IE7 with the button 
 * borders but worth it I think for the extra screen realestate */
.toolbar { float:right; }

/* fix for TaggerPlugin. from sb56637. improved by FND */
.popup li .tagger a {
   display:inline;
}

/* makes theme selector look a little better */
#sidebarOptions .sliderPanel .select .button {
  padding:0.5em;
  display:block;
}
#sidebarOptions .sliderPanel .select br {
	display:none;
}

/* make it print a little cleaner */
@media print {
	#topMenu {
		display: none ! important;
	}
	/* not sure if we need all the importants */
	.tiddler {
		border-style: none ! important;
		margin:0px ! important;
		padding:0px ! important;
		padding-bottom:2em ! important;
	}
	.tagglyTagging .button, .tagglyTagging .hidebutton {
		display: none ! important;
	}
	.headerShadow {
		visibility: hidden ! important;
	}
	.tagglyTagged .quickopentag, .tagged .quickopentag {
		border-style: none ! important;
	}
	.quickopentag a.button, .miniTag {
		display: none ! important;
	}
}

/* get user styles specified in StyleSheet */
[[StyleSheet]]

/*}}}*/

</pre>
</div>
<div title="MptwTrimTheme" modifier="MPTW" created="200804250141" modified="200805101525" tags="systemTheme excludeSearch excludeLists">
<pre>|Name|MptwTrim|
|Description|Mptw Theme with a reduced header to increase useful space|
|ViewTemplate|MptwTheme##ViewTemplate|
|EditTemplate|MptwTheme##EditTemplate|
|StyleSheet|MptwTheme##StyleSheet|
|PageTemplate|##PageTemplate|

!PageTemplate
&lt;!--{{{--&gt;

&lt;!-- horizontal MainMenu --&gt;
&lt;div id='topMenu' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;span refresh='content' tiddler='SiteTitle' style=&quot;padding-left:1em;font-weight:bold;&quot;&gt;&lt;/span&gt;:
&lt;span refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div id='sidebar'&gt;
	&lt;div id='sidebarOptions'&gt;
		&lt;div refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
		&lt;div style=&quot;margin-left:0.1em;&quot;
			macro='slider chkTabSliderPanel SideBarTabs {{&quot;tabs \u00bb&quot;}} &quot;Show Timeline, All, Tags, etc&quot;'&gt;&lt;/div&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
	&lt;div id='messageArea'&gt;&lt;/div&gt;
	&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;

</pre>
</div>
<div title="MptwUserConfigPlugin" modifier="MPTW" created="200804250246" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Description:|A place to put your config tweaks so they aren't overwritten when you upgrade MPTW|
See http://www.tiddlywiki.org/wiki/Configuration_Options for other options you can set. In some cases where there are clashes with other plugins it might help to rename this to zzMptwUserConfigPlugin so it gets executed last.
***/
//{{{

// example: set your preferred date format
//config.mptwDateFormat = 'MM/0DD/YY';
//config.mptwJournalFormat = 'Journal MM/0DD/YY';

// example: set the theme you want to start with
//config.options.txtTheme = 'MptwRoundTheme';

// example: switch off autosave, switch on backups and set a backup folder
//config.options.chkSaveBackups = true;
//config.options.chkAutoSave = false;
//config.options.txtBackupFolder = 'backups';

//}}}
</pre>
</div>
<div title="NameDashboards" modifier="YourName" created="200805061401" modified="200805221358" tags="excludeSearch">
<pre></pre>
</div>
<div title="NewButtons" modifier="YourName" created="200805211442" modified="200805221358" tags="excludeSearch">
<pre>&lt;&lt;newSavedTiddler title:'New Action' label:'+ action' tag:{{'Action Next [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;
&lt;&lt;newSavedTiddler title:'New Project' label:'+ project' tag:{{'Project Active [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;
&lt;&lt;newSavedTiddler title:'New Tickler' label:'+ tickler' tag:{{'Tickler Once [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;
&lt;slider quick add&gt;
&lt;&lt;processInbox&gt;&gt;
&lt;/slider&gt;
</pre>
</div>
<div title="NewHerePlugin" modifier="MPTW" created="200803080053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|NewHerePlugin|
|Description:|Creates the new here and new journal macros|
|Version:|3.0 ($Rev: 3861 $)|
|Date:|$Date: 2008-03-08 10:53:09 +1000 (Sat, 08 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#NewHerePlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License|http://mptw.tiddlyspot.com/#TheBSDLicense|
***/
//{{{
merge(config.macros, {
	newHere: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			wikify(&quot;&lt;&lt;newTiddler &quot;+paramString+&quot; tag:[[&quot;+tiddler.title+&quot;]]&gt;&gt;&quot;,place,null,tiddler);
		}
	},
	newJournalHere: {
		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			wikify(&quot;&lt;&lt;newJournal &quot;+paramString+&quot; tag:[[&quot;+tiddler.title+&quot;]]&gt;&gt;&quot;,place,null,tiddler);
		}
	}
});

//}}}

</pre>
</div>
<div title="NewMeansNewPlugin" modifier="MPTW" created="200804091514" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|NewMeansNewPlugin|
|Description:|If 'New Tiddler' already exists then create 'New Tiddler (1)' and so on|
|Version:|1.1 ($Rev: 2263 $)|
|Date:|$Date: 2007-06-13 04:22:32 +1000 (Wed, 13 Jun 2007) $|
|Source:|http://mptw.tiddlyspot.com/empty.html#NewMeansNewPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License|http://mptw.tiddlyspot.com/#TheBSDLicense|
!!Note: I think this should be in the core
***/
//{{{

String.prototype.getNextFreeName = function() {
       var numberRegExp = / \(([0-9]+)\)$/;
       var match = numberRegExp.exec(this);
       if (match) {
               var num = parseInt(match[1]) + 1;
               return this.replace(numberRegExp,&quot; (&quot;+num+&quot;)&quot;);
       }
       else {
               return this + &quot; (1)&quot;;
       }
}

config.macros.newTiddler.checkForUnsaved = function(newName) {
	var r = false;
	story.forEachTiddler(function(title,element) {
		if (title == newName)
			r = true;
	});
	return r;
}

config.macros.newTiddler.getName = function(newName) {
       while (store.getTiddler(newName) || config.macros.newTiddler.checkForUnsaved(newName))
               newName = newName.getNextFreeName();
       return newName;
}


config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute(&quot;newTitle&quot;);
	if(this.getAttribute(&quot;isJournal&quot;) == &quot;true&quot;) {
		var now = new Date();
		title = now.formatString(title.trim());
	}

	title = config.macros.newTiddler.getName(title); // &lt;--- only changed bit

	var params = this.getAttribute(&quot;params&quot;);
	var tags = params ? params.split(&quot;|&quot;) : [];
	var focus = this.getAttribute(&quot;newFocus&quot;);
	var template = this.getAttribute(&quot;newTemplate&quot;);
	var customFields = this.getAttribute(&quot;customFields&quot;);
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = document.getElementById(story.idPrefix + title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute(&quot;newText&quot;);
	if(typeof text == &quot;string&quot;)
		story.getTiddlerField(title,&quot;text&quot;).value = text.format([title]);
	for(var t=0;t&lt;tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

//}}}

</pre>
</div>
<div title="NewSavedTiddlerPlugin" modifier="YourName" created="200803171302" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>config.macros.newSavedTiddler={};
config.macros.newSavedTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	if(readOnly){
		return false;
	}
	var p = paramString.parseParams(&quot;anon&quot;,null,true,false,false);
	var label = getParam(p,&quot;label&quot;,&quot;NewSavedTiddler&quot;);
	var tooltip = getParam(p,&quot;tooltip&quot;,&quot;Create a new saved tiddler&quot;);
	var btn = createTiddlyButton(place,label,tooltip,this.onClick);
	btn.params = paramString;
	return false;
};

config.macros.newSavedTiddler.onClick = function(e) {
	var p = this.params.parseParams(&quot;anon&quot;,null,true,false,false);
	var titlePrompt = getParam(p,&quot;prompt&quot;,&quot;Enter the title for the new tiddler:&quot;);
	var title = prompt(titlePrompt,&quot;&quot;);
	if(title){
		title = config.macros.newTiddler.getName(title); // from NewMeansNewPlugin
		var text = getParam(p,&quot;text&quot;,&quot;&quot;);
		var tags = getParam(p,&quot;tag&quot;,&quot;&quot;);
		var fields = getParam(p,&quot;fields&quot;,&quot;&quot;).decodeHashMap();
        tags = tags.replace(/\[\(/g,'[[');
        tags = tags.replace(/\)\]/g,']]');
		store.saveTiddler(title,title,text,config.options.txtUserName,new Date(),tags,fields);
		story.displayTiddler(this,title);
		return false;
	}
}

</pre>
</div>
<div title="Next" modifier="YourName" created="200805221358" modified="200805221358" tags="ActionStatus">
<pre>order:1
button:n
buttonLong:next
</pre>
</div>
<div title="Next Actions" modifier="YourName" created="200805021244" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList title:'Next Actions' startTag:Action tags:'Next &amp;&amp; !Done' view:ActionProj mode:global
	where:tiddler.hasActiveProject()
	newButtonTags:'Action Next'
&gt;&gt;
</pre>
</div>
<div title="Next Actions by Context" modifier="YourName" created="200805021244" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList title:'Next Actions by Context' startTag:Action tags:'Next &amp;&amp; !Done' view:ActionProj mode:global
	group:Context
	newButtonTags:'Action Next'
	where:tiddler.hasActiveProject()
&gt;&gt;
</pre>
</div>
<div title="Next Actions by Project" modifier="YourName" created="200805021244" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList startTag:Action tags:'Next &amp;&amp; !Done' view:Action mode:global
	group:Project
	gView:bold
	newButtonTags:'Action Next'
	where:tiddler.hasActiveProject()
	&gt;&gt;
</pre>
</div>
<div title="Next and Waiting Actions" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols2{

{{col{

&lt;&lt;mgtdList startTag:Action title:'Next' tags:'Next &amp;&amp; !Done' view:ActionProj mode:global
	newButtonTags:'Action Next'
	where:tiddler.hasActiveProject()
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList startTag:Action title:'Waiting' tags:'[(Waiting For)] &amp;&amp; !Done' view:ActionProj mode:global
	newButtonTags:'Action [(Waiting For)]'
	where:tiddler.hasActiveProject()
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="Next and Waiting Actions by Context" modifier="YourName" created="200805221243" modified="200805221358" tags="View excludeSearch">
<pre>{{cols2{

{{col{

&lt;&lt;mgtdList startTag:Action title:'Next' tags:'Next &amp;&amp; !Done' view:ActionProj mode:global
	group:Context
	gView:Context
	newButtonTags:'Action Next'
	where:tiddler.hasActiveProject()
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList startTag:Action title:'Waiting' tags:'[(Waiting For)] &amp;&amp; !Done' view:ActionProj mode:global
	group:Context
	gView:Context
	newButtonTags:'Action [(Waiting For)]'
	where:tiddler.hasActiveProject()
	&gt;&gt;


}}}

}}}
</pre>
</div>
<div title="Next and Waiting Actions by Project" modifier="YourName" created="200805221244" modified="200805221358" tags="View excludeSearch">
<pre>{{cols2{

{{col{

&lt;&lt;mgtdList startTag:Action title:'Next' tags:'Next &amp;&amp; !Done' view:Action mode:global
	group:Project
	gView:bold
	newButtonTags:'Action Next'
	where:tiddler.hasActiveProject()
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList startTag:Action title:'Waiting' tags:'[(Waiting For)] &amp;&amp; !Done' view:Action mode:global
	group:Project
	gView:bold
	where:tiddler.hasActiveProject()
	newButtonTags:'Action [(Waiting For)]'
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="Once" modifier="YourName" created="200805221358" modified="200805221358" tags="TicklerRepeatType">
<pre>order:1
button:none
buttonLong:one time
</pre>
</div>
<div title="Personal" modifier="YourName" created="200805221358" modified="200805221358" tags="Realm">
<pre>order:2
priority:2</pre>
</div>
<div title="PrettyDatesPlugin" modifier="MPTW" created="200803080025" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|PrettyDatesPlugin|
|Description:|Provides a new date format ('pppp') that displays times such as '2 days ago'|
|Version:|1.0 ($Rev: 3646 $)|
|Date:|$Date: 2008-02-27 02:34:38 +1000 (Wed, 27 Feb 2008) $|
|Source:|http://mptw.tiddlyspot.com/#PrettyDatesPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
!!Notes
* If you want to you can rename this plugin. :) Some suggestions: LastUpdatedPlugin, RelativeDatesPlugin, SmartDatesPlugin, SexyDatesPlugin.
* Inspired by http://ejohn.org/files/pretty.js
***/
//{{{
Date.prototype.prettyDate = function() {
	var diff = (((new Date()).getTime() - this.getTime()) / 1000);
	var day_diff = Math.floor(diff / 86400);

	if (isNaN(day_diff))      return &quot;&quot;;
	else if (diff &lt; 0)        return &quot;in the future&quot;;
	else if (diff &lt; 60)       return &quot;just now&quot;;
	else if (diff &lt; 120)      return &quot;1 minute ago&quot;;
	else if (diff &lt; 3600)     return Math.floor(diff/60) + &quot; minutes ago&quot;;
	else if (diff &lt; 7200)     return &quot;1 hour ago&quot;;
	else if (diff &lt; 86400)    return Math.floor(diff/3600) + &quot; hours ago&quot;;
	else if (day_diff == 1)   return &quot;Yesterday&quot;;
	else if (day_diff &lt; 7)    return day_diff + &quot; days ago&quot;;
	else if (day_diff &lt; 14)   return  &quot;a week ago&quot;;
	else if (day_diff &lt; 31)   return Math.ceil(day_diff/7) + &quot; weeks ago&quot;;
	else if (day_diff &lt; 62)   return &quot;a month ago&quot;;
	else if (day_diff &lt; 365)  return &quot;about &quot; + Math.ceil(day_diff/31) + &quot; months ago&quot;;
	else if (day_diff &lt; 730)  return &quot;a year ago&quot;;
	else                      return Math.ceil(day_diff/365) + &quot; years ago&quot;;
}

Date.prototype.formatString_orig_mptw = Date.prototype.formatString;

Date.prototype.formatString = function(template) {
	return this.formatString_orig_mptw(template).replace(/pppp/,this.prettyDate());
}

// for MPTW. otherwise edit your ViewTemplate as required.
// config.mptwDateFormat = 'pppp (DD/MM/YY)'; 
config.mptwDateFormat = 'pppp'; 

//}}}

</pre>
</div>
<div title="ProcessInboxMenu" modifier="YourName" created="200805211433" modified="200805221358" tags="excludeSearch">
<pre>[[Quick Add]]
''&lt;&lt;newSavedTiddler label:'new next action' tag:{{'Action Next [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%/%
%/&lt;&lt;newSavedTiddler label:'new waiting action' tag:{{'Action [(Waiting For)] [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new future action' tag:{{'Action Future [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new active project' tag:{{'Project Active [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new someday project' tag:{{'Project Someday/Maybe [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new tickler' tag:{{'Tickler Once [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new contact' tag:{{'Contact [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new context' tag:{{'Context [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new area' tag:{{'Area [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;/%
%/&lt;&lt;newSavedTiddler label:'new realm' tag:{{'Realm [['+config.macros.mgtdList.getRealm()+']]'}}&gt;&gt;''
!!Recent
&lt;&lt;mgtdList mode:global tags:'Project || Action' view:plain sort:-modified &gt;&gt;
</pre>
</div>
<div title="Project" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Projects Dashboard" modifier="YourName" created="200805221244" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

&lt;&lt;mgtdList title:'Active Projects' startTag:Project tags:'Active &amp;&amp; !Complete' view:ProjectArea mode:global
	newButtonTags:'Project Active'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Someday/Maybe Projects' startTag:Project tags:'Someday/Maybe &amp;&amp; !Complete' view:ProjectArea mode:global
	newButtonTags:'Project Someday/Maybe'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Completed Projects' startTag:Project tags:'Complete' view:ProjectComplete mode:global&gt;&gt;


}}}

}}}
</pre>
</div>
<div title="Projects Dashboard by Area" modifier="YourName" created="200805221244" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

&lt;&lt;mgtdList title:'Active Projects' startTag:Project tags:'Active &amp;&amp; !Complete' view:Project mode:global
	group:Area
	gView:bold
	newButtonTags:'Project Active'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Someday/Maybe Projects' startTag:Project tags:'Someday/Maybe &amp;&amp; !Complete' view:Project mode:global
	group:Area
	gView:bold
	newButtonTags:'Project Someday/Maybe'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Completed Projects' startTag:Project tags:'Complete' view:ProjectComplete mode:global
	group:Area
	gView:bold
	newButtonTags:'Project Active Complete'
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="Quick Add" modifier="YourName" created="200805021305" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;processInbox&gt;&gt;
</pre>
</div>
<div title="QuickOpenTagPlugin" modifier="MPTW" created="200803080053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|QuickOpenTagPlugin|
|Description:|Changes tag links to make it easier to open tags as tiddlers|
|Version:|3.0.1 ($Rev: 3861 $)|
|Date:|$Date: 2008-03-08 10:53:09 +1000 (Sat, 08 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#QuickOpenTagPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
***/
//{{{
config.quickOpenTag = {

	dropdownChar: (document.all ? &quot;\u25bc&quot; : &quot;\u25be&quot;), // the little one doesn't work in IE?

	createTagButton: function(place,tag,excludeTiddler) {
		// little hack so we can do this: &lt;&lt;tag PrettyTagName|RealTagName&gt;&gt;
		var splitTag = tag.split(&quot;|&quot;);
		var pretty = tag;
		if (splitTag.length == 2) {
			tag = splitTag[1];
			pretty = splitTag[0];
		}
		
		var sp = createTiddlyElement(place,&quot;span&quot;,null,&quot;quickopentag&quot;);
		createTiddlyText(createTiddlyLink(sp,tag,false),pretty);
		
		var theTag = createTiddlyButton(sp,config.quickOpenTag.dropdownChar,
                        config.views.wikified.tag.tooltip.format([tag]),onClickTag);
		theTag.setAttribute(&quot;tag&quot;,tag);
		if (excludeTiddler)
			theTag.setAttribute(&quot;tiddler&quot;,excludeTiddler);
    		return(theTag);
	},

	miniTagHandler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var tagged = store.getTaggedTiddlers(tiddler.title);
		if (tagged.length &gt; 0) {
			var theTag = createTiddlyButton(place,config.quickOpenTag.dropdownChar,
                        	config.views.wikified.tag.tooltip.format([tiddler.title]),onClickTag);
			theTag.setAttribute(&quot;tag&quot;,tiddler.title);
			theTag.className = &quot;miniTag&quot;;
		}
	},

	allTagsHandler: function(place,macroName,params) {
		var tags = store.getTags(params[0]);
		var filter = params[1]; // new feature
		var ul = createTiddlyElement(place,&quot;ul&quot;);
		if(tags.length == 0)
			createTiddlyElement(ul,&quot;li&quot;,null,&quot;listTitle&quot;,this.noTags);
		for(var t=0; t&lt;tags.length; t++) {
			var title = tags[t][0];
			if (!filter || (title.match(new RegExp('^'+filter)))) {
				var info = getTiddlyLinkInfo(title);
				var theListItem =createTiddlyElement(ul,&quot;li&quot;);
				var theLink = createTiddlyLink(theListItem,tags[t][0],true);
				var theCount = &quot; (&quot; + tags[t][1] + &quot;)&quot;;
				theLink.appendChild(document.createTextNode(theCount));
				var theDropDownBtn = createTiddlyButton(theListItem,&quot; &quot; +
					config.quickOpenTag.dropdownChar,this.tooltip.format([tags[t][0]]),onClickTag);
				theDropDownBtn.setAttribute(&quot;tag&quot;,tags[t][0]);
			}
		}
	},

	// todo fix these up a bit
	styles: [
&quot;/*{{{*/&quot;,
&quot;/* created by QuickOpenTagPlugin */&quot;,
&quot;.tagglyTagged .quickopentag, .tagged .quickopentag &quot;,
&quot;	{ margin-right:1.2em; border:1px solid #eee; padding:2px; padding-right:0px; padding-left:1px; }&quot;,
&quot;.quickopentag .tiddlyLink { padding:2px; padding-left:3px; }&quot;,
&quot;.quickopentag a.button { padding:1px; padding-left:2px; padding-right:2px;}&quot;,
&quot;/* extra specificity to make it work right */&quot;,
&quot;#displayArea .viewer .quickopentag a.button, &quot;,
&quot;#displayArea .viewer .quickopentag a.tiddyLink, &quot;,
&quot;#mainMenu .quickopentag a.tiddyLink, &quot;,
&quot;#mainMenu .quickopentag a.tiddyLink &quot;,
&quot;	{ border:0px solid black; }&quot;,
&quot;#displayArea .viewer .quickopentag a.button, &quot;,
&quot;#mainMenu .quickopentag a.button &quot;,
&quot;	{ margin-left:0px; padding-left:2px; }&quot;,
&quot;#displayArea .viewer .quickopentag a.tiddlyLink, &quot;,
&quot;#mainMenu .quickopentag a.tiddlyLink &quot;,
&quot;	{ margin-right:0px; padding-right:0px; padding-left:0px; margin-left:0px; }&quot;,
&quot;a.miniTag {font-size:150%;} &quot;,
&quot;#mainMenu .quickopentag a.button &quot;,
&quot;	/* looks better in right justified main menus */&quot;,
&quot;	{ margin-left:0px; padding-left:2px; margin-right:0px; padding-right:0px; }&quot;, 
&quot;#topMenu .quickopentag { padding:0px; margin:0px; border:0px; }&quot;,
&quot;#topMenu .quickopentag .tiddlyLink { padding-right:1px; margin-right:0px; }&quot;,
&quot;#topMenu .quickopentag .button { padding-left:1px; margin-left:0px; border:0px; }&quot;,
&quot;/*}}}*/&quot;,
		&quot;&quot;].join(&quot;\n&quot;),

	init: function() {
		// we fully replace these builtins. can't hijack them easily
		window.createTagButton = this.createTagButton;
		config.macros.allTags.handler = this.allTagsHandler;
		config.macros.miniTag = { handler: this.miniTagHandler };
		config.shadowTiddlers[&quot;QuickOpenTagStyles&quot;] = this.styles;
		store.addNotification(&quot;QuickOpenTagStyles&quot;,refreshStyles);
	}
}

config.quickOpenTag.init();

//}}}

</pre>
</div>
<div title="Reference" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Reference Items" modifier="YourName" created="200805221244" modified="200805221358" tags="View excludeSearch">
<pre>{{cols2{

{{col{

&lt;&lt;mgtdList title:'Reference Items For Active Project' tag:Reference startTag:Reference view:plain mode:global
	group:Project
	gView:bold
	newButtonTags:'Reference'
	where:tiddler.hasActiveProject()
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Other Reference Items' tag:Reference startTag:Reference view:plain mode:global
	group:Project
	gView:bold
	newButtonTags:'Reference'
	where:!tiddler.hasActiveProject()
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="RenameTagsPlugin" modifier="MPTW" created="200803080053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|RenameTagsPlugin|
|Description:|Allows you to easily rename or delete tags across multiple tiddlers|
|Version:|3.0 ($Rev: 3861 $)|
|Date:|$Date: 2008-03-08 10:53:09 +1000 (Sat, 08 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#RenameTagsPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License|http://mptw.tiddlyspot.com/#TheBSDLicense|
Rename a tag and you will be prompted to rename it in all its tagged tiddlers.
***/
//{{{
config.renameTags = {

	prompts: {
		rename: &quot;Rename the tag '%0' to '%1' in %2 tidder%3?&quot;,
		remove: &quot;Remove the tag '%0' from %1 tidder%2?&quot;
	},

	removeTag: function(tag,tiddlers) {
		store.suspendNotifications();
		for (var i=0;i&lt;tiddlers.length;i++) {
			store.setTiddlerTag(tiddlers[i].title,false,tag);
		}
		store.resumeNotifications();
		store.notifyAll();
	},

	renameTag: function(oldTag,newTag,tiddlers) {
		store.suspendNotifications();
		for (var i=0;i&lt;tiddlers.length;i++) {
			store.setTiddlerTag(tiddlers[i].title,false,oldTag); // remove old
			store.setTiddlerTag(tiddlers[i].title,true,newTag);  // add new
		}
		store.resumeNotifications();
		store.notifyAll();
	},

	storeMethods: {

		saveTiddler_orig_renameTags: TiddlyWiki.prototype.saveTiddler,

		saveTiddler: function(title,newTitle,newBody,modifier,modified,tags,fields) {
			if (title != newTitle) {
				var tagged = this.getTaggedTiddlers(title);
				if (tagged.length &gt; 0) {
					// then we are renaming a tag
					if (confirm(config.renameTags.prompts.rename.format([title,newTitle,tagged.length,tagged.length&gt;1?&quot;s&quot;:&quot;&quot;])))
						config.renameTags.renameTag(title,newTitle,tagged);

					if (!this.tiddlerExists(title) &amp;&amp; newBody == &quot;&quot;)
						// dont create unwanted tiddler
						return null;
				}
			}
			return this.saveTiddler_orig_renameTags(title,newTitle,newBody,modifier,modified,tags,fields);
		},

		removeTiddler_orig_renameTags: TiddlyWiki.prototype.removeTiddler,

		removeTiddler: function(title) {
			var tagged = this.getTaggedTiddlers(title);
			if (tagged.length &gt; 0)
				if (confirm(config.renameTags.prompts.remove.format([title,tagged.length,tagged.length&gt;1?&quot;s&quot;:&quot;&quot;])))
					config.renameTags.removeTag(title,tagged);
			return this.removeTiddler_orig_renameTags(title);
		}

	},

	init: function() {
		merge(TiddlyWiki.prototype,this.storeMethods);
	}
}

config.renameTags.init();

//}}}

</pre>
</div>
<div title="Root project" modifier="YourName" created="200805252134" modified="200805261214" tags="Project Active Personal Никто Основное" changecount="9">
<pre></pre>
</div>
<div title="SaveCloseTiddlerPlugin" modifier="MPTW" created="200803080053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|SaveCloseTiddlerPlugin|
|Description:|Provides two extra toolbar commands, saveCloseTiddler and cancelCloseTiddler|
|Version:|3.0 ($Rev: 3861 $)|
|Date:|$Date: 2008-03-08 10:53:09 +1000 (Sat, 08 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#SaveCloseTiddlerPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
To use these you must add them to the tool bar in your EditTemplate
***/
//{{{
merge(config.commands,{

	saveCloseTiddler: {
		text: 'done/close',
		tooltip: 'Save changes to this tiddler and close it',
		handler: function(e,src,title) {
			config.commands.saveTiddler.handler(e,src,title);
			config.commands.closeTiddler.handler(e,src,title);
			return false;
		}
	},

	cancelCloseTiddler: {
		text: 'cancel/close',
		tooltip: 'Undo changes to this tiddler and close it',
		handler: function(e,src,title) {
			config.commands.cancelTiddler.handler(e,src,title);
			config.commands.closeTiddler.handler(e,src,title);
			return false;
		}
	}

});

//}}}

</pre>
</div>
<div title="SelectThemePlugin" modifier="MPTW" created="200803121559" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|SelectThemePlugin|
|Description:|Lets you easily switch theme and palette|
|Version:|1.0 ($Rev: 3646 $)|
|Date:|$Date: 2008-02-27 02:34:38 +1000 (Wed, 27 Feb 2008) $|
|Source:|http://mptw.tiddlyspot.com/#SelectThemePlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
!Notes
* Borrows largely from ThemeSwitcherPlugin by Martin Budden http://www.martinswiki.com/#ThemeSwitcherPlugin
* Theme is cookie based. But set a default by setting config.options.txtTheme in MptwConfigPlugin (for example)
* Palette is not cookie based. It actually overwrites your ColorPalette tiddler when you select a palette, so beware. 
!Usage
* {{{&lt;&lt;selectTheme&gt;&gt;}}} makes a dropdown selector
* {{{&lt;&lt;selectPalette&gt;&gt;}}} makes a dropdown selector
* {{{&lt;&lt;applyTheme&gt;&gt;}}} applies the current tiddler as a theme
* {{{&lt;&lt;applyPalette&gt;&gt;}}} applies the current tiddler as a palette
* {{{&lt;&lt;applyTheme TiddlerName&gt;&gt;}}} applies TiddlerName as a theme
* {{{&lt;&lt;applyPalette TiddlerName&gt;&gt;}}} applies TiddlerName as a palette
***/
//{{{

config.macros.selectTheme = {
	label: {
      		selectTheme:&quot;select theme&quot;,
      		selectPalette:&quot;select palette&quot;
	},
	prompt: {
		selectTheme:&quot;Select the current theme&quot;,
		selectPalette:&quot;Select the current palette&quot;
	},
	tags: {
		selectTheme:'systemTheme',
		selectPalette:'systemPalette'
	}
};

config.macros.selectTheme.handler = function(place,macroName)
{
	var btn = createTiddlyButton(place,this.label[macroName],this.prompt[macroName],this.onClick);
	// want to handle palettes and themes with same code. use mode attribute to distinguish
	btn.setAttribute('mode',macroName);
};

config.macros.selectTheme.onClick = function(ev)
{
	var e = ev ? ev : window.event;
	var popup = Popup.create(this);
	var mode = this.getAttribute('mode');
	var tiddlers = store.getTaggedTiddlers(config.macros.selectTheme.tags[mode]);
	// for default
	if (mode == &quot;selectPalette&quot;) {
		var btn = createTiddlyButton(createTiddlyElement(popup,'li'),&quot;(default)&quot;,&quot;default color palette&quot;,config.macros.selectTheme.onClickTheme);
		btn.setAttribute('theme',&quot;(default)&quot;);
		btn.setAttribute('mode',mode);
	}
	for(var i=0; i&lt;tiddlers.length; i++) {
		var t = tiddlers[i].title;
		var name = store.getTiddlerSlice(t,'Name');
		var desc = store.getTiddlerSlice(t,'Description');
		var btn = createTiddlyButton(createTiddlyElement(popup,'li'),name ? name : title,desc ? desc : config.macros.selectTheme.label['mode'],config.macros.selectTheme.onClickTheme);
		btn.setAttribute('theme',t);
		btn.setAttribute('mode',mode);
	}
	Popup.show();
	return stopEvent(e);
};

config.macros.selectTheme.onClickTheme = function(ev)
{
	var mode = this.getAttribute('mode');
	var theme = this.getAttribute('theme');
	if (mode == 'selectTheme')
		story.switchTheme(theme);
	else // selectPalette
		config.macros.selectTheme.updatePalette(theme);
	return false;
};

config.macros.selectTheme.updatePalette = function(title)
{
	if (title != &quot;&quot;) {
		store.deleteTiddler(&quot;ColorPalette&quot;);
		if (title != &quot;(default)&quot;)
			store.saveTiddler(&quot;ColorPalette&quot;,&quot;ColorPalette&quot;,store.getTiddlerText(title),
					config.options.txtUserName,undefined,&quot;&quot;);
		refreshAll();
		if(config.options.chkAutoSave)
			saveChanges(true);
	}
};

config.macros.applyTheme = {
	label: &quot;apply&quot;,
	prompt: &quot;apply this theme or palette&quot; // i'm lazy
};

config.macros.applyTheme.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	var useTiddler = params[0] ? params[0] : tiddler.title;
	var btn = createTiddlyButton(place,this.label,this.prompt,config.macros.selectTheme.onClickTheme);
	btn.setAttribute('theme',useTiddler);
	btn.setAttribute('mode',macroName==&quot;applyTheme&quot;?&quot;selectTheme&quot;:&quot;selectPalette&quot;); // a bit untidy here
}

config.macros.selectPalette = config.macros.selectTheme;
config.macros.applyPalette = config.macros.applyTheme;

config.macros.refreshAll = { handler: function(place,macroName,params,wikifier,paramString,tiddler) {
	createTiddlyButton(place,&quot;refresh&quot;,&quot;refresh layout and styles&quot;,function() { refreshAll(); });
}};

//}}}

</pre>
</div>
<div title="Someday/Maybe" modifier="YourName" created="200805221358" modified="200805221358" tags="ProjectStatus">
<pre>order:2
button:s/m
buttonLong:someday/maybe
</pre>
</div>
<div title="Starred" modifier="YourName" created="200805221358" modified="200805221358">
<pre></pre>
</div>
<div title="Starred Items" modifier="YourName" created="200805221244" modified="200805221358" tags="View excludeSearch">
<pre>{{cols3{

{{col{

&lt;&lt;mgtdList title:'Starred Actions' startTag:Starred tags:'Action &amp;&amp; !Done' view:ActionProj mode:global
	group:ActionStatus
	gView:bold
	newButtonTags:'Starred Action'
	&gt;&gt;

&lt;&lt;mgtdList title:'Starred Done Actions' startTag:Starred tags:'Done' view:DoneAction mode:global
	newButtonTags:'Starred Action Done'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Starred Projects' startTag:Starred tags:'Project &amp;&amp; !Complete' view:Project mode:global
	group:ProjectStatus
	gView:bold
	newButtonTags:'Starred Project'
	&gt;&gt;

&lt;&lt;mgtdList title:'Completed Projects' startTag:Starred tags:'Project &amp;&amp; Complete' view:ProjectComplete mode:global
	newButtonTags:'Starred Project Complete'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Other Starred Items' startTag:Starred tags:'!Project &amp;&amp; !Action' view:star mode:global
	group:GTDComponent
	gView:bold
	newButtonTags:'Starred'
	&gt;&gt;

}}}

}}}
</pre>
</div>
<div title="Starred Next Actions" modifier="YourName" created="200805090858" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList title:'Starred Next Actions by Context' startTag:Action tags:'Next &amp;&amp; !Done &amp;&amp; Starred' view:ActionProj mode:global
	group:Context
	newButtonTags:'Action Next Starred'
	where:tiddler.hasActiveProject()
&gt;&gt;
</pre>
</div>
<div title="StyleSheetDatePicker" modifier="YourName" created="200804090307" modified="200805221358" tags="css excludeSearch">
<pre>table#datePickerTable td.datePickerNav {
    cursor:pointer;
}

.datePickerDaysHeader td {
    text-align:center;
    background:#ABABAB;
    font:100% Arial;
}

/*
.datePickerDayRow td {
    width:18px;
    height:18px;
}
*/

td#datePickerMNS, td.datePickerNav {
    font-weight:bold;
}

table#datePickerTable {
    position:absolute;
    /* border-collapse:collapse; */
    background:#FFFFFF;
    border:1px solid #000;
    display:none;   
}

table#datePickerTable td {
    padding: 3px;
}

td#datePickerMNS {
    text-align: center;
}

tr.datePickerDayRow td {
    background-color : #FFF;
    cursor : pointer;
    border : 1px solid #FFF;
    text-align : center;
	font-size:100%;
}

tr.datePickerDayRow td.defaultDate {
	color : #000;	
	text-decoration : none;   
}

tr.datePickerDayRow td.emptyDate {
    cursor:default; 
}

tr.datePickerDayRow td.oldDate {
	color : #ABABAB;
    text-decoration : line-through;
}

tr.datePickerDayRow td.highlightedDate {
    background : #FFF;
	font-weight : bold;
	color : #F66;
	border:1px solid #999;
}

tr.datePickerDayRow td.todayDate {
	font-weight : bold;
	color : red;
}

table#datePickerTable tr.datePickerDayRow td.tdover {
    background:#fc6;
}

</pre>
</div>
<div title="Subprojects" modifier="YourName" created="200805211136" modified="200805221358" tags="View excludeSearch">
<pre>This isn't very good but it might be of some use. It's the best attempt we have at showing a list of subprojects.
&lt;&lt;mgtdList title:'Subprojects' startTag:Project tags:'Project &amp;&amp; !Complete' view:Project mode:global
	where:tiddler.getByIndex('Project').length&gt;0
	group:Project
	gView:bold
	newButtonTags:'Project Active'
	leftoverTitle:'(Projects that aren't subprojects)
	&gt;&gt;
</pre>
</div>
<div title="TWSideBar" modifier="YourName" created="200804280851" modified="200805221358" tags="excludeSearch">
<pre>&lt;&lt;tiddler SideBarOptions&gt;&gt;
&lt;&lt;tiddler SideBarTabs&gt;&gt;
</pre>
</div>
<div title="TabAllTags" modifier="MPTW" created="200802220317" modified="200805101525" tags="excludeSearch">
<pre>&lt;&lt;allTags excludeLists&gt;&gt;
</pre>
</div>
<div title="TabMore" modifier="YourName" created="200802220317" modified="200805261200" tags="excludeSearch" changecount="1">
<pre>&lt;&lt;tabs txtMoreTab &quot;Tags&quot; &quot;All Tags&quot; TabAllTags &quot;Miss&quot; &quot;Missing tiddlers&quot; TabMoreMissing &quot;Orph&quot; &quot;Orphaned tiddlers&quot; TabMoreOrphans &quot;Shad&quot; &quot;Shadowed tiddlers&quot; TabMoreShadowed&gt;&gt;
</pre>
</div>
<div title="TabTags" modifier="MPTW" created="200802220317" modified="200805101525" tags="excludeSearch">
<pre>&lt;&lt;allTags excludeLists [a-z]&gt;&gt;
</pre>
</div>
<div title="TagDashboards" modifier="YourName" created="200805221244" modified="200805221358" tags="excludeSearch">
<pre>!Project
&lt;!--{{{--&gt;
&lt;div class=&quot;cols3&quot;&gt;

&lt;div class=&quot;col&quot;&gt;

	[[TagDashboards##Ticklers Requiring Action]]

	&lt;div macro=&quot;mgtdList title:'Next Actions' tags:'Action &amp;&amp; Next &amp;&amp; !Done' view:Action
		ignoreRealm:yes
		group:Context
		gView:Context
		newButtonTags:'Action Next'
		&quot;&gt;&lt;/div&gt;

	&lt;!-- was this:
		group:Context
		gView:Context
	--&gt;
	&lt;div macro=&quot;mgtdList title:'Waiting Actions by Person' tags:'Action &amp;&amp; [(Waiting For)] &amp;&amp; !Done' view:Action
		ignoreRealm:yes
		group:Contact
		gView:bold
		newButtonTags:'Action [(Waiting For)]'
		&quot;&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;div class=&quot;col&quot;&gt;

	&lt;div macro=&quot;mgtdList title:'Active Subprojects' tags:'Project &amp;&amp; !Complete' view:Project
		ignoreRealm:yes
		group:ProjectStatus
		gView:bold
		newButtonTags:'Project'
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Completed Subprojects' tags:'Project &amp;&amp; Complete' view:ProjectComplete
		ignoreRealm:yes
		newButtonTags:'Project Active Complete'
		dontShowEmpty:yes
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Future Actions' tags:'Action &amp;&amp; Future &amp;&amp; !Done' view:Action
		ignoreRealm:yes
		group:Context
		gView:Context
		newButtonTags:'Action Future'
		&quot;&gt;&lt;/div&gt;


&lt;/div&gt;
&lt;div class=&quot;col&quot;&gt;

	[[TagDashboards##Upcoming Ticklers]]

	&lt;div macro=&quot;mgtdList title:'Reference Items' tags:'Reference' view:plain newButtonTags:'Reference' 
		ignoreRealm:yes
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Done Actions' tags:'Action &amp;&amp; Done' view:DoneAction
		ignoreRealm:yes
		newButtonTags:'Action Done Next'
		dontShowEmpty:yes
		sort:-modified
		&quot;&gt;&lt;/div&gt;

&lt;/div&gt;

&lt;/div&gt;
&lt;!--}}}--&gt;


!Context
&lt;!--{{{--&gt;
&lt;div class=&quot;cols2&quot;&gt;

&lt;div class=&quot;col&quot;&gt;

	&lt;div macro=&quot;mgtdList title:'Next' tags:'Action &amp;&amp; Next &amp;&amp; !Done' view:ActionProj
		where:tiddler.hasActiveProject()
		&quot;&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;div class=&quot;col&quot;&gt;

	&lt;div macro=&quot;mgtdList title:'Waiting' tags:'Action &amp;&amp; [(Waiting For)] &amp;&amp; !Done' view:ActionProj
		where:tiddler.hasActiveProject()
		&quot;&gt;&lt;/div&gt;

&lt;/div&gt;

&lt;/div&gt;
&lt;!--}}}--&gt;


!Contact
&lt;!--{{{--&gt;
&lt;div class=&quot;cols2&quot;&gt;

&lt;div class=&quot;col&quot;&gt;

	&lt;div macro=&quot;mgtdList title:'Delegated Actions' tags:'Action &amp;&amp; !Done &amp;&amp; [(Waiting For)]' view:ActionProj
		ignoreRealm:yes
		newButtonTags:'Action [(Waiting For)]'
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Associated Actions' tags:'Action &amp;&amp; !Done &amp;&amp; ![(Waiting For)]' view:ActionProj
		ignoreRealm:yes
		group:ActionStatus
		gView:bold
		newButtonTags:'Action'
		&quot;&gt;&lt;/div&gt;


&lt;/div&gt;
&lt;div class=&quot;col&quot;&gt;

	&lt;div macro=&quot;mgtdList title:'Associated Projects' tags:'Project &amp;&amp; !Complete' view:Project
		ignoreRealm:yes
		group:ProjectStatus
		gView:bold
		newButtonTags:'Project'
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Associated Ticklers' tags:'Tickler &amp;&amp; !Actioned' view:Tickler
		ignoreRealm:yes
		newButtonTags:'Tickler Once'
		sort:tickleDate
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Done Actions' tags:'Action &amp;&amp; Done' view:DoneAction
		ignoreRealm:yes
		newButtonTags:Done
		&quot;&gt;&lt;/div&gt;

	&lt;div macro=&quot;mgtdList title:'Completed Projects' tags:'Project &amp;&amp; Complete' view:ProjectComplete
		ignoreRealm:yes
		newButtonTags:'Project'
		&quot;&gt;&lt;/div&gt;

&lt;/div&gt;

&lt;/div&gt;
&lt;!--}}}--&gt;


!Area
&lt;!--{{{--&gt;
&lt;div class=&quot;cols3&quot;&gt;

&lt;div class=&quot;col&quot;&gt;
	&lt;div macro=&quot;mgtdList title:'Active Projects' tags:'Project &amp;&amp; !Complete &amp;&amp; !Someday/Maybe' view:Project newButtonTags:'Project Active'
		ignoreRealm:yes
		&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;col&quot;&gt;
	&lt;div macro=&quot;mgtdList title:'Someday/Maybe Projects' tags:'Project &amp;&amp; !Complete &amp;&amp; Someday/Maybe' view:Project newButtonTags:'Project Someday/Maybe'
		ignoreRealm:yes
		&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;col&quot;&gt;
	&lt;div macro=&quot;mgtdList title:'Completed Projects' tags:'Project &amp;&amp; Complete' view:ProjectComplete newButtonTags:'Project Someday/Maybe' 
		ignoreRealm:yes
		&quot;&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;!--}}}--&gt;


!Reference
&lt;!--{{{--&gt;
&lt;div class=&quot;tagglyTagging&quot; macro=&quot;tagglyTagging&quot;&gt;&lt;/div&gt;&lt;!--- this makes me happy :) ---&gt;
&lt;!--}}}--&gt;


!Ticklers Requiring Action
&lt;!--{{{--&gt;
&lt;!--- included by other sections ---&gt;
&lt;div macro=&quot;mgtdList title:'Ticklers Requiring Action' tags:'Tickler &amp;&amp; !Actioned' view:Tickler newButtonTags:'Tickler Once'
	ignoreRealm:yes
	dontShowEmpty:yes
	where:'tiddler.fields.mgtd_date &amp;&amp; ((new Date()).convertToYYYYMMDDHHMM() &gt;= tiddler.fields.mgtd_date ) '
	sort:tickleDate
	&quot;&gt;&lt;/div&gt;
&lt;!--}}}--&gt;


!Upcoming Ticklers 
&lt;!--{{{--&gt;
&lt;!--- included by other sections ---&gt;
&lt;div macro=&quot;mgtdList title:'Upcoming Ticklers' tags:'Tickler &amp;&amp; !Actioned' view:Tickler newButtonTags:'Tickler Once'
	ignoreRealm:yes
	where:'!tiddler.fields.mgtd_date || ((new Date()).convertToYYYYMMDDHHMM() &lt; tiddler.fields.mgtd_date ) '
	sort:tickleDate
	&quot;&gt;&lt;/div&gt;
&lt;!--}}}--&gt;



</pre>
</div>
<div title="TagglyTaggingPlugin" modifier="MPTW" created="200803240232" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|TagglyTaggingPlugin|
|Description:|tagglyTagging macro is a replacement for the builtin tagging macro in your ViewTemplate|
|Version:|3.1 ($Rev: 4092 $)|
|Date:|$Date: 2008-03-24 12:32:33 +1000 (Mon, 24 Mar 2008) $|
|Source:|http://mptw.tiddlyspot.com/#TagglyTaggingPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
!Notes
See http://mptw.tiddlyspot.com/#TagglyTagging
***/
//{{{
config.taggly = {

	// for translations
	lingo: {
		labels: {
			asc:        &quot;\u2191&quot;, // down arrow
			desc:       &quot;\u2193&quot;, // up arrow
			title:      &quot;title&quot;,
			modified:   &quot;modified&quot;,
			created:    &quot;created&quot;,
			show:       &quot;+&quot;,
			hide:       &quot;-&quot;,
			normal:     &quot;normal&quot;,
			group:      &quot;group&quot;,
			commas:     &quot;commas&quot;,
			sitemap:    &quot;sitemap&quot;,
			numCols:    &quot;cols\u00b1&quot;, // plus minus sign
			label:      &quot;Tagged as '%0':&quot;,
			excerpts:   &quot;excerpts&quot;,
			descr:      &quot;descr&quot;,
			slices:     &quot;slices&quot;,
			contents:   &quot;contents&quot;,
			sliders:    &quot;sliders&quot;,
			noexcerpts: &quot;title only&quot;
		},

		tooltips: {
			title:    &quot;Click to sort by title&quot;,
			modified: &quot;Click to sort by modified date&quot;,
			created:  &quot;Click to sort by created date&quot;,
			show:     &quot;Click to show tagging list&quot;,
			hide:     &quot;Click to hide tagging list&quot;,
			normal:   &quot;Click to show a normal ungrouped list&quot;,
			group:    &quot;Click to show list grouped by tag&quot;,
			sitemap:  &quot;Click to show a sitemap style list&quot;,
			commas:   &quot;Click to show a comma separated list&quot;,
			numCols:  &quot;Click to change number of columns&quot;,
			excerpts: &quot;Click to show excerpts&quot;,
			descr:    &quot;Click to show the description slice&quot;,
			slices:    &quot;Click to show all slices&quot;,
			contents: &quot;Click to show entire tiddler contents&quot;,
			sliders:  &quot;Click to show tiddler contents in sliders&quot;,
			noexcerpts: &quot;Click to show entire title only&quot;
		}
	},

	config: {
		showTaggingCounts: true,
		listOpts: {
			// the first one will be the default
			sortBy:     [&quot;title&quot;,&quot;modified&quot;,&quot;created&quot;],
			sortOrder:  [&quot;asc&quot;,&quot;desc&quot;],
			hideState:  [&quot;show&quot;,&quot;hide&quot;],
			listMode:   [&quot;normal&quot;,&quot;group&quot;,&quot;sitemap&quot;,&quot;commas&quot;],
			numCols:    [&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;],
			excerpts:   [&quot;noexcerpts&quot;,&quot;excerpts&quot;,&quot;descr&quot;,&quot;slices&quot;,&quot;contents&quot;,&quot;sliders&quot;]
		},
		valuePrefix: &quot;taggly.&quot;,
		excludeTags: [&quot;excludeLists&quot;,&quot;excludeTagging&quot;],
		excerptSize: 50,
		excerptMarker: &quot;/%&quot;+&quot;%/&quot;
	},

	getTagglyOpt: function(title,opt) {
		var val = store.getValue(title,this.config.valuePrefix+opt);
		return val ? val : this.config.listOpts[opt][0];
	},

	setTagglyOpt: function(title,opt,value) {
		if (!store.tiddlerExists(title))
			// create it silently
			store.saveTiddler(title,title,config.views.editor.defaultText.format([title]),config.options.txtUserName,new Date(),&quot;&quot;);
		// if value is default then remove it to save space
		return store.setValue(title,
			this.config.valuePrefix+opt,
			value == this.config.listOpts[opt][0] ? null : value);
	},

	getNextValue: function(title,opt) {
		var current = this.getTagglyOpt(title,opt);
		var pos = this.config.listOpts[opt].indexOf(current);
		// a little usability enhancement. actually it doesn't work right for grouped or sitemap
		var limit = (opt == &quot;numCols&quot; ? store.getTaggedTiddlers(title).length : this.config.listOpts[opt].length);
		var newPos = (pos + 1) % limit;
		return this.config.listOpts[opt][newPos];
	},

	toggleTagglyOpt: function(title,opt) {
		var newVal = this.getNextValue(title,opt);
		this.setTagglyOpt(title,opt,newVal);
	}, 

	createListControl: function(place,title,type) {
		var lingo = config.taggly.lingo;
		var label;
		var tooltip;
		var onclick;

		if ((type == &quot;title&quot; || type == &quot;modified&quot; || type == &quot;created&quot;)) {
			// &quot;special&quot; controls. a little tricky. derived from sortOrder and sortBy
			label = lingo.labels[type];
			tooltip = lingo.tooltips[type];

			if (this.getTagglyOpt(title,&quot;sortBy&quot;) == type) {
				label += lingo.labels[this.getTagglyOpt(title,&quot;sortOrder&quot;)];
				onclick = function() {
					config.taggly.toggleTagglyOpt(title,&quot;sortOrder&quot;);
					return false;
				}
			}
			else {
				onclick = function() {
					config.taggly.setTagglyOpt(title,&quot;sortBy&quot;,type);
					config.taggly.setTagglyOpt(title,&quot;sortOrder&quot;,config.taggly.config.listOpts.sortOrder[0]);
					return false;
				}
			}
		}
		else {
			// &quot;regular&quot; controls, nice and simple
			label = lingo.labels[type == &quot;numCols&quot; ? type : this.getNextValue(title,type)];
			tooltip = lingo.tooltips[type == &quot;numCols&quot; ? type : this.getNextValue(title,type)];
			onclick = function() {
				config.taggly.toggleTagglyOpt(title,type);
				return false;
			}
		}

		// hide button because commas don't have columns
		if (!(this.getTagglyOpt(title,&quot;listMode&quot;) == &quot;commas&quot; &amp;&amp; type == &quot;numCols&quot;))
			createTiddlyButton(place,label,tooltip,onclick,type == &quot;hideState&quot; ? &quot;hidebutton&quot; : &quot;button&quot;);
	},

	makeColumns: function(orig,numCols) {
		var listSize = orig.length;
		var colSize = listSize/numCols;
		var remainder = listSize % numCols;

		var upperColsize = colSize;
		var lowerColsize = colSize;

		if (colSize != Math.floor(colSize)) {
			// it's not an exact fit so..
			upperColsize = Math.floor(colSize) + 1;
			lowerColsize = Math.floor(colSize);
		}

		var output = [];
		var c = 0;
		for (var j=0;j&lt;numCols;j++) {
			var singleCol = [];
			var thisSize = j &lt; remainder ? upperColsize : lowerColsize;
			for (var i=0;i&lt;thisSize;i++) 
				singleCol.push(orig[c++]);
			output.push(singleCol);
		}

		return output;
	},

	drawTable: function(place,columns,theClass) {
		var newTable = createTiddlyElement(place,&quot;table&quot;,null,theClass);
		var newTbody = createTiddlyElement(newTable,&quot;tbody&quot;);
		var newTr = createTiddlyElement(newTbody,&quot;tr&quot;);
		for (var j=0;j&lt;columns.length;j++) {
			var colOutput = &quot;&quot;;
			for (var i=0;i&lt;columns[j].length;i++) 
				colOutput += columns[j][i];
			var newTd = createTiddlyElement(newTr,&quot;td&quot;,null,&quot;tagglyTagging&quot;); // todo should not need this class
			wikify(colOutput,newTd);
		}
		return newTable;
	},

	createTagglyList: function(place,title) {
		switch(this.getTagglyOpt(title,&quot;listMode&quot;)) {
			case &quot;group&quot;:  return this.createTagglyListGrouped(place,title); break;
			case &quot;normal&quot;: return this.createTagglyListNormal(place,title,false); break;
			case &quot;commas&quot;: return this.createTagglyListNormal(place,title,true); break;
			case &quot;sitemap&quot;:return this.createTagglyListSiteMap(place,title); break;
		}
	},

	getTaggingCount: function(title) {
		// thanks to Doug Edmunds
		if (this.config.showTaggingCounts) {
			var tagCount = store.getTaggedTiddlers(title).length;
			if (tagCount &gt; 0)
				return &quot; (&quot;+tagCount+&quot;)&quot;;
		}
		return &quot;&quot;;
	},

	getExcerpt: function(inTiddlerTitle,title,indent) {
		if (!indent)
			indent = 1;

		var displayMode = this.getTagglyOpt(inTiddlerTitle,&quot;excerpts&quot;);
		var t = store.getTiddler(title);

		if (t &amp;&amp; displayMode == &quot;excerpts&quot;) {
			var text = t.text.replace(/\n/,&quot; &quot;);
			var marker = text.indexOf(this.config.excerptMarker);
			if (marker != -1) {
				return &quot; {{excerpt{&lt;nowiki&gt;&quot; + text.substr(0,marker) + &quot;&lt;/nowiki&gt;}}}&quot;;
			}
			else if (text.length &lt; this.config.excerptSize) {
				return &quot; {{excerpt{&lt;nowiki&gt;&quot; + t.text + &quot;&lt;/nowiki&gt;}}}&quot;;
			}
			else {
				return &quot; {{excerpt{&lt;nowiki&gt;&quot; + t.text.substr(0,this.config.excerptSize) + &quot;...&quot; + &quot;&lt;/nowiki&gt;}}}&quot;;
			}
		}
		else if (t &amp;&amp; displayMode == &quot;contents&quot;) {
			return &quot;\n{{contents indent&quot;+indent+&quot;{\n&quot; + t.text + &quot;\n}}}&quot;;
		}
		else if (t &amp;&amp; displayMode == &quot;sliders&quot;) {
			return &quot;&lt;slider slide&gt;\n{{contents{\n&quot; + t.text + &quot;\n}}}\n&lt;/slider&gt;&quot;;
		}
		else if (t &amp;&amp; displayMode == &quot;descr&quot;) {
			var descr = store.getTiddlerSlice(title,'Description');
			return descr ? &quot; {{excerpt{&quot; + descr  + &quot;}}}&quot; : &quot;&quot;;
		}
		else if (t &amp;&amp; displayMode == &quot;slices&quot;) {
			var result = &quot;&quot;;
			var slices = store.calcAllSlices(title);
			for (var s in slices)
				result += &quot;|%0|&lt;nowiki&gt;%1&lt;/nowiki&gt;|\n&quot;.format([s,slices[s]]);
			return result ? &quot;\n{{excerpt excerptIndent{\n&quot; + result  + &quot;}}}&quot; : &quot;&quot;;
		}
		return &quot;&quot;;
	},

	notHidden: function(t,inTiddler) {
		if (typeof t == &quot;string&quot;) 
			t = store.getTiddler(t);
		return (!t || !t.tags.containsAny(this.config.excludeTags) ||
				(inTiddler &amp;&amp; this.config.excludeTags.contains(inTiddler)));
	},

	// this is for normal and commas mode
	createTagglyListNormal: function(place,title,useCommas) {

		var list = store.getTaggedTiddlers(title,this.getTagglyOpt(title,&quot;sortBy&quot;));

		if (this.getTagglyOpt(title,&quot;sortOrder&quot;) == &quot;desc&quot;)
			list = list.reverse();

		var output = [];
		var first = true;
		for (var i=0;i&lt;list.length;i++) {
			if (this.notHidden(list[i],title)) {
				var countString = this.getTaggingCount(list[i].title);
				var excerpt = this.getExcerpt(title,list[i].title);
				if (useCommas)
					output.push((first ? &quot;&quot; : &quot;, &quot;) + &quot;[[&quot; + list[i].title + &quot;]]&quot; + countString + excerpt);
				else
					output.push(&quot;*[[&quot; + list[i].title + &quot;]]&quot; + countString + excerpt + &quot;\n&quot;);

				first = false;
			}
		}

		return this.drawTable(place,
			this.makeColumns(output,useCommas ? 1 : parseInt(this.getTagglyOpt(title,&quot;numCols&quot;))),
			useCommas ? &quot;commas&quot; : &quot;normal&quot;);
	},

	// this is for the &quot;grouped&quot; mode
	createTagglyListGrouped: function(place,title) {
		var sortBy = this.getTagglyOpt(title,&quot;sortBy&quot;);
		var sortOrder = this.getTagglyOpt(title,&quot;sortOrder&quot;);

		var list = store.getTaggedTiddlers(title,sortBy);

		if (sortOrder == &quot;desc&quot;)
			list = list.reverse();

		var leftOvers = []
		for (var i=0;i&lt;list.length;i++)
			leftOvers.push(list[i].title);

		var allTagsHolder = {};
		for (var i=0;i&lt;list.length;i++) {
			for (var j=0;j&lt;list[i].tags.length;j++) {

				if (list[i].tags[j] != title) { // not this tiddler

					if (this.notHidden(list[i].tags[j],title)) {

						if (!allTagsHolder[list[i].tags[j]])
							allTagsHolder[list[i].tags[j]] = &quot;&quot;;

						if (this.notHidden(list[i],title)) {
							allTagsHolder[list[i].tags[j]] += &quot;**[[&quot;+list[i].title+&quot;]]&quot;
										+ this.getTaggingCount(list[i].title) + this.getExcerpt(title,list[i].title) + &quot;\n&quot;;

							leftOvers.setItem(list[i].title,-1); // remove from leftovers. at the end it will contain the leftovers

						}
					}
				}
			}
		}

		var allTags = [];
		for (var t in allTagsHolder)
			allTags.push(t);

		var sortHelper = function(a,b) {
			if (a == b) return 0;
			if (a &lt; b) return -1;
			return 1;
		};

		allTags.sort(function(a,b) {
			var tidA = store.getTiddler(a);
			var tidB = store.getTiddler(b);
			if (sortBy == &quot;title&quot;) return sortHelper(a,b);
			else if (!tidA &amp;&amp; !tidB) return 0;
			else if (!tidA) return -1;
			else if (!tidB) return +1;
			else return sortHelper(tidA[sortBy],tidB[sortBy]);
		});

		var leftOverOutput = &quot;&quot;;
		for (var i=0;i&lt;leftOvers.length;i++)
			if (this.notHidden(leftOvers[i],title))
				leftOverOutput += &quot;*[[&quot;+leftOvers[i]+&quot;]]&quot; + this.getTaggingCount(leftOvers[i]) + this.getExcerpt(title,leftOvers[i]) + &quot;\n&quot;;

		var output = [];

		if (sortOrder == &quot;desc&quot;)
			allTags.reverse();
		else if (leftOverOutput != &quot;&quot;)
			// leftovers first...
			output.push(leftOverOutput);

		for (var i=0;i&lt;allTags.length;i++)
			if (allTagsHolder[allTags[i]] != &quot;&quot;)
				output.push(&quot;*[[&quot;+allTags[i]+&quot;]]&quot; + this.getTaggingCount(allTags[i]) + this.getExcerpt(title,allTags[i]) + &quot;\n&quot; + allTagsHolder[allTags[i]]);

		if (sortOrder == &quot;desc&quot; &amp;&amp; leftOverOutput != &quot;&quot;)
			// leftovers last...
			output.push(leftOverOutput);

		return this.drawTable(place,
				this.makeColumns(output,parseInt(this.getTagglyOpt(title,&quot;numCols&quot;))),
				&quot;grouped&quot;);

	},

	// used to build site map
	treeTraverse: function(title,depth,sortBy,sortOrder) {

		var list = store.getTaggedTiddlers(title,sortBy);
		if (sortOrder == &quot;desc&quot;)
			list.reverse();

		var indent = &quot;&quot;;
		for (var j=0;j&lt;depth;j++)
			indent += &quot;*&quot;

		var childOutput = &quot;&quot;;
		for (var i=0;i&lt;list.length;i++)
			if (list[i].title != title)
				if (this.notHidden(list[i].title,this.config.inTiddler))
					childOutput += this.treeTraverse(list[i].title,depth+1,sortBy,sortOrder);

		if (depth == 0)
			return childOutput;
		else
			return indent + &quot;[[&quot;+title+&quot;]]&quot; + this.getTaggingCount(title) + this.getExcerpt(this.config.inTiddler,title,depth) + &quot;\n&quot; + childOutput;
	},

	// this if for the site map mode
	createTagglyListSiteMap: function(place,title) {
		this.config.inTiddler = title; // nasty. should pass it in to traverse probably
		var output = this.treeTraverse(title,0,this.getTagglyOpt(title,&quot;sortBy&quot;),this.getTagglyOpt(title,&quot;sortOrder&quot;));
		return this.drawTable(place,
				this.makeColumns(output.split(/(?=^\*\[)/m),parseInt(this.getTagglyOpt(title,&quot;numCols&quot;))), // regexp magic
				&quot;sitemap&quot;
				);
	},

	macros: {
		tagglyTagging: {
			handler: function (place,macroName,params,wikifier,paramString,tiddler) {
				var refreshContainer = createTiddlyElement(place,&quot;div&quot;);
				// do some refresh magic to make it keep the list fresh - thanks Saq
				refreshContainer.setAttribute(&quot;refresh&quot;,&quot;macro&quot;);
				refreshContainer.setAttribute(&quot;macroName&quot;,macroName);
				if (params[0])
					refreshContainer.setAttribute(&quot;title&quot;,params[0]);
				else {
        			refreshContainer.setAttribute(&quot;title&quot;,tiddler.title);
				}
				this.refresh(refreshContainer);
			},

			refresh: function(place) {
				var title = place.getAttribute(&quot;title&quot;);
				removeChildren(place);
				addClass(place,&quot;tagglyTagging&quot;);
				if (store.getTaggedTiddlers(title).length &gt; 0) {
					var lingo = config.taggly.lingo;
					config.taggly.createListControl(place,title,&quot;hideState&quot;);
					if (config.taggly.getTagglyOpt(title,&quot;hideState&quot;) == &quot;show&quot;) {
						createTiddlyElement(place,&quot;span&quot;,null,&quot;tagglyLabel&quot;,lingo.labels.label.format([title]));
						config.taggly.createListControl(place,title,&quot;title&quot;);
						config.taggly.createListControl(place,title,&quot;modified&quot;);
						config.taggly.createListControl(place,title,&quot;created&quot;);
						config.taggly.createListControl(place,title,&quot;listMode&quot;);
						config.taggly.createListControl(place,title,&quot;excerpts&quot;);
						config.taggly.createListControl(place,title,&quot;numCols&quot;);
						config.taggly.createTagglyList(place,title);
					}
				}
			}
		}
	},

	// todo fix these up a bit
	styles: [
&quot;/*{{{*/&quot;,
&quot;/* created by TagglyTaggingPlugin */&quot;,
&quot;.tagglyTagging { padding-top:0.5em; }&quot;,
&quot;.tagglyTagging li.listTitle { display:none; }&quot;,
&quot;.tagglyTagging ul {&quot;,
&quot;	margin-top:0px; padding-top:0.5em; padding-left:2em;&quot;,
&quot;	margin-bottom:0px; padding-bottom:0px;&quot;,
&quot;}&quot;,
&quot;.tagglyTagging { vertical-align: top; margin:0px; padding:0px; }&quot;,
&quot;.tagglyTagging table { margin:0px; padding:0px; }&quot;,
&quot;.tagglyTagging .button { visibility:hidden; margin-left:3px; margin-right:3px; }&quot;,
&quot;.tagglyTagging .button, .tagglyTagging .hidebutton {&quot;,
&quot;	color:[[ColorPalette::TertiaryLight]]; font-size:90%;&quot;,
&quot;	border:0px; padding-left:0.3em;padding-right:0.3em;&quot;,
&quot;}&quot;,
&quot;.tagglyTagging .button:hover, .hidebutton:hover, &quot;,
&quot;.tagglyTagging .button:active, .hidebutton:active  {&quot;,
&quot;	border:0px; background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]];&quot;,
&quot;}&quot;,
&quot;.selected .tagglyTagging .button { visibility:visible; }&quot;,
&quot;.tagglyTagging .hidebutton { color:[[ColorPalette::Background]]; }&quot;,
&quot;.selected .tagglyTagging .hidebutton { color:[[ColorPalette::TertiaryLight]] }&quot;,
&quot;.tagglyLabel { color:[[ColorPalette::TertiaryMid]]; font-size:90%; }&quot;,
&quot;.tagglyTagging ul {padding-top:0px; padding-bottom:0.5em; margin-left:1em; }&quot;,
&quot;.tagglyTagging ul ul {list-style-type:disc; margin-left:-1em;}&quot;,
&quot;.tagglyTagging ul ul li {margin-left:0.5em; }&quot;,
&quot;.editLabel { font-size:90%; padding-top:0.5em; }&quot;,
&quot;.tagglyTagging .commas { padding-left:1.8em; }&quot;,
&quot;/* not technically tagglytagging but will put them here anyway */&quot;,
&quot;.tagglyTagged li.listTitle { display:none; }&quot;,
&quot;.tagglyTagged li { display: inline; font-size:90%; }&quot;,
&quot;.tagglyTagged ul { margin:0px; padding:0px; }&quot;,
&quot;.excerpt { color:[[ColorPalette::TertiaryDark]]; }&quot;,
&quot;.excerptIndent { margin-left:4em; }&quot;,
&quot;div.tagglyTagging table,&quot;,
&quot;div.tagglyTagging table tr,&quot;,
&quot;td.tagglyTagging&quot;,
&quot; {border-style:none!important; }&quot;,
&quot;.tagglyTagging .contents { border-bottom:2px solid [[ColorPalette::TertiaryPale]]; padding:0 1em 1em 0.5em;&quot;,
&quot;  margin-bottom:0.5em; }&quot;,
&quot;.tagglyTagging .indent1  { margin-left:3em;  }&quot;,
&quot;.tagglyTagging .indent2  { margin-left:4em;  }&quot;,
&quot;.tagglyTagging .indent3  { margin-left:5em;  }&quot;,
&quot;.tagglyTagging .indent4  { margin-left:6em;  }&quot;,
&quot;.tagglyTagging .indent5  { margin-left:7em;  }&quot;,
&quot;.tagglyTagging .indent6  { margin-left:8em;  }&quot;,
&quot;.tagglyTagging .indent7  { margin-left:9em;  }&quot;,
&quot;.tagglyTagging .indent8  { margin-left:10em; }&quot;,
&quot;.tagglyTagging .indent9  { margin-left:11em; }&quot;,
&quot;.tagglyTagging .indent10 { margin-left:12em; }&quot;,
&quot;/*}}}*/&quot;,
		&quot;&quot;].join(&quot;\n&quot;),

	init: function() {
		merge(config.macros,this.macros);
		config.shadowTiddlers[&quot;TagglyTaggingStyles&quot;] = this.styles;
		store.addNotification(&quot;TagglyTaggingStyles&quot;,refreshStyles);
	}
};

config.taggly.init();

//}}}

/***
InlineSlidersPlugin
By Saq Imtiaz
http://tw.lewcid.org/sandbox/#InlineSlidersPlugin

// syntax adjusted to not clash with NestedSlidersPlugin
// added + syntax to start open instead of closed

***/
//{{{
config.formatters.unshift( {
	name: &quot;inlinesliders&quot;,
	// match: &quot;\\+\\+\\+\\+|\\&lt;slider&quot;,
	match: &quot;\\&lt;slider&quot;,
	// lookaheadRegExp: /(?:\+\+\+\+|&lt;slider) (.*?)(?:&gt;?)\n((?:.|\n)*?)\n(?:====|&lt;\/slider&gt;)/mg,
	lookaheadRegExp: /(?:&lt;slider)(\+?) (.*?)(?:&gt;)\n((?:.|\n)*?)\n(?:&lt;\/slider&gt;)/mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source)
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart ) {
			var btn = createTiddlyButton(w.output,lookaheadMatch[2] + &quot; &quot;+&quot;\u00BB&quot;,lookaheadMatch[2],this.onClickSlider,&quot;button sliderButton&quot;);
			var panel = createTiddlyElement(w.output,&quot;div&quot;,null,&quot;sliderPanel&quot;);
			panel.style.display = (lookaheadMatch[1] == '+' ? &quot;block&quot; : &quot;none&quot;);
			wikify(lookaheadMatch[3],panel);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
   },
   onClickSlider : function(e) {
		if(!e) var e = window.event;
		var n = this.nextSibling;
		n.style.display = (n.style.display==&quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;
		return false;
	}
});

//}}}

</pre>
</div>
<div title="Tickler" modifier="YourName" created="200805221358" modified="200805221358" tags="GTDComponent">
<pre></pre>
</div>
<div title="Tickler Dashboard" modifier="YourName" created="200805221244" modified="200805221358" tags="View excludeSearch">
<pre>{{cols2{

{{col{

&lt;&lt;tiddler 'Ticklers Requiring Action'&gt;&gt;

&lt;&lt;mgtdList title:'Upcoming Ticklers' startTag:Tickler tags:'!Actioned' view:Tickler mode:global newButtonTags:'Tickler Once'
	where:'!tiddler.fields.mgtd_date || ((new Date()).convertToYYYYMMDDHHMM() &lt; tiddler.fields.mgtd_date )'
	sort:'tickleDate'
	&gt;&gt;

}}}

{{col{

&lt;&lt;mgtdList title:'Old Ticklers' startTag:Tickler tags:'Actioned' view:Tickler mode:global newButtonTags:'Tickler Actioned Once' &gt;&gt;

}}}

}}}
</pre>
</div>
<div title="TicklerAlert" modifier="YourName" created="200803311259" modified="200805221358" tags="excludeSearch">
<pre>&lt;&lt;ticklerAlert&gt;&gt;
</pre>
</div>
<div title="Ticklers Requiring Action" modifier="YourName" created="200805221237" modified="200805221358" tags="View excludeSearch">
<pre>&lt;&lt;mgtdList
	title:'Ticklers Requiring Action'
	startTag:Tickler
	tags:'!Actioned'
	view:Tickler
	mode:global
	newButtonTags:'Tickler Enabled Once'
	where:'tiddler.fields.mgtd_date &amp;&amp; ((new Date()).convertToYYYYMMDDHHMM() &gt;= tiddler.fields.mgtd_date )'
	sort:'tickleDate'
	ignoreRealm:{{config.mGTD.getOptChk('AlertsIgnoreRealm')?'yes':''}}
&gt;&gt;
</pre>
</div>
<div title="TiddlerSortMethods" modifier="YourName" created="200805171434" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>// for sorting tiddlers

merge(Tiddler.prototype,{

	sort_tickleDate: function() { return this.fields['mgtd_date']; }, // todo 

	sort_orderSlice: function() {
		var orderSlice = store.getTiddlerSlice(this.title,&quot;order&quot;);
		return orderSlice ? orderSlice : this.title; // so if there's no slice we get sorting by title
	},

	sort_prioritySlice: function() {
		var orderSlice = store.getTiddlerSlice(this.title,&quot;priority&quot;);
		return orderSlice ? orderSlice : this.title; // so if there's no slice we get sorting by title
	}

});
</pre>
</div>
<div title="TiddlerViewMethods" modifier="YourName" created="200805211141" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>// for displaying tiddlers in lists

// idea: use &lt;&lt;tiddler with:?&gt;&gt;


if (!config.mGTD) config.mGTD = {};

config.mGTD.data = {
	starOn:    'data:image/gif;base64,R0lGODlhDwAPAMQfAF9h4RYVnZeQJC0u0lRQU42R6P/7Fv74L05NrRkZxi4tW52XXv71D8nAIWxnjnRxr3NuMJKOluXbBe7kCa2x7UFD1vPoB77D8Jqe6n6B5tvTUr62BMrP8lJPh1xbuv///yH5BAEAAB8ALAAAAAAPAA8AAAWD4CeOWQKMaDpESepi3tFlLgpExlK9RT9ohkYi08N8KhWP8nEwMBwIDyJRSTgO2CaDYcBOCAlMgtDYmhmTDSFQ+HAqgbLZIlAMLqiKw7m1EAYuFQsGEhITEwItKBc/EgIEAhINAUYkCBIQAQMBEGonIwAKa21iCgo7IxQDFRQjF1VtHyEAOw==',
	starOff:   'data:image/gif;base64,R0lGODlhDwAPALMPAP///8zj++r7/7vb/rHW/tPt/9Lk+qzT/rbY/sHh/8Te/N7q+Nzy/7nY/djn+f///yH5BAEAAA8ALAAAAAAPAA8AAARg8MkZjpo4k0KyNwlQBB42MICAfEF7APDRBsYzIEkewGKeDI1DgUckMg6GTdFIqC0QgyUgQVhgGkOi4OBBCJYdzILAywIGNcoOgCAQvowBRpE4kgzCQgPjQCAcEwsNTRIRADs=',
	yuiSprite: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAfQCAMAAACHRu2lAAADAFBMVEX////56Lbe3+DrwjXpuiX0yKLokkL2NDSthiL60Jr4YV7xs4ely/8vPqzXsyj1j4/KzumdnZ3MfApzhs5uiqzaow3hehKBmbfx1Ebh4uPopxvUCAH4JCQoMZPg4OGEh8E/atHi4+P1R0ehcw7osjqWqsP4FRXoqzv658otK2vcTQTmmhX1slX76t/mnD/tiRvnpD3laAREWbPqvTczQ6zq6uvxqGG5utdtbW3VMQGtscTOtm6FhYX3VVX0dXX4175zc3Pm5ubqwCna2tvElhb4Cwvmdi7OsUzc3N3Q0dIlK4cTDkv566j3xIC0k0j24FM7Q5tSY7rtiyH71dV+f6zkig7wmjTmsh5JSUkuN5z2amrodA7peRThdBEZG2pcfsrZxovrVlf2enp3dJPgWQLlyk0fJHdNaMMkKpE8Ubbptzj5xcXfyXXwlizX2Nr+/v7BwcH8/Pz7+/v6+vr39/fn6Ojj4+Xv8PD19fVCb9nm8f/f4ODs7Ozy8vL29vbh4eLg4eL19fYAAADn8f/c7P/V5//n8v/5+frH3//o6uri7v/r6+zj8P/l5ubf4OH6+vvx8fLX6P/5+fnr7Ozl8P/R5v/L4v/P4//E3f/f7f/39/na6f/g7f/y9PTt7+9Bbtd/f38iIiLy8vT19vbMztDn6Oqsr7Dw8PHx8fH5+vq+wcLJyss7Zcs5YcS62P/29vdAa9Ts7e3U1dYuUrAwVrXo6Oo5Y8g9Z87d3d/v7+/09PT09fXExca4u703X8Ls7O3m5+jw8PDt7e/X19jw8fGztbfl5eZAbNVAbdbx8vIoTKYrTqvhdxvx0lj5vLzzUkf1y0yxsbHh5++Wlpbzzjxqamrm2sHx1WfXhgbo6Oj7f3/14Iz8cXfPt4f97+LWPCDh7v+eo9Gkq9vy+f/ujynkznb711DqCgvzozvnfhfqkWH+/fRRb8b22n3iYQ0gJIH77Ww6TbLtLi+kpKXbwE1mZmYmR6Dm5ufb3N2/2v+lqKvY2Nrc3d/o8v////8zW7zbSCWcAAAAAXRSTlMAQObYZgAACOFJREFUeNrt3Hl4FPUdx/FvmpAgsIFgwJCwseRGMEuuutoQIglyRCRYyWYBoSpijFpBsd221Oja1lpaa7V3a9vtfd/3Se8rgYSQpijWorRKD+hd29ppf/NLKnGP+X2iEza7fF5/BJ593s9vZ3aTZ77PzsyKBZIkhjeC8HAnSG4Cyc0guRcknwbJ10HyE5C8BCTfBsldIHk9SOaB5EmQ/BvEkCFDhgwZMmTIMBVDItJ6QBMQ3gaSYpA8ByRfAckqkLSA5Hsg+RxIVoPkAyD5OEi+AZKPgeSbIPkBSD4Ekn+BGDJkyJAhQ4YMGU6ikIjGx/2T8e6fY78TJLtAcitIQiC5HyT3gOTDIPkqSD4LkvtA0gCSD4JkLwi/YODFIPzKAvjDq7tB+IdXT4AYMmTIkCFDhgwZRodENGJHfLFdgg8Hdjz7cCCkfoQGjOGAvzFkhRr9A6ZQNY27G+3a9NSqbD7ZOe3M7mZ/825gZ9AV4W3MG93rPOOKeaGnfrr0zphC+LeHiIgm9wTg2DkfCp5x6PcnJ/SPci9M4s64/M4Ij+ZERJwAJnwCSFY4IRNAmrw8nACIiE63CSBJZwGedg7AORxzDsAxDI35fN3wmf2YziHM8/v3QDsDrwhvozX2HIDpdcwLufzO8CwAEREngAmcAAZCWDgwIUdX6DoAy9rjP3kcdmNFeBvxvc4LuT6bcQIgIkpXfojqdiA3De7wT0iI3IaYIGzobIgXxtyceCgSHop6SIfR9ybujYQje6Me02HU1/9eqLoLo78TWIdRtyZ2hsOrY+5X1OHtTzdPrTgv6rHbdfiKKMWqLI56TIcx3+u7KhLujHpIh7tjtHS2RD2iw1sAOkRuyNPhywE6hPjx33AiIk4A6TQB+BsShFEH+6Fw5FDMUBBvAog3AMSdAOKOAPEmgF27VofDncAEEHcEiDcBxBsA4k4AfwtHVsUMBXEngJjDPycAIqLU95dmf3Me0DUO9lg9g43GLm9QH7kHjWs29+iwp9k4pIwOA37XVhwc3cZB1/Zaralex0H+OhERUcq4ID8/vxzozio/YB0oP8vYlZf/asaMGXeUG9fMPzDDdiDfGFo6fDTftRXhbbT3+lFkr9Wa4OtIREQ0KaT5dQANDdBZgJ2HIrGnARKcBYCuA7DPAcSeBog9C7BARQv0D8NZgCF9BmBeJNxpOAtQ3Fk85h/DdQBxJLgOgGcBiIg4AaTWlYDYdQBxxZkAhvTBf++QaQIY0gd/NQYMuTUB6KsAYi8ESHAdAHgl4KpI7IUA8SeAlhZOAERElH7CI9ASXRN9dr4BRMn03hFoia6JPjvfAKJTesTHRwN8hsCHDbdX5KRBNK4jPj4a4DMEPmy4vSInDaJTNBSM4wCOf6gQ5sGZKCWGgnEcwPEPFeCDOBGd+oM+thZ0IFcNzzcQpdRBH1sLOpCrhucbaJLJzDQ3vSJnZGbW1Z2h/2vu6roN5RLV1WX013V3q3KJ8/aNdGVl1YaNrKuz+u2uLNsYZvSrrLKy1xB2d/+hX2WVS4xhWX+/3ZnCjLKMfjtbUt2bgXXVzmVv5f+z6uxspyev7B0j2/yG9/IPg4gove07vF85vM/Y7Z82bdrS/SU5+8zd0qamphJDaXclL1D/mZmT41g+sHGj7qRJhU0O4f4HnlovZ36Ocyhy3dIcHVYYwivtquS6mfOLHMKSjXqxnJkiV1Y4heoJFb0XORV/dggPq2yp3u2ZFSs2Or2OFRUV0/R+r1hR5PyKq7KipGS+qVPlihFF5t+KKx4rKnrsin38OyIiSjkPHlT6HjR2qvrN8uVZWX2Grk9VdmcsVaWKvkAgsMgQZmXphQOBDYZd6bOfsq+wsPAXwI7rrs+9TgoLF0GdLAI7Fc52OYRt2ACuCIezZ7u9jURE9Cyd3d7V1dV+tik7LxisvbbeE+zynufcddX+vv4R6xGPx3vCsQzWXuPxzLJmeVS5xmn76rfWezy169er0HPissRhe32tKs48cqYdehcmDrv+pBYcfWpPcItDuPXak6GnLXF4YmzodQjb118zGga93u0O23hZ+9ZgMKhCr9J2lcPrs6a23esdCbe0Ob4zW054vUdmHbG7C5zfw4Vbtq/xrtneZujs7VzY1ta28Cr+GRERpZxf5yrXm7u/Xn1xRkFm7krjelf/LmNdwcHluc83hLkXZ/zRDrNaTWHBunV2GDCGBwsKqqoyswJTDeH1uZmZw8NZgVbTNsrK3Kzh4UDrJebXZ+Wc4eE5U4EX/IVzlEuQsFRBwp9rQPhQae4cbMWpra2lD0G/P6Wl/BsiIkpF/wElM3w1SO4AyctAePgmkLwOJK8FybtA8naQvBIk7wTJG0HyKpC8GSRvBclbQPIakLwNJP8EMWTIkCFDhgwZMowOiWh8XgpKZvgeEB7+GCQ/AslnQPJcEB5+GSSfAMmXQPJJkHwLJP8F4eEXQPJ5kPwMJD8Fyd9BDBkyZMiQIUOGDKNDIpogFiglwhtBExDuBOHhTSC5GSR3guQdILkVJCGQfA0k94DkOyD5Lkj2gOSLIPkHiCFDhgwZMmTIkGF0SESn8WcADBkyTL8wFT7bgz+yewNIPgpK5kd27wPJ90HybpDcB5K7QPiguQAkd4PkCZC8CMSQIUOGp1tIRNqnQPgdOfBN0PBt1fCN2vCt3/DN5PDt6fAN7/At9PBN+fBt/vAXB8BfRQB/uQH8dQnuf1MD/CUR8NdOpMJ3aDBkyJAhQ4YMGZ4uIRGl3+n9tDppdy9IdoHk/SC5HyQfAeHn4uCr4m8ByQ9BchtIngQxZMiQIUOGDBkynEQhET0T02tqpiPdspqOG2qWAWH2pWsXb8o2d1NqFlu/9NVMMYbHjq61LN+mXuOebHp8sQp9pv05d1NHR4d6at/m4+c6hs/b/LjPZ1X5fL7jv3Xqqmo6LvX5qtaq8Ng5Ti9R9uYbVNNx1A63XeT4Wqvk6LIpx+bOndt7/nSHBY8p1ZY117bt4YTh8ct1MWW6/ufyooThRdu2naOcrxUVPcw/ECIiIiIionTwP2GPpt8/BTzoAAAAAElFTkSuQmCC',

	unicodeStar: &quot;\u2605&quot; // &quot;black star&quot;
};


merge(Tiddler.prototype,{

	render_Action: function() { return this.renderUtil(
		'{{action{'+
		'&lt;&lt;toggleTag Done [[%0]] -&gt;&gt;'+
		'&lt;&lt;multiToggleTag tag:ActionStatus title:[[%0]]&gt;&gt;'+
		//'&lt;&lt;multiSelectTag tag:Project title:[[%0]]&gt;&gt;'+
		//'&lt;&lt;multiCheckboxTag tag:ActionStatus title:[[%0]]&gt;&gt;'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		' &amp;nbsp;[[%0]] }}}',
		[
			this.title
		]
	);},

	render_Tickler: function() {
        var repeatType = this.getByIndex('TicklerRepeatType');
        var doneControl = &quot;&quot;;
        if (repeatType.length == 0 || repeatType.contains('Once')) {
            // show normal done checkbox
            doneControl = '&lt;&lt;toggleTag Actioned [[%0]] -&gt;&gt;';
        }
        else if (repeatType.contains('Daily'))   { doneControl = '&lt;&lt;addDay [[%0]]&gt;&gt;' }
        else if (repeatType.contains('Weekly'))  { doneControl = '&lt;&lt;addWeek [[%0]]&gt;&gt;' }
        else if (repeatType.contains('Monthly')) { doneControl = '&lt;&lt;addMonth [[%0]]&gt;&gt;' }
        else if (repeatType.contains('Yearly'))  { doneControl = '&lt;&lt;addYear [[%0]]&gt;&gt;' }

        return this.renderUtil(
		'{{tickler{'+
        '%1'+  
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		'&lt;&lt;dateChooser [[%0]]&gt;&gt;'+
		'&amp;nbsp;[[%0]]}}}',
		[
			this.title,
            doneControl.format([this.title])
		]
	);},

	render_Project: function() { return this.renderUtil(
		'{{project{'+
		'&lt;&lt;toggleTag Complete [[%0]] -&gt;&gt;'+
		'&lt;&lt;multiToggleTag tag:ProjectStatus title:[[%0]]&gt;&gt;'+
		//'&lt;&lt;multiSelectTag tag:Project title:[[%0]]&gt;&gt;'+
		//'&lt;&lt;multiCheckboxTag tag:ActionStatus title:[[%0]]&gt;&gt;'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		' &amp;nbsp;[[%0]] }}}'+
		&quot;{{projLink{&lt;&lt;linkToParent Project '[P]' [[%0]]&gt;&gt;}}}&quot;+
		&quot;{{projLink{&lt;&lt;linkToParent Contact '[C]' [[%0]]&gt;&gt;}}}&quot;+
		&quot;&quot;,
		[
			this.title
		]
	);},

	render_ProjectArea: function() {
		var aLink = &quot;&quot;;
	    return this.renderUtil(
		'{{project{'+
		'&lt;&lt;toggleTag Complete [[%0]] -&gt;&gt;'+
		'&lt;&lt;multiToggleTag tag:ProjectStatus title:[[%0]]&gt;&gt;'+
		//'&lt;&lt;multiSelectTag tag:Project title:[[%0]]&gt;&gt;'+
		//'&lt;&lt;multiCheckboxTag tag:ActionStatus title:[[%0]]&gt;&gt;'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		' &amp;nbsp;[[%0]] }}} %1'+
		&quot;{{projLink{&lt;&lt;linkToParent Area    '[A]' [[%0]]&gt;&gt;}}}&quot;+
		&quot;{{projLink{&lt;&lt;linkToParent Project '[P]' [[%0]]&gt;&gt;}}}&quot;+
		&quot;{{projLink{&lt;&lt;linkToParent Contact '[C]' [[%0]]&gt;&gt;}}}&quot;+
		&quot;&quot;,
		[
			this.title,
			aLink
		]
	);},


	render_ProjectBare: function() { return this.renderUtil(
		'{{project{'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		'&amp;nbsp;[[%0]] }}}',
		[
			this.title
		]
	);},

	render_ProjectComplete: function() { return this.renderUtil(
		'{{project{'+
		'&lt;&lt;toggleTag Complete [[%0]] -&gt;&gt;'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		'&amp;nbsp;[[%0]] }}}',
		[
			this.title
		]
	);},


	render_ActionProj: function() {

		// actually it's not going to be easy to have
		// an action in more than one project
		// but just in case....
		var pLink = &quot;&quot;;
		if (config.mGTD.getOptChk('FullProjectInActionLists')) {
			pLink += &quot;{{projLinkFull{&lt;&lt;linkToParent Project [[title]] [[%0]]&gt;&gt;}}}&quot;.format([this.title]);
		}
		else {
			pLink += &quot;{{projLink{&lt;&lt;linkToParent Project '[P]' [[%0]]&gt;&gt;}}}&quot;.format([this.title]);
		}

		if (config.mGTD.getOptChk('FullContactInActionLists')) {
			pLink += &quot;{{projLinkFull{&lt;&lt;linkToParent Contact [[title]] [[%0]]&gt;&gt;}}}&quot;.format([this.title]);
		}
		else {
			pLink += &quot;{{projLink{&lt;&lt;linkToParent Contact '[C]' [[%0]]&gt;&gt;}}}&quot;.format([this.title]);
		}

		return this.renderUtil(
		'{{action{'+
		'&lt;&lt;toggleTag Done [[%0]] -&gt;&gt;'+
		'&lt;&lt;multiToggleTag tag:ActionStatus title:[[%0]]&gt;&gt;'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		' &amp;nbsp;[[%0]]}}} %1',
		[
			this.title,
			pLink
		]
	);},

	render_DoneAction: function() { return this.renderUtil(
		'{{action{'+
		'&lt;&lt;toggleTag Done [[%0]] -&gt;&gt;'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
		' [[%0]] }}}',
		[
			this.title
		]
	);},

	render_ProjectHeading: function() { return this.renderUtil(
		'{{project{'+
		'[[%0]] '+
		'&lt;&lt;toggleTag Complete [[%0]] -&gt;&gt;'+
		'@@font-size:80%;&lt;&lt;multiToggleTag tag:ProjectStatus title:[[%0]]&gt;&gt;@@'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
 		'}}}',
		[
			this.title
		]
	);},

	render_Context: function() { return this.renderUtil(
		'[[%0]]',
		[
			this.title
		]
	);},

	render_plain: function() { return this.renderUtil(
		'{{plain{[[%0]]}}}',
		[
			this.title
		]
	);},

	render_star: function() { return this.renderUtil(
		'{{plain{'+
		'&lt;&lt;singleToggleTag tag:Starred title:[[%0]]&gt;&gt;'+
        '[[%0]]}}}',
		[
			this.title
		]
	);},


	// TODO. this seems stupid
	render_bold: function() { return this.renderUtil(
		&quot;[[%0]]&quot;,
		[
			this.title
		]
	);}


});


</pre>
</div>
<div title="TitleButtons" modifier="YourName" created="200805211151" modified="200805221358" tags="excludeSearch">
<pre>!Project
&lt;!--{{{--&gt;
&lt;div class=&quot;projectcontrols controls controlstint&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Realm:&lt;/span&gt;&lt;span macro=&quot;multiSelectTag Realm allowNone:on&quot;&gt;&lt;/span&gt;
  Project&lt;span macro=&quot;help Project&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span macro=&quot;toggleTag Complete . -&quot;&gt;&lt;/span&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;linkToParent Area '[A]'&quot;&gt;&lt;/span&gt;
  &lt;span macro=&quot;linkToParent Project '[P]'&quot;&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
  [[MonkeyGTDTheme##Subtitle]]
 &lt;/div&gt;
 &lt;div macro=&quot;hideWhenTagged Complete&quot; style=&quot;padding-top:0.25em;padding-bottom:0.25em;&quot;&gt;
  &lt;span macro=&quot;multiToggleTag ProjectStatus longVersion:on&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;div class=&quot;floatright&quot; macro=&quot;convertToFromTickler&quot;&gt;&lt;br/&gt;&lt;/div&gt;
  &lt;div class=&quot;floatright&quot; macro=&quot;deleteAllTagged 'delete project' '' 'delete'&quot;&gt;&lt;br/&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Area:&lt;/span&gt;&lt;br&gt;&lt;span macro=&quot;multiSelectTag Area allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Area&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Subproject of&lt;/span&gt;:&lt;br&gt;&lt;span macro=&quot;multiSelectTag Project allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Project&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Associated contact&lt;/span&gt;:&lt;br&gt;&lt;span macro=&quot;multiSelectTag Contact allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Contact&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;clearboth&quot;&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Action
&lt;!--{{{--&gt;
&lt;div class=&quot;actioncontrols controls controlstint&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Realm:&lt;/span&gt;&lt;span macro=&quot;multiSelectTag Realm allowNone:on&quot;&gt;&lt;/span&gt;
  Action&lt;span macro=&quot;help Action&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span macro=&quot;toggleTag Done . -&quot;&gt;&lt;/span&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;linkToParent Project '[P]'&quot;&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
  [[MonkeyGTDTheme##Subtitle]]
 &lt;/div&gt;
 &lt;div macro=&quot;hideWhenTagged Done&quot; style=&quot;padding-top:0.25em;padding-bottom:0.25em;&quot;&gt;
  &lt;span macro=&quot;multiToggleTag ActionStatus longVersion:on&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div macro=&quot;showWhen config.mGTD.getOptChk('MultipleContexts')&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Context:&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;unboldLinks&quot; macro=&quot;groupOfSingleToggleTags Context useCheckbox:yes&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;div class=&quot;floatright&quot; macro=&quot;convertToFromTickler&quot;&gt;&lt;br/&gt;&lt;/div&gt;
  &lt;div class=&quot;floatright&quot; macro=&quot;convertActionToSubProj&quot;&gt;&lt;br/&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot; macro=&quot;else&quot;&gt;&lt;span class=&quot;label&quot;&gt;Context:&lt;/span&gt;&lt;br/&gt;&lt;span macro=&quot;multiSelectTag Context allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Context&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Project:&lt;/span&gt;&lt;br/&gt;&lt;span macro=&quot;multiSelectTag Project allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Project&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div macro=&quot;hideWhen tiddler.hasParent('Project')&quot; class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Area:&lt;/span&gt;&lt;br&gt;&lt;span macro=&quot;multiSelectTag Area allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Area&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;
   &lt;span macro=&quot;hideWhenTaggedAny 'Waiting For' 'Done'&quot; class=&quot;label&quot;&gt;Associated contact:&lt;/span&gt;
   &lt;span macro=&quot;else&quot; class=&quot;label&quot;&gt;Delegated to/waiting on:&lt;/span&gt;&lt;br&gt;
   &lt;span macro=&quot;multiSelectTag Contact allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Contact&quot;&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class=&quot;clearboth&quot;&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Tickler
&lt;!--{{{--&gt;
&lt;div class=&quot;ticklercontrols controls controlstint&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Realm:&lt;/span&gt;&lt;span macro=&quot;multiSelectTag Realm allowNone:on&quot;&gt;&lt;/span&gt;
  Tickler&lt;span macro=&quot;help Tickler&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span macro=&quot;showWhen tiddler.tags.contains('Once') || !tiddler.hasParent('TicklerRepeatType')&quot;&gt;
   &lt;span macro=&quot;toggleTag Actioned . -&quot;&gt;&lt;/span&gt;
  &lt;/span&gt;
  &lt;span macro=&quot;showWhenTagged 'Daily'&quot;   &gt;&lt;span macro=&quot;addDay&quot;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span macro=&quot;showWhenTagged 'Weekly'&quot;  &gt;&lt;span macro=&quot;addWeek&quot;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span macro=&quot;showWhenTagged 'Monthly'&quot; &gt;&lt;span macro=&quot;addMonth&quot;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span macro=&quot;showWhenTagged 'Yearly'&quot;  &gt;&lt;span macro=&quot;addYear&quot;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;linkToParent Area '[A]'&quot;&gt;&lt;/span&gt;
  &lt;span macro=&quot;linkToParent Project '[P]'&quot;&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
  [[MonkeyGTDTheme##Subtitle]]
 &lt;/div&gt;
 &lt;div macro=&quot;hideWhenTagged Actioned&quot; style=&quot;padding-top:0.25em;padding-bottom:0.25em;&quot;&gt;
  &lt;span macro=&quot;multiToggleTag TicklerRepeatType longVersion:on&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Tickler date:&lt;/span&gt;&lt;br/&gt;&lt;span macro=&quot;dateChooser&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft buttonsLikeLinks&quot;&gt;&lt;br&gt;
   &lt;span macro=&quot;addDay&quot;&gt;&lt;/span&gt;
   &lt;span macro=&quot;addWeek&quot;&gt;&lt;/span&gt;
   &lt;span macro=&quot;addMonth&quot;&gt;&lt;/span&gt;
   &lt;span macro=&quot;addYear&quot;&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class=&quot;clearboth&quot;&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;div class=&quot;floatright&quot; macro=&quot;convertToFromTickler&quot;&gt;&lt;br/&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Project:&lt;/span&gt;&lt;br/&gt;&lt;span macro=&quot;multiSelectTag Project allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Project&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div macro=&quot;hideWhen tiddler.hasParent('Project')&quot; class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Area:&lt;/span&gt;&lt;br&gt;&lt;span macro=&quot;multiSelectTag Area allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Area&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Associated contact&lt;/span&gt;:&lt;br&gt;&lt;span macro=&quot;multiSelectTag Contact allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Contact&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;clearboth&quot;&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!View
&lt;!--{{{--&gt;
&lt;div class=&quot;viewcontrols controls&quot;&gt;
 &lt;div&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;&lt;span macro=&quot;help&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Context
&lt;!--{{{--&gt;
&lt;div class=&quot;contextcontrols controls&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  Context&lt;span macro=&quot;help Context&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Area
&lt;!--{{{--&gt;
&lt;div class=&quot;areacontrols controls&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Realm:&lt;/span&gt;&lt;span macro=&quot;multiSelectTag Realm allowNone:on&quot;&gt;&lt;/span&gt;
  Area&lt;span macro=&quot;help Area&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Realm
&lt;!--{{{--&gt;
&lt;div class=&quot;realmcontrols controls&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  Realm&lt;span macro=&quot;help Realm&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Reference
&lt;!--{{{--&gt;
&lt;div class=&quot;referencecontrols controls controlstint&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Realm:&lt;/span&gt;&lt;span macro=&quot;multiSelectTag Realm allowNone:on&quot;&gt;&lt;/span&gt;
  Reference&lt;span macro=&quot;help Reference&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;linkToParent Project '[P]'&quot;&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
  [[MonkeyGTDTheme##Subtitle]]
 &lt;/div&gt;
 &lt;div&gt;
  &lt;div class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Project:&lt;/span&gt;&lt;br&gt;&lt;span macro=&quot;multiSelectTag Project allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Project&quot;&gt;&lt;/span&gt;&lt;/div&gt;
  &lt;div macro=&quot;hideWhen tiddler.hasParent('Project')&quot; class=&quot;floatleft&quot;&gt;&lt;span class=&quot;label&quot;&gt;Area:&lt;/span&gt;&lt;br&gt;&lt;span macro=&quot;multiSelectTag Area allowNone:on&quot;&gt;&lt;/span&gt;&lt;span macro=&quot;linkToParent Area&quot;&gt;&lt;/span&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class=&quot;clearboth&quot;&gt;&lt;/div&gt;
 &lt;div style=&quot;padding-top:1em;&quot;&gt;
  Double click or click &quot;edit&quot; to edit. Use &quot;new here&quot; to make sub item.
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

!Contact
&lt;!--{{{--&gt;
&lt;div class=&quot;contactcontrols controls&quot;&gt;
 &lt;div style=&quot;float:right;&quot; class=&quot;smaller&quot;&gt;
  &lt;span class=&quot;label&quot;&gt;Realm:&lt;/span&gt;&lt;span macro=&quot;multiSelectTag Realm allowNone:on&quot;&gt;&lt;/span&gt;
  Contact&lt;span macro=&quot;help Contact&quot;&gt;&lt;/span&gt;
 &lt;/div&gt;
 &lt;div&gt;
  &lt;span class='title' macro='view title'&gt;&lt;/span&gt;
  &lt;span macro=&quot;singleToggleTag tag:Starred&quot;&gt;&lt;/span&gt;
  [[MonkeyGTDTheme##Subtitle]]
 &lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;

</pre>
</div>
<div title="TitleButtonsSelector" modifier="YourName" created="200805221358" modified="200805221358" tags="excludeSearch">
<pre>&lt;div macro=&quot;showWhenTagged 'Project'&quot;&gt;[[TitleButtons##Project]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Action'&quot;&gt;[[TitleButtons##Action]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Tickler'&quot;&gt;[[TitleButtons##Tickler]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'View'&quot;&gt;[[TitleButtons##View]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Context'&quot;&gt;[[TitleButtons##Context]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Area'&quot;&gt;[[TitleButtons##Area]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Realm'&quot;&gt;[[TitleButtons##Realm]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Reference'&quot;&gt;[[TitleButtons##Reference]]&lt;/div&gt;
&lt;div macro=&quot;showWhenTagged 'Contact'&quot;&gt;[[TitleButtons##Contact]]&lt;/div&gt;
</pre>
</div>
<div title="ToggleSideBarMacro" modifier="YourName" created="200805061349" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>// Created by Saq. Taken from tw.lewcid.org

config.macros.toggleSideBar={};

config.macros.toggleSideBar.settings={
         styleHide :  &quot;#sidebar { display: none;}\n&quot;+&quot;#contentWrapper #displayArea { margin-right: 1em;}\n&quot;+&quot;&quot;,
         styleShow : &quot; &quot;,
         arrow1: &quot;&lt;&lt;&quot;,
         arrow2: &quot;&gt;&gt;&quot;
         //arrow1: &quot;�&quot;,
         //arrow2: &quot;�&quot;
};

config.macros.toggleSideBar.handler=function (place,macroName,params,wikifier,paramString,tiddler)
{
          var tooltip= params[1]||'toggle sidebar';
          var mode = (params[2] &amp;&amp; params[2]==&quot;hide&quot;)? &quot;hide&quot;:&quot;show&quot;;
          var arrow = (mode == &quot;hide&quot;)? this.settings.arrow1:this.settings.arrow2;
          var label= (params[0]&amp;&amp;params[0]!='.')?params[0]+&quot; &quot;+arrow:arrow;
          var theBtn = createTiddlyButton(place,label,tooltip,this.onToggleSideBar,&quot;button HideSideBarButton&quot;);
          if (mode == &quot;hide&quot;)
             { 
             (document.getElementById(&quot;sidebar&quot;)).setAttribute(&quot;toggle&quot;,&quot;hide&quot;);
              setStylesheet(this.settings.styleHide,&quot;ToggleSideBarStyles&quot;);
             }
};

config.macros.toggleSideBar.onToggleSideBar = function(){
          var sidebar = document.getElementById(&quot;sidebar&quot;);
          var settings = config.macros.toggleSideBar.settings;
          if (sidebar.getAttribute(&quot;toggle&quot;)=='hide')
             {
              setStylesheet(settings.styleShow,&quot;ToggleSideBarStyles&quot;);
              sidebar.setAttribute(&quot;toggle&quot;,&quot;show&quot;);
              this.firstChild.data= (this.firstChild.data).replace(settings.arrow1,settings.arrow2);
              }
          else
              {    
               setStylesheet(settings.styleHide,&quot;ToggleSideBarStyles&quot;);
               sidebar.setAttribute(&quot;toggle&quot;,&quot;hide&quot;);
               this.firstChild.data= (this.firstChild.data).replace(settings.arrow2,settings.arrow1);
              }

     return false;
}

</pre>
</div>
<div title="ToggleTagPlugin" modifier="MPTW" created="200804271053" modified="200805101525" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|Name:|ToggleTagPlugin|
|Description:|Makes a checkbox which toggles a tag in a tiddler|
|Version:|3.1.0 ($Rev: 4331 $)|
|Date:|$Date: 2008-04-12 13:42:50 +1000 (Sat, 12 Apr 2008) $|
|Source:|http://mptw.tiddlyspot.com/#ToggleTagPlugin|
|Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
|License:|http://mptw.tiddlyspot.com/#TheBSDLicense|
!!Usage
{{{&lt;&lt;toggleTag }}}//{{{TagName TiddlerName LabelText}}}//{{{&gt;&gt;}}}
* TagName - the tag to be toggled, default value &quot;checked&quot;
* TiddlerName - the tiddler to toggle the tag in, default value the current tiddler
* LabelText - the text (gets wikified) to put next to the check box, default value is '{{{[[TagName]]}}}' or '{{{[[TagName]] [[TiddlerName]]}}}'
(If a parameter is '.' then the default will be used)
* TouchMod flag - if non empty then touch the tiddlers mod date. Note, can set config.toggleTagAlwaysTouchModDate to always touch mod date
!!Examples
|Code|Description|Example|h
|{{{&lt;&lt;toggleTag&gt;&gt;}}}|Toggles the default tag (checked) in this tiddler|&lt;&lt;toggleTag&gt;&gt;|
|{{{&lt;&lt;toggleTag TagName&gt;&gt;}}}|Toggles the TagName tag in this tiddler|&lt;&lt;toggleTag TagName&gt;&gt;|
|{{{&lt;&lt;toggleTag TagName TiddlerName&gt;&gt;}}}|Toggles the TagName tag in the TiddlerName tiddler|&lt;&lt;toggleTag TagName TiddlerName&gt;&gt;|
|{{{&lt;&lt;toggleTag TagName TiddlerName 'click me'&gt;&gt;}}}|Same but with custom label|&lt;&lt;toggleTag TagName TiddlerName 'click me'&gt;&gt;|
|{{{&lt;&lt;toggleTag . . 'click me'&gt;&gt;}}}|dot means use default value|&lt;&lt;toggleTag . . 'click me'&gt;&gt;|
!!Notes
* If TiddlerName doesn't exist it will be silently created
* Set label to '-' to specify no label
* See also http://mgtd-alpha.tiddlyspot.com/#ToggleTag2
!!Known issues
* Doesn't smoothly handle the case where you toggle a tag in a tiddler that is current open for editing
* Should convert to use named params
***/
//{{{

if (config.toggleTagAlwaysTouchModDate == undefined) config.toggleTagAlwaysTouchModDate = false;

merge(config.macros,{

	toggleTag: {

		createIfRequired: true,
		shortLabel: &quot;[[%0]]&quot;,
		longLabel: &quot;[[%0]] [[%1]]&quot;,

		handler: function(place,macroName,params,wikifier,paramString,tiddler) {
			var tiddlerTitle = tiddler ? tiddler.title : '';
			var tag   = (params[0] &amp;&amp; params[0] != '.') ? params[0] : &quot;checked&quot;;
			var title = (params[1] &amp;&amp; params[1] != '.') ? params[1] : tiddlerTitle;
			var defaultLabel = (title == tiddlerTitle ? this.shortLabel : this.longLabel);
			var label = (params[2] &amp;&amp; params[2] != '.') ? params[2] : defaultLabel;
			var touchMod = (params[3] &amp;&amp; params[3] != '.') ? params[3] : &quot;&quot;;
			label = (label == '-' ? '' : label); // dash means no label
			var theTiddler = (title == tiddlerTitle ? tiddler : store.getTiddler(title));
			var cb = createTiddlyCheckbox(place, label.format([tag,title]), theTiddler &amp;&amp; theTiddler.isTagged(tag), function(e) {
				if (!store.tiddlerExists(title)) {
					if (config.macros.toggleTag.createIfRequired) {
						var content = store.getTiddlerText(title); // just in case it's a shadow
						store.saveTiddler(title,title,content?content:&quot;&quot;,config.options.txtUserName,new Date(),null);
					}
					else 
						return false;
				}
				if ((touchMod != &quot;&quot; || config.toggleTagAlwaysTouchModDate) &amp;&amp; theTiddler)
						theTiddler.modified = new Date();
				store.setTiddlerTag(title,this.checked,tag);
				return true;
			});
		}
	}
});

//}}}

</pre>
</div>
<div title="WK-баги-1" modifier="YourName" created="200805261217" modified="200905130021" tags="Action Next Personal Поправить" changecount="16">
<pre>- WC: напоминание из заметки в календаре не пашет
----
- на горячую клавишу добавить параметр - список приложений в которых она запрещена/разрешена
- Lua scripts
- script Xml-format
- http://mail.google.com/mail/#label/Support/11f30775a3a8769c
----
Hotkey mess
http://mail.google.com/mail/?zx=1at02by0ix5c2&amp;shva=1#inbox/11e0709ad0f3ed83
----
на окно la2 приходится делать ряд действий, чтобы отключить alwaysontop.
----
When plugin &quot;Shell Extender&quot; is active, one can use it to change the offered folder to an own one. That works. Fine. But: when opening the windows folder dialog, most programs offer a filename (e.g. &quot;myfilename.htm&quot;). After using the &quot;jump to favorite folder&quot;-hotkey, this filename is gone (empty after changing the folder). One advantage (favorite folder) is eating up another (presenting a filename). That's a pitty.
----
It seams every time my laptop wakes up after sleep mode - wirekeys clipboard history stops working (freezes). It was like this in older versions too.
</pre>
</div>
<div title="WK-идеи-1" modifier="YourName" created="200805261216" modified="200902200453" tags="Action Next Personal На_будущее" changecount="11">
<pre>- список приложений для скрытия из окошка процессов (svchost например), отключаемо по шифту
- опция показывать в меню и макросы тоже (а не только квик-раны)
- поддержка нескольких десктопов в висте
- Добавить экшен при закрытии ВК
- При запуске консольного mplayer с ключом -ontop при переключении из него то приложение, которое оказывается поверх всех, становится alwaysontop
- действия при выключении/включении, запуск приложений с задержкой
- управление звуком в висте
</pre>
</div>
<div title="WN-идеи-1" modifier="YourName" created="200807241109" modified="200812290815" changecount="2">
<pre>- Импорт/экспорт замекток, туду, напоминаний
- http://mail.google.com/mail/#label/Notes/11cc759f14e956de
- http://mail.google.com/mail/#label/Musor/11e8186918f58d3c</pre>
</div>
<div title="Waiting For" modifier="YourName" created="200805221358" modified="200805221358" tags="ActionStatus">
<pre>order:2
button:w
buttonLong:waiting for
</pre>
</div>
<div title="Weekly" modifier="YourName" created="200805221358" modified="200805221358" tags="TicklerRepeatType">
<pre>order:2
button:week
buttonLong:weekly
</pre>
</div>
<div title="WС-идеи-1" modifier="YourName" created="200806270228" modified="200808300951" changecount="2">
<pre>- рамки на воллпапер по текущему времени
- вычислять сколько недель в месяце
- Сделать ораничения на время появления. если например стоит поялвение напоминания раз в 15 минут то указать еще часы - &quot;с  8и до 15&quot; и т.п.
- пропуск напоминания которое сработало когда WC был выключен
- если один и тотже ремаиндер открывть раз 5, то при закрытиях 4ое окошко этого ремаиндера роняет систему!</pre>
</div>
<div title="Yearly" modifier="YourName" created="200805221358" modified="200805221358" tags="TicklerRepeatType">
<pre>order:4
button:year
buttonLong:yearly
</pre>
</div>
<div title="YourSearchPlugin" modifier="YourName" created="200804231346" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>/***
|''Name:''|YourSearchPlugin|
|''Version:''|2.1.3 (2008-04-16)|
|''Source:''|http://tiddlywiki.abego-software.de/#YourSearchPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|
|''Copyright:''|&amp;copy; 2005-2008 [[abego Software|http://www.abego-software.de]]|
|''~CoreVersion:''|2.1.0|
|''Community:''|[[del.icio.us|http://del.icio.us/post?url=http://tiddlywiki.abego-software.de/index.html%23YourSearchPlugin]]|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; ~InternetExplorer 6.0|
!About YourSearch
YourSearch gives you a bunch of new features to simplify and speed up your daily searches in TiddlyWiki. It seamlessly integrates into the standard TiddlyWiki search: just start typing into the 'search' field and explore!

For more information see [[Help|YourSearch Help]].
!Compatibility
This plugin requires TiddlyWiki 2.1. 
Check the [[archive|http://tiddlywiki.abego-software.de/archive]] for ~YourSearchPlugins supporting older versions of TiddlyWiki.
!Source Code
***/
/***
This plugin's source code is compressed (and hidden). Use this [[link|http://tiddlywiki.abego-software.de/archive/YourSearchPlugin/Plugin-YourSearch-src.2.1.3.js]] to get the readable source code.
***/
///%
if(!version.extensions.YourSearchPlugin){version.extensions.YourSearchPlugin={major:2,minor:1,revision:3,source:&quot;http://tiddlywiki.abego-software.de/#YourSearchPlugin&quot;,licence:&quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,copyright:&quot;Copyright (c) abego Software GmbH, 2005-2008 (www.abego-software.de)&quot;};if(!window.abego){window.abego={};}
if(!Array.forEach){Array.forEach=function(_1,_2,_3){for(var i=0,len=_1.length;i&lt;len;i++){_2.call(_3,_1[i],i,_1);}};Array.prototype.forEach=function(_5,_6){for(var i=0,len=this.length;i&lt;len;i++){_5.call(_6,this[i],i,this);}};}
abego.toInt=function(s,_9){if(!s){return _9;}
var n=parseInt(s);return(n==NaN)?_9:n;};abego.createEllipsis=function(_b){var e=createTiddlyElement(_b,&quot;span&quot;);e.innerHTML=&quot;&amp;hellip;&quot;;};abego.shallowCopy=function(_d){if(!_d){return _d;}
var _e={};for(var n in _d){_e[n]=_d[n];}
return _e;};abego.copyOptions=function(_10){return!_10?{}:abego.shallowCopy(_10);};abego.countStrings=function(_11,s){if(!s){return 0;}
var len=s.length;var n=0;var _15=0;while(1){var i=_11.indexOf(s,_15);if(i&lt;0){return n;}
n++;_15=i+len;}
return n;};abego.getBracedText=function(_17,_18,_19){if(!_18){_18=0;}
var re=/\{([^\}]*)\}/gm;re.lastIndex=_18;var m=re.exec(_17);if(m){var s=m[1];var _1d=abego.countStrings(s,&quot;{&quot;);if(!_1d){if(_19){_19.lastIndex=re.lastIndex;}
return s;}
var len=_17.length;for(var i=re.lastIndex;i&lt;len&amp;&amp;_1d;i++){var c=_17.charAt(i);if(c==&quot;{&quot;){_1d++;}else{if(c==&quot;}&quot;){_1d--;}}}
if(!_1d){if(_19){_19.lastIndex=i-1;}
return _17.substring(m.index+1,i-1);}}};abego.select=function(_21,_22,_23,_24){if(!_24){_24=[];}
_21.forEach(function(t){if(_22.call(_23,t)){_24.push(t);}});return _24;};abego.consumeEvent=function(e){if(e.stopPropagation){e.stopPropagation();}
if(e.preventDefault){e.preventDefault();}
e.cancelBubble=true;e.returnValue=true;};abego.TiddlerFilterTerm=function(_27,_28){if(!_28){_28={};}
var _29=_27;if(!_28.textIsRegExp){_29=_27.escapeRegExp();if(_28.fullWordMatch){_29=&quot;\\b&quot;+_29+&quot;\\b&quot;;}}
var _2a=new RegExp(_29,&quot;m&quot;+(_28.caseSensitive?&quot;&quot;:&quot;i&quot;));this.tester=new abego.MultiFieldRegExpTester(_2a,_28.fields,_28.withExtendedFields);};abego.TiddlerFilterTerm.prototype.test=function(_2b){return this.tester.test(_2b);};abego.parseNewTiddlerCommandLine=function(s){var m=/(.*?)\.(?:\s+|$)([^#]*)(#.*)?/.exec(s);if(!m){m=/([^#]*)()(#.*)?/.exec(s);}
if(m){var r;if(m[3]){var s2=m[3].replace(/#/g,&quot;&quot;);r=s2.parseParams(&quot;tag&quot;);}else{r=[[]];}
var _30=m[2]?m[2].trim():&quot;&quot;;r.push({name:&quot;text&quot;,value:_30});r[0].text=[_30];return{title:m[1].trim(),params:r};}else{return{title:s.trim(),params:[[]]};}};abego.parseTiddlerFilterTerm=function(_31,_32,_33){var re=/\s*(?:(?:\{([^\}]*)\})|(?:(=)|([#%!])|(?:(\w+)\s*\:(?!\/\/))|(?:(?:(&quot;(?:(?:\\&quot;)|[^&quot;])+&quot;)|(?:\/((?:(?:\\\/)|[^\/])+)\/)|(\w+\:\/\/[^\s]+)|([^\s\)\-\&quot;]+)))))/mg;var _35={&quot;!&quot;:&quot;title&quot;,&quot;%&quot;:&quot;text&quot;,&quot;#&quot;:&quot;tags&quot;};var _36={};var _37;re.lastIndex=_32;while(1){var i=re.lastIndex;var m=re.exec(_31);if(!m||m.index!=i){throw&quot;Word or String literal expected&quot;;}
if(m[1]){var _3a={};var _3b=abego.getBracedText(_31,0,_3a);if(!_3b){throw&quot;Invalid {...} syntax&quot;;}
var f=Function(&quot;tiddler&quot;,&quot;return (&quot;+_3b+&quot;);&quot;);return{func:f,lastIndex:_3a.lastIndex,markRE:null};}
if(m[2]){_37=true;}else{if(m[3]){_36[_35[m[3]]]=1;}else{if(m[4]){_36[m[4]]=1;}else{var _3d=m[6];var _3e=m[5]?window.eval(m[5]):m[6]?m[6]:m[7]?m[7]:m[8];var _33=abego.copyOptions(_33);_33.fullWordMatch=_37;_33.textIsRegExp=_3d;var _3f=[];for(var n in _36){_3f.push(n);}
if(_3f.length==0){_33.fields=_33.defaultFields;}else{_33.fields=_3f;_33.withExtendedFields=false;}
var _41=new abego.TiddlerFilterTerm(_3e,_33);var _42=_3d?_3e:_3e.escapeRegExp();if(_42&amp;&amp;_37){_42=&quot;\\b&quot;+_42+&quot;\\b&quot;;}
return{func:function(_43){return _41.test(_43);},lastIndex:re.lastIndex,markRE:_42?&quot;(?:&quot;+_42+&quot;)&quot;:null};}}}}};abego.BoolExp=function(s,_45,_46){this.s=s;var _47=_46&amp;&amp;_46.defaultOperationIs_OR;var _48=/\s*(?:(\-|not)|(\())/gi;var _49=/\s*\)/g;var _4a=/\s*(?:(and|\&amp;\&amp;)|(or|\|\|))/gi;var _4b=/\s*[^\)\s]/g;var _4c=/\s*(\-|not)?(\s*\()?/gi;var _4d;var _4e=function(_4f){_4c.lastIndex=_4f;var m=_4c.exec(s);var _51;var _52;if(m&amp;&amp;m.index==_4f){_4f+=m[0].length;_51=m[1];if(m[2]){var e=_4d(_4f);_49.lastIndex=e.lastIndex;if(!_49.exec(s)){throw&quot;Missing ')'&quot;;}
_52={func:e.func,lastIndex:_49.lastIndex,markRE:e.markRE};}}
if(!_52){_52=_45(s,_4f,_46);}
if(_51){_52.func=(function(f){return function(_55){return!f(_55);};})(_52.func);_52.markRE=null;}
return _52;};_4d=function(_56){var _57=_4e(_56);while(1){var l=_57.lastIndex;_4a.lastIndex=l;var m=_4a.exec(s);var _5a;var _5b;if(m&amp;&amp;m.index==l){_5a=!m[1];_5b=_4e(_4a.lastIndex);}else{try{_5b=_4e(l);}
catch(e){return _57;}
_5a=_47;}
_57.func=(function(_5c,_5d,_5e){return _5e?function(_5f){return _5c(_5f)||_5d(_5f);}:function(_60){return _5c(_60)&amp;&amp;_5d(_60);};})(_57.func,_5b.func,_5a);_57.lastIndex=_5b.lastIndex;if(!_57.markRE){_57.markRE=_5b.markRE;}else{if(_5b.markRE){_57.markRE=_57.markRE+&quot;|&quot;+_5b.markRE;}}}};var _61=_4d(0);this.evalFunc=_61.func;if(_61.markRE){this.markRegExp=new RegExp(_61.markRE,_46.caseSensitive?&quot;mg&quot;:&quot;img&quot;);}};abego.BoolExp.prototype.exec=function(){return this.evalFunc.apply(this,arguments);};abego.BoolExp.prototype.getMarkRegExp=function(){return this.markRegExp;};abego.BoolExp.prototype.toString=function(){return this.s;};abego.MultiFieldRegExpTester=function(re,_63,_64){this.re=re;this.fields=_63?_63:[&quot;title&quot;,&quot;text&quot;,&quot;tags&quot;];this.withExtendedFields=_64;};abego.MultiFieldRegExpTester.prototype.test=function(_65){var re=this.re;for(var i=0;i&lt;this.fields.length;i++){var s=store.getValue(_65,this.fields[i]);if(typeof s==&quot;string&quot;&amp;&amp;re.test(s)){return this.fields[i];}}
if(this.withExtendedFields){return store.forEachField(_65,function(_69,_6a,_6b){return typeof _6b==&quot;string&quot;&amp;&amp;re.test(_6b)?_6a:null;},true);}
return null;};abego.TiddlerQuery=function(_6c,_6d,_6e,_6f,_70){if(_6e){this.regExp=new RegExp(_6c,_6d?&quot;mg&quot;:&quot;img&quot;);this.tester=new abego.MultiFieldRegExpTester(this.regExp,_6f,_70);}else{this.expr=new abego.BoolExp(_6c,abego.parseTiddlerFilterTerm,{defaultFields:_6f,caseSensitive:_6d,withExtendedFields:_70});}
this.getQueryText=function(){return _6c;};this.getUseRegExp=function(){return _6e;};this.getCaseSensitive=function(){return _6d;};this.getDefaultFields=function(){return _6f;};this.getWithExtendedFields=function(){return _70;};};abego.TiddlerQuery.prototype.test=function(_71){if(!_71){return false;}
if(this.regExp){return this.tester.test(_71);}
return this.expr.exec(_71);};abego.TiddlerQuery.prototype.filter=function(_72){return abego.select(_72,this.test,this);};abego.TiddlerQuery.prototype.getMarkRegExp=function(){if(this.regExp){return&quot;&quot;.search(this.regExp)&gt;=0?null:this.regExp;}
return this.expr.getMarkRegExp();};abego.TiddlerQuery.prototype.toString=function(){return(this.regExp?this.regExp:this.expr).toString();};abego.PageWiseRenderer=function(){this.firstIndexOnPage=0;};merge(abego.PageWiseRenderer.prototype,{setItems:function(_73){this.items=_73;this.setFirstIndexOnPage(0);},getMaxPagesInNavigation:function(){return 10;},getItemsCount:function(_74){return this.items?this.items.length:0;},getCurrentPageIndex:function(){return Math.floor(this.firstIndexOnPage/this.getItemsPerPage());},getLastPageIndex:function(){return Math.floor((this.getItemsCount()-1)/this.getItemsPerPage());},setFirstIndexOnPage:function(_75){this.firstIndexOnPage=Math.min(Math.max(0,_75),this.getItemsCount()-1);},getFirstIndexOnPage:function(){this.firstIndexOnPage=Math.floor(this.firstIndexOnPage/this.getItemsPerPage())*this.getItemsPerPage();return this.firstIndexOnPage;},getLastIndexOnPage:function(){return Math.min(this.getFirstIndexOnPage()+this.getItemsPerPage()-1,this.getItemsCount()-1);},onPageChanged:function(_76,_77){},renderPage:function(_78){if(_78.beginRendering){_78.beginRendering(this);}
try{if(this.getItemsCount()){var _79=this.getLastIndexOnPage();var _7a=-1;for(var i=this.getFirstIndexOnPage();i&lt;=_79;i++){_7a++;_78.render(this,this.items[i],i,_7a);}}}
finally{if(_78.endRendering){_78.endRendering(this);}}},addPageNavigation:function(_7c){if(!this.getItemsCount()){return;}
var _7d=this;var _7e=function(e){if(!e){var e=window.event;}
abego.consumeEvent(e);var _80=abego.toInt(this.getAttribute(&quot;page&quot;),0);var _81=_7d.getCurrentPageIndex();if(_80==_81){return;}
var _82=_80*_7d.getItemsPerPage();_7d.setFirstIndexOnPage(_82);_7d.onPageChanged(_80,_81);};var _83;var _84=this.getCurrentPageIndex();var _85=this.getLastPageIndex();if(_84&gt;0){_83=createTiddlyButton(_7c,&quot;Previous&quot;,&quot;Go to previous page (Shortcut: Alt-'&lt;')&quot;,_7e,&quot;prev&quot;);_83.setAttribute(&quot;page&quot;,(_84-1).toString());_83.setAttribute(&quot;accessKey&quot;,&quot;&lt;&quot;);}
for(var i=-this.getMaxPagesInNavigation();i&lt;this.getMaxPagesInNavigation();i++){var _87=_84+i;if(_87&lt;0){continue;}
if(_87&gt;_85){break;}
var _88=(i+_84+1).toString();var _89=_87==_84?&quot;currentPage&quot;:&quot;otherPage&quot;;_83=createTiddlyButton(_7c,_88,&quot;Go to page %0&quot;.format([_88]),_7e,_89);_83.setAttribute(&quot;page&quot;,(_87).toString());}
if(_84&lt;_85){_83=createTiddlyButton(_7c,&quot;Next&quot;,&quot;Go to next page (Shortcut: Alt-'&gt;')&quot;,_7e,&quot;next&quot;);_83.setAttribute(&quot;page&quot;,(_84+1).toString());_83.setAttribute(&quot;accessKey&quot;,&quot;&gt;&quot;);}}});abego.LimitedTextRenderer=function(){var _8a=40;var _8b=4;var _8c=function(_8d,_8e,_8f){var n=_8d.length;if(n==0){_8d.push({start:_8e,end:_8f});return;}
var i=0;for(;i&lt;n;i++){var _92=_8d[i];if(_92.start&lt;=_8f&amp;&amp;_8e&lt;=_92.end){var r;var _94=i+1;for(;_94&lt;n;_94++){r=_8d[_94];if(r.start&gt;_8f||_8e&gt;_92.end){break;}}
var _95=_8e;var _96=_8f;for(var j=i;j&lt;_94;j++){r=_8d[j];_95=Math.min(_95,r.start);_96=Math.max(_96,r.end);}
_8d.splice(i,_94-i,{start:_95,end:_96});return;}
if(_92.start&gt;_8f){break;}}
_8d.splice(i,0,{start:_8e,end:_8f});};var _98=function(_99){var _9a=0;for(var i=0;i&lt;_99.length;i++){var _9c=_99[i];_9a+=_9c.end-_9c.start;}
return _9a;};var _9d=function(c){return(c&gt;=&quot;a&quot;&amp;&amp;c&lt;=&quot;z&quot;)||(c&gt;=&quot;A&quot;&amp;&amp;c&lt;=&quot;Z&quot;)||c==&quot;_&quot;;};var _9f=function(s,_a1){if(!_9d(s[_a1])){return null;}
for(var i=_a1-1;i&gt;=0&amp;&amp;_9d(s[i]);i--){}
var _a3=i+1;var n=s.length;for(i=_a1+1;i&lt;n&amp;&amp;_9d(s[i]);i++){}
return{start:_a3,end:i};};var _a5=function(s,_a7,_a8){var _a9;if(_a8){_a9=_9f(s,_a7);}else{if(_a7&lt;=0){return _a7;}
_a9=_9f(s,_a7-1);}
if(!_a9){return _a7;}
if(_a8){if(_a9.start&gt;=_a7-_8b){return _a9.start;}
if(_a9.end&lt;=_a7+_8b){return _a9.end;}}else{if(_a9.end&lt;=_a7+_8b){return _a9.end;}
if(_a9.start&gt;=_a7-_8b){return _a9.start;}}
return _a7;};var _aa=function(s,_ac){var _ad=[];if(_ac){var _ae=0;var n=s.length;var _b0=0;do{_ac.lastIndex=_ae;var _b1=_ac.exec(s);if(_b1){if(_ae&lt;_b1.index){var t=s.substring(_ae,_b1.index);_ad.push({text:t});}
_ad.push({text:_b1[0],isMatch:true});_ae=_b1.index+_b1[0].length;}else{_ad.push({text:s.substr(_ae)});break;}}while(true);}else{_ad.push({text:s});}
return _ad;};var _b3=function(_b4){var _b5=0;for(var i=0;i&lt;_b4.length;i++){if(_b4[i].isMatch){_b5++;}}
return _b5;};var _b7=function(s,_b9,_ba,_bb,_bc){var _bd=Math.max(Math.floor(_bc/(_bb+1)),_8a);var _be=Math.max(_bd-(_ba-_b9),0);var _bf=Math.min(Math.floor(_ba+_be/3),s.length);var _c0=Math.max(_bf-_bd,0);_c0=_a5(s,_c0,true);_bf=_a5(s,_bf,false);return{start:_c0,end:_bf};};var _c1=function(_c2,s,_c4){var _c5=[];var _c6=_b3(_c2);var pos=0;for(var i=0;i&lt;_c2.length;i++){var t=_c2[i];var _ca=t.text;if(t.isMatch){var _cb=_b7(s,pos,pos+_ca.length,_c6,_c4);_8c(_c5,_cb.start,_cb.end);}
pos+=_ca.length;}
return _c5;};var _cc=function(s,_ce,_cf){var _d0=_cf-_98(_ce);while(_d0&gt;0){if(_ce.length==0){_8c(_ce,0,_a5(s,_cf,false));return;}else{var _d1=_ce[0];var _d2;var _d3;if(_d1.start==0){_d2=_d1.end;if(_ce.length&gt;1){_d3=_ce[1].start;}else{_8c(_ce,_d2,_a5(s,_d2+_d0,false));return;}}else{_d2=0;_d3=_d1.start;}
var _d4=Math.min(_d3,_d2+_d0);_8c(_ce,_d2,_d4);_d0-=(_d4-_d2);}}};var _d5=function(_d6,s,_d8,_d9,_da){if(_d9.length==0){return;}
var _db=function(_dc,s,_de,_df,_e0){var t;var _e2;var pos=0;var i=0;var _e5=0;for(;i&lt;_de.length;i++){t=_de[i];_e2=t.text;if(_df&lt;pos+_e2.length){_e5=_df-pos;break;}
pos+=_e2.length;}
var _e6=_e0-_df;for(;i&lt;_de.length&amp;&amp;_e6&gt;0;i++){t=_de[i];_e2=t.text.substr(_e5);_e5=0;if(_e2.length&gt;_e6){_e2=_e2.substr(0,_e6);}
if(t.isMatch){createTiddlyElement(_dc,&quot;span&quot;,null,&quot;marked&quot;,_e2);}else{createTiddlyText(_dc,_e2);}
_e6-=_e2.length;}
if(_e0&lt;s.length){abego.createEllipsis(_dc);}};if(_d9[0].start&gt;0){abego.createEllipsis(_d6);}
var _e7=_da;for(var i=0;i&lt;_d9.length&amp;&amp;_e7&gt;0;i++){var _e9=_d9[i];var len=Math.min(_e9.end-_e9.start,_e7);_db(_d6,s,_d8,_e9.start,_e9.start+len);_e7-=len;}};this.render=function(_eb,s,_ed,_ee){if(s.length&lt;_ed){_ed=s.length;}
var _ef=_aa(s,_ee);var _f0=_c1(_ef,s,_ed);_cc(s,_f0,_ed);_d5(_eb,s,_ef,_f0,_ed);};};(function(){function alertAndThrow(msg){alert(msg);throw msg;}
if(version.major&lt;2||(version.major==2&amp;&amp;version.minor&lt;1)){alertAndThrow(&quot;YourSearchPlugin requires TiddlyWiki 2.1 or newer.\n\nCheck the archive for YourSearch plugins\nsupporting older versions of TiddlyWiki.\n\nArchive: http://tiddlywiki.abego-software.de/archive&quot;);}
abego.YourSearch={};var _f2;var _f3;var _f4=function(_f5){_f2=_f5;};var _f6=function(){return _f2?_f2:[];};var _f7=function(){return _f2?_f2.length:0;};var _f8=4;var _f9=10;var _fa=2;var _fb=function(s,re){var m=s.match(re);return m?m.length:0;};var _ff=function(_100,_101){var _102=_101.getMarkRegExp();if(!_102){return 1;}
var _103=_100.title.match(_102);var _104=_103?_103.length:0;var _105=_fb(_100.getTags(),_102);var _106=_103?_103.join(&quot;&quot;).length:0;var _107=_100.title.length&gt;0?_106/_100.title.length:0;var rank=_104*_f8+_105*_fa+_107*_f9+1;return rank;};var _109=function(_10a,_10b,_10c,_10d,_10e,_10f){_f3=null;var _110=_10a.reverseLookup(&quot;tags&quot;,_10f,false);try{var _111=[];if(config.options.chkSearchInTitle){_111.push(&quot;title&quot;);}
if(config.options.chkSearchInText){_111.push(&quot;text&quot;);}
if(config.options.chkSearchInTags){_111.push(&quot;tags&quot;);}
_f3=new abego.TiddlerQuery(_10b,_10c,_10d,_111,config.options.chkSearchExtendedFields);}
catch(e){return[];}
var _112=_f3.filter(_110);var _113=abego.YourSearch.getRankFunction();for(var i=0;i&lt;_112.length;i++){var _115=_112[i];var rank=_113(_115,_f3);_115.searchRank=rank;}
if(!_10e){_10e=&quot;title&quot;;}
var _117=function(a,b){var _11a=a.searchRank-b.searchRank;if(_11a==0){if(a[_10e]==b[_10e]){return(0);}else{return(a[_10e]&lt;b[_10e])?-1:+1;}}else{return(_11a&gt;0)?-1:+1;}};_112.sort(_117);return _112;};var _11b=80;var _11c=50;var _11d=250;var _11e=50;var _11f=25;var _120=10;var _121=&quot;yourSearchResult&quot;;var _122=&quot;yourSearchResultItems&quot;;var _123;var _124;var _125;var _126;var _127;var _128=function(){if(version.extensions.YourSearchPlugin.styleSheetInited){return;}
version.extensions.YourSearchPlugin.styleSheetInited=true;setStylesheet(store.getTiddlerText(&quot;YourSearchStyleSheet&quot;),&quot;yourSearch&quot;);};var _129=function(){return _124!=null&amp;&amp;_124.parentNode==document.body;};var _12a=function(){if(_129()){document.body.removeChild(_124);}};var _12b=function(e){_12a();var _12d=this.getAttribute(&quot;tiddlyLink&quot;);if(_12d){var _12e=this.getAttribute(&quot;withHilite&quot;);var _12f=highlightHack;if(_12e&amp;&amp;_12e==&quot;true&quot;&amp;&amp;_f3){highlightHack=_f3.getMarkRegExp();}
story.displayTiddler(this,_12d);highlightHack=_12f;}
return(false);};var _130=function(){if(!_125){return;}
var root=_125;var _132=findPosX(root);var _133=findPosY(root);var _134=root.offsetHeight;var _135=_132;var _136=_133+_134;var _137=findWindowWidth();if(_137&lt;_124.offsetWidth){_124.style.width=(_137-100)+&quot;px&quot;;_137=findWindowWidth();}
var _138=_124.offsetWidth;if(_135+_138&gt;_137){_135=_137-_138-30;}
if(_135&lt;0){_135=0;}
_124.style.left=_135+&quot;px&quot;;_124.style.top=_136+&quot;px&quot;;_124.style.display=&quot;block&quot;;};var _139=function(){if(_124){window.scrollTo(0,ensureVisible(_124));}
if(_125){window.scrollTo(0,ensureVisible(_125));}};var _13a=function(){_130();_139();};var _13b;var _13c;var _13d=new abego.PageWiseRenderer();var _13e=function(_13f){this.itemHtml=store.getTiddlerText(&quot;YourSearchItemTemplate&quot;);if(!this.itemHtml){alertAndThrow(&quot;YourSearchItemTemplate not found&quot;);}
this.place=document.getElementById(_122);if(!this.place){this.place=createTiddlyElement(_13f,&quot;div&quot;,_122);}};merge(_13e.prototype,{render:function(_140,_141,_142,_143){_13b=_143;_13c=_141;var item=createTiddlyElement(this.place,&quot;div&quot;,null,&quot;yourSearchItem&quot;);item.innerHTML=this.itemHtml;applyHtmlMacros(item,null);refreshElements(item,null);},endRendering:function(_145){_13c=null;}});var _146=function(){if(!_124||!_125){return;}
var html=store.getTiddlerText(&quot;YourSearchResultTemplate&quot;);if(!html){html=&quot;&lt;b&gt;Tiddler YourSearchResultTemplate not found&lt;/b&gt;&quot;;}
_124.innerHTML=html;applyHtmlMacros(_124,null);refreshElements(_124,null);var _148=new _13e(_124);_13d.renderPage(_148);_13a();};_13d.getItemsPerPage=function(){var n=(config.options.chkPreviewText)?abego.toInt(config.options.txtItemsPerPageWithPreview,_120):abego.toInt(config.options.txtItemsPerPage,_11f);return(n&gt;0)?n:1;};_13d.onPageChanged=function(){_146();};var _14a=function(){if(_125==null||!config.options.chkUseYourSearch){return;}
if((_125.value==_123)&amp;&amp;_123&amp;&amp;!_129()){if(_124&amp;&amp;(_124.parentNode!=document.body)){document.body.appendChild(_124);_13a();}else{abego.YourSearch.onShowResult(true);}}};var _14b=function(){_12a();_124=null;_123=null;};var _14c=function(self,e){while(e!=null){if(self==e){return true;}
e=e.parentNode;}
return false;};var _14f=function(e){if(e.target==_125){return;}
if(e.target==_126){return;}
if(_124&amp;&amp;_14c(_124,e.target)){return;}
_12a();};var _151=function(e){if(e.keyCode==27){_12a();}};addEvent(document,&quot;click&quot;,_14f);addEvent(document,&quot;keyup&quot;,_151);var _153=function(text,_155,_156){_123=text;_f4(_109(store,text,_155,_156,&quot;title&quot;,&quot;excludeSearch&quot;));abego.YourSearch.onShowResult();};var _157=function(_158,_159,_15a,_15b,_15c,_15d){_128();_123=&quot;&quot;;var _15e=null;var _15f=function(txt){if(config.options.chkUseYourSearch){_153(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);}else{story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);}
_123=txt.value;};var _161=function(e){_15f(_125);return false;};var _163=function(e){if(!e){var e=window.event;}
_125=this;switch(e.keyCode){case 13:if(e.ctrlKey&amp;&amp;_127&amp;&amp;_129()){_127.onclick.apply(_127,[e]);}else{_15f(this);}
break;case 27:if(_129()){_12a();}else{this.value=&quot;&quot;;clearMessage();}
break;}
if(String.fromCharCode(e.keyCode)==this.accessKey||e.altKey){_14a();}
if(this.value.length&lt;3&amp;&amp;_15e){clearTimeout(_15e);}
if(this.value.length&gt;2){if(this.value!=_123){if(!config.options.chkUseYourSearch||config.options.chkSearchAsYouType){if(_15e){clearTimeout(_15e);}
var txt=this;_15e=setTimeout(function(){_15f(txt);},500);}}else{if(_15e){clearTimeout(_15e);}}}
if(this.value.length==0){_12a();}};var _166=function(e){this.select();clearMessage();_14a();};var args=_15c.parseParams(&quot;list&quot;,null,true);var _169=getFlag(args,&quot;buttonAtRight&quot;);var _16a=getParam(args,&quot;sizeTextbox&quot;,this.sizeTextbox);var btn;if(!_169){btn=createTiddlyButton(_158,this.label,this.prompt,_161);}
var txt=createTiddlyElement(_158,&quot;input&quot;,null,null,null);if(_15a[0]){txt.value=_15a[0];}
txt.onkeyup=_163;txt.onfocus=_166;txt.setAttribute(&quot;size&quot;,_16a);txt.setAttribute(&quot;accessKey&quot;,this.accessKey);txt.setAttribute(&quot;autocomplete&quot;,&quot;off&quot;);if(config.browser.isSafari){txt.setAttribute(&quot;type&quot;,&quot;search&quot;);txt.setAttribute(&quot;results&quot;,&quot;5&quot;);}else{txt.setAttribute(&quot;type&quot;,&quot;text&quot;);}
if(_169){btn=createTiddlyButton(_158,this.label,this.prompt,_161);}
_125=txt;_126=btn;};var _16d=function(){_12a();var _16e=_f6();var n=_16e.length;if(n){var _170=[];for(var i=0;i&lt;n;i++){_170.push(_16e[i].title);}
story.displayTiddlers(null,_170);}};var _172=function(_173,_174,_175,_176){invokeMacro(_173,&quot;option&quot;,_174,_175,_176);var elem=_173.lastChild;var _178=elem.onclick;elem.onclick=function(e){var _17a=_178.apply(this,arguments);_146();return _17a;};return elem;};var _17b=function(s){var _17d=[&quot;''&quot;,&quot;{{{&quot;,&quot;}}}&quot;,&quot;//&quot;,&quot;&lt;&lt;&lt;&quot;,&quot;/***&quot;,&quot;***/&quot;];var _17e=&quot;&quot;;for(var i=0;i&lt;_17d.length;i++){if(i!=0){_17e+=&quot;|&quot;;}
_17e+=&quot;(&quot;+_17d[i].escapeRegExp()+&quot;)&quot;;}
return s.replace(new RegExp(_17e,&quot;mg&quot;),&quot;&quot;).trim();};var _180=function(){var i=_13b;return(i&gt;=0&amp;&amp;i&lt;=9)?(i&lt;9?(i+1):0):-1;};var _182=new abego.LimitedTextRenderer();var _183=function(_184,s,_186){_182.render(_184,s,_186,_f3.getMarkRegExp());};var _187=TiddlyWiki.prototype.saveTiddler;TiddlyWiki.prototype.saveTiddler=function(_188,_189,_18a,_18b,_18c,tags,_18e){_187.apply(this,arguments);_14b();};var _18f=TiddlyWiki.prototype.removeTiddler;TiddlyWiki.prototype.removeTiddler=function(_190){_18f.apply(this,arguments);_14b();};config.macros.yourSearch={label:&quot;yourSearch&quot;,prompt:&quot;Gives access to the current/last YourSearch result&quot;,handler:function(_191,_192,_193,_194,_195,_196){if(_193.length==0){return;}
var name=_193[0];var func=config.macros.yourSearch.funcs[name];if(func){func(_191,_192,_193,_194,_195,_196);}},tests:{&quot;true&quot;:function(){return true;},&quot;false&quot;:function(){return false;},&quot;found&quot;:function(){return _f7()&gt;0;},&quot;previewText&quot;:function(){return config.options.chkPreviewText;}},funcs:{itemRange:function(_199){if(_f7()){var _19a=_13d.getLastIndexOnPage();var s=&quot;%0 - %1&quot;.format([_13d.getFirstIndexOnPage()+1,_19a+1]);createTiddlyText(_199,s);}},count:function(_19c){createTiddlyText(_19c,_f7().toString());},query:function(_19d){if(_f3){createTiddlyText(_19d,_f3.toString());}},version:function(_19e){var t=&quot;YourSearch %0.%1.%2&quot;.format([version.extensions.YourSearchPlugin.major,version.extensions.YourSearchPlugin.minor,version.extensions.YourSearchPlugin.revision]);var e=createTiddlyElement(_19e,&quot;a&quot;);e.setAttribute(&quot;href&quot;,&quot;http://tiddlywiki.abego-software.de/#YourSearchPlugin&quot;);e.innerHTML=&quot;&lt;font color=\&quot;black\&quot; face=\&quot;Arial, Helvetica, sans-serif\&quot;&gt;&quot;+t+&quot;&lt;font&gt;&quot;;},copyright:function(_1a1){var e=createTiddlyElement(_1a1,&quot;a&quot;);e.setAttribute(&quot;href&quot;,&quot;http://www.abego-software.de&quot;);e.innerHTML=&quot;&lt;font color=\&quot;black\&quot; face=\&quot;Arial, Helvetica, sans-serif\&quot;&gt;&amp;copy; 2005-2008 &lt;b&gt;&lt;font color=\&quot;red\&quot;&gt;abego&lt;/font&gt;&lt;/b&gt; Software&lt;font&gt;&quot;;},newTiddlerButton:function(_1a3){if(_f3){var r=abego.parseNewTiddlerCommandLine(_f3.getQueryText());var btn=config.macros.newTiddler.createNewTiddlerButton(_1a3,r.title,r.params,&quot;new tiddler&quot;,&quot;Create a new tiddler based on search text. (Shortcut: Ctrl-Enter; Separators: '.', '#')&quot;,null,&quot;text&quot;);var _1a6=btn.onclick;btn.onclick=function(){_12a();_1a6.apply(this,arguments);};_127=btn;}},linkButton:function(_1a7,_1a8,_1a9,_1aa,_1ab,_1ac){if(_1a9&lt;2){return;}
var _1ad=_1a9[1];var text=_1a9&lt;3?_1ad:_1a9[2];var _1af=_1a9&lt;4?text:_1a9[3];var _1b0=_1a9&lt;5?null:_1a9[4];var btn=createTiddlyButton(_1a7,text,_1af,_12b,null,null,_1b0);btn.setAttribute(&quot;tiddlyLink&quot;,_1ad);},closeButton:function(_1b2,_1b3,_1b4,_1b5,_1b6,_1b7){var _1b8=createTiddlyButton(_1b2,&quot;close&quot;,&quot;Close the Search Results (Shortcut: ESC)&quot;,_12a);},openAllButton:function(_1b9,_1ba,_1bb,_1bc,_1bd,_1be){var n=_f7();if(n==0){return;}
var _1c0=n==1?&quot;open tiddler&quot;:&quot;open all %0 tiddlers&quot;.format([n]);var _1c1=createTiddlyButton(_1b9,_1c0,&quot;Open all found tiddlers (Shortcut: Alt-O)&quot;,_16d);_1c1.setAttribute(&quot;accessKey&quot;,&quot;O&quot;);},naviBar:function(_1c2,_1c3,_1c4,_1c5,_1c6,_1c7){_13d.addPageNavigation(_1c2);},&quot;if&quot;:function(_1c8,_1c9,_1ca,_1cb,_1cc,_1cd){if(_1ca.length&lt;2){return;}
var _1ce=_1ca[1];var _1cf=(_1ce==&quot;not&quot;);if(_1cf){if(_1ca.length&lt;3){return;}
_1ce=_1ca[2];}
var test=config.macros.yourSearch.tests[_1ce];var _1d1=false;try{if(test){_1d1=test(_1c8,_1c9,_1ca,_1cb,_1cc,_1cd)!=_1cf;}else{_1d1=(!eval(_1ce))==_1cf;}}
catch(ex){}
if(!_1d1){_1c8.style.display=&quot;none&quot;;}},chkPreviewText:function(_1d2,_1d3,_1d4,_1d5,_1d6,_1d7){var _1d8=_1d4.slice(1).join(&quot; &quot;);var elem=_172(_1d2,&quot;chkPreviewText&quot;,_1d5,_1d7);elem.setAttribute(&quot;accessKey&quot;,&quot;P&quot;);elem.title=&quot;Show text preview of found tiddlers (Shortcut: Alt-P)&quot;;return elem;}}};config.macros.foundTiddler={label:&quot;foundTiddler&quot;,prompt:&quot;Provides information on the tiddler currently processed on the YourSearch result page&quot;,handler:function(_1da,_1db,_1dc,_1dd,_1de,_1df){var name=_1dc[0];var func=config.macros.foundTiddler.funcs[name];if(func){func(_1da,_1db,_1dc,_1dd,_1de,_1df);}},funcs:{title:function(_1e2,_1e3,_1e4,_1e5,_1e6,_1e7){if(!_13c){return;}
var _1e8=_180();var _1e9=_1e8&gt;=0?&quot;Open tiddler (Shortcut: Alt-%0)&quot;.format([_1e8.toString()]):&quot;Open tiddler&quot;;var btn=createTiddlyButton(_1e2,null,_1e9,_12b,null);btn.setAttribute(&quot;tiddlyLink&quot;,_13c.title);btn.setAttribute(&quot;withHilite&quot;,&quot;true&quot;);_183(btn,_13c.title,_11b);if(_1e8&gt;=0){btn.setAttribute(&quot;accessKey&quot;,_1e8.toString());}},tags:function(_1eb,_1ec,_1ed,_1ee,_1ef,_1f0){if(!_13c){return;}
_183(_1eb,_13c.getTags(),_11c);},text:function(_1f1,_1f2,_1f3,_1f4,_1f5,_1f6){if(!_13c){return;}
_183(_1f1,_17b(_13c.text),_11d);},field:function(_1f7,_1f8,_1f9,_1fa,_1fb,_1fc){if(!_13c){return;}
var name=_1f9[1];var len=_1f9.length&gt;2?abego.toInt(_1f9[2],_11e):_11e;var v=store.getValue(_13c,name);if(v){_183(_1f7,_17b(v),len);}},number:function(_200,_201,_202,_203,_204,_205){var _206=_180();if(_206&gt;=0){var text=&quot;%0)&quot;.format([_206.toString()]);createTiddlyElement(_200,&quot;span&quot;,null,&quot;shortcutNumber&quot;,text);}}}};var opts={chkUseYourSearch:true,chkPreviewText:true,chkSearchAsYouType:true,chkSearchInTitle:true,chkSearchInText:true,chkSearchInTags:true,chkSearchExtendedFields:true,txtItemsPerPage:_11f,txtItemsPerPageWithPreview:_120};for(var n in opts){if(config.options[n]==undefined){config.options[n]=opts[n];}}
config.shadowTiddlers.AdvancedOptions+=&quot;\n&lt;&lt;option chkUseYourSearch&gt;&gt; Use 'Your Search' //([[more options|YourSearch Options]]) ([[help|YourSearch Help]])// &quot;;config.shadowTiddlers[&quot;YourSearch Help&quot;]=&quot;!Field Search\nWith the Field Search you can restrict your search to certain fields of a tiddler, e.g&quot;+&quot; only search the tags or only the titles. The general form is //fieldname//'':''//textToSearch// (e.&quot;+&quot;g. {{{title:intro}}}). In addition one-character shortcuts are also supported for the standard field&quot;+&quot;s {{{title}}}, {{{text}}} and {{{tags}}}:\n|!What you want|!What you type|!Example|\n|Search ''titles &quot;+&quot;only''|start word with ''!''|{{{!jonny}}} (shortcut for {{{title:jonny}}})|\n|Search ''contents/text &quot;+&quot;only''|start word with ''%''|{{{%football}}} (shortcut for {{{text:football}}})|\n|Search ''tags only&quot;+&quot;''|start word with ''#''|{{{#Plugin}}} (shortcut for {{{tags:Plugin}}})|\n\nUsing this feature you may&quot;+&quot; also search the extended fields (\&quot;Metadata\&quot;) introduced with TiddlyWiki 2.1, e.g. use {{{priority:1&quot;+&quot;}}} to find all tiddlers with the priority field set to \&quot;1\&quot;.\n\nYou may search a word in more than one&quot;+&quot; field. E.g. {{{!#Plugin}}} (or {{{title:tags:Plugin}}} in the \&quot;long form\&quot;) finds tiddlers containin&quot;+&quot;g \&quot;Plugin\&quot; either in the title or in the tags (but does not look for \&quot;Plugin\&quot; in the text). \n\n!Boole&quot;+&quot;an Search\nThe Boolean Search is useful when searching for multiple words.\n|!What you want|!What you &quot;+&quot;type|!Example|\n|''All words'' must exist|List of words|{{{jonny jeremy}}} (or {{{jonny and jeremy}}}&quot;+&quot;)|\n|''At least one word'' must exist|Separate words by ''or''|{{{jonny or jeremy}}}|\n|A word ''must &quot;+&quot;not exist''|Start word with ''-''|{{{-jonny}}} (or {{{not jonny}}})|\n\n''Note:'' When you specify two&quot;+&quot; words, separated with a space, YourSearch finds all tiddlers that contain both words, but not neces&quot;+&quot;sarily next to each other. If you want to find a sequence of word, e.g. '{{{John Brown}}}', you need&quot;+&quot; to put the words into quotes. I.e. you type: {{{\&quot;john brown\&quot;}}}.\n\nUsing parenthesis you may change &quot;+&quot;the default \&quot;left to right\&quot; evaluation of the boolean search. E.g. {{{not (jonny or jeremy)}}} finds&quot;+&quot; all tiddlers that contain neither \&quot;jonny\&quot; nor \&quot;jeremy. In contrast to this {{{not jonny or jeremy}}&quot;+&quot;} (i.e. without parenthesis) finds all tiddlers that either don't contain \&quot;jonny\&quot; or that contain \&quot;j&quot;+&quot;eremy\&quot;.\n\n!'Exact Word' Search\nBy default a search result all matches that 'contain' the searched tex&quot;+&quot;t. E.g. if you search for {{{Task}}} you will get all tiddlers containing 'Task', but also '~Complet&quot;+&quot;edTask', '~TaskForce' etc.\n\nIf you only want to get the tiddlers that contain 'exactly the word' you&quot;+&quot; need to prefix it with a '='. E.g. typing '=Task' will find the tiddlers that contain the word 'Tas&quot;+&quot;k', ignoring words that just contain 'Task' as a substring.\n\n!~CaseSensitiveSearch and ~RegExpSearch&quot;+&quot;\nThe standard search options ~CaseSensitiveSearch and ~RegExpSearch are fully supported by YourSearc&quot;+&quot;h. However when ''~RegExpSearch'' is on Filtered and Boolean Search are disabled.\n\nIn addition you m&quot;+&quot;ay do a \&quot;regular expression\&quot; search even with the ''~RegExpSearch'' set to false by directly enterin&quot;+&quot;g the regular expression into the search field, framed with {{{/.../}}}. \n\nExample: {{{/m[ae][iy]er/&quot;+&quot;}}} will find all tiddlers that contain either \&quot;maier\&quot;, \&quot;mayer\&quot;, \&quot;meier\&quot; or \&quot;meyer\&quot;.\n\n!~JavaScript E&quot;+&quot;xpression Filtering\nIf you are familiar with JavaScript programming and know some TiddlyWiki interna&quot;+&quot;ls you may also use JavaScript expression for the search. Just enter a JavaScript boolean expression&quot;+&quot; into the search field, framed with {{{ { ... } }}}. In the code refer to the variable tiddler and e&quot;+&quot;valuate to {{{true}}} when the given tiddler should be included in the result. \n\nExample: {{{ { tidd&quot;+&quot;ler.modified &gt; new Date(\&quot;Jul 4, 2005\&quot;)} }}} returns all tiddler modified after July 4th, 2005.\n\n!Com&quot;+&quot;bined Search\nYou are free to combine the various search options. \n\n''Examples''\n|!What you type|!Res&quot;+&quot;ult|\n|{{{!jonny !jeremy -%football}}}|all tiddlers with both {{{jonny}}} and {{{jeremy}}} in its tit&quot;+&quot;les, but no {{{football}}} in content.|\n|{{{#=Task}}}|All tiddlers tagged with 'Task' (the exact wor&quot;+&quot;d). Tags named '~CompletedTask', '~TaskForce' etc. are not considered.|\n\n!Access Keys\nYou are encour&quot;+&quot;aged to use the access keys (also called \&quot;shortcut\&quot; keys) for the most frequently used operations. F&quot;+&quot;or quick reference these shortcuts are also mentioned in the tooltip for the various buttons etc.\n\n|&quot;+&quot;!Key|!Operation|\n|{{{Alt-F}}}|''The most important keystroke'': It moves the cursor to the search in&quot;+&quot;put field so you can directly start typing your query. Pressing {{{Alt-F}}} will also display the pr&quot;+&quot;evious search result. This way you can quickly display multiple tiddlers using \&quot;Press {{{Alt-F}}}. S&quot;+&quot;elect tiddler.\&quot; sequences.|\n|{{{ESC}}}|Closes the [[YourSearch Result]]. When the [[YourSearch Resul&quot;+&quot;t]] is already closed and the cursor is in the search input field the field's content is cleared so &quot;+&quot;you start a new query.|\n|{{{Alt-1}}}, {{{Alt-2}}},... |Pressing these keys opens the first, second e&quot;+&quot;tc. tiddler from the result list.|\n|{{{Alt-O}}}|Opens all found tiddlers.|\n|{{{Alt-P}}}|Toggles the &quot;+&quot;'Preview Text' mode.|\n|{{{Alt-'&lt;'}}}, {{{Alt-'&gt;'}}}|Displays the previous or next page in the [[Your&quot;+&quot;Search Result]].|\n|{{{Return}}}|When you have turned off the 'as you type' search mode pressing the &quot;+&quot;{{{Return}}} key actually starts the search (as does pressing the 'search' button).|\n\n//If some of t&quot;+&quot;hese shortcuts don't work for you check your browser if you have other extensions installed that alr&quot;+&quot;eady \&quot;use\&quot; these shortcuts.//&quot;;config.shadowTiddlers[&quot;YourSearch Options&quot;]=&quot;|&gt;|!YourSearch Options|\n|&gt;|&lt;&lt;option chkUseYourSearch&gt;&gt; Use 'Your Search'|\n|!|&lt;&lt;option chkPreviewText&quot;+&quot;&gt;&gt; Show Text Preview|\n|!|&lt;&lt;option chkSearchAsYouType&gt;&gt; 'Search As You Type' Mode (No RETURN required&quot;+&quot; to start search)|\n|!|Default Search Filter:&lt;&lt;option chkSearchInTitle&gt;&gt;Title ('!')     &lt;&lt;option chk&quot;+&quot;SearchInText&gt;&gt;Text ('%')     &lt;&lt;option chkSearchInTags&gt;&gt;Tags ('#')    &lt;&lt;option chkSearchExtendedFiel&quot;+&quot;ds&gt;&gt;Extended Fields&lt;html&gt;&lt;br&gt;&lt;font size=\&quot;-2\&quot;&gt;The fields of a tiddlers that are searched when you don&quot;+&quot;'t explicitly specify a filter in the search text &lt;br&gt;(Explictly specify fields using one or more '!&quot;+&quot;', '%', '#' or 'fieldname:' prefix before the word/text to find).&lt;/font&gt;&lt;/html&gt;|\n|!|Number of items &quot;+&quot;on search result page: &lt;&lt;option txtItemsPerPage&gt;&gt;|\n|!|Number of items on search result page with pre&quot;+&quot;view text: &lt;&lt;option txtItemsPerPageWithPreview&gt;&gt;|\n&quot;;config.shadowTiddlers[&quot;YourSearchStyleSheet&quot;]=&quot;/***\n!~YourSearchResult Stylesheet\n***/\n/*{{{*/\n.yourSearchResult {\n\tposition: absolute;\n\twidth: 800&quot;+&quot;px;\n\n\tpadding: 0.2em;\n\tlist-style: none;\n\tmargin: 0;\n\n\tbackground: #ffd;\n\tborder: 1px solid DarkGra&quot;+&quot;y;\n}\n\n/*}}}*/\n/***\n!!Summary Section\n***/\n/*{{{*/\n.yourSearchResult .summary {\n\tborder-bottom-width:&quot;+&quot; thin;\n\tborder-bottom-style: solid;\n\tborder-bottom-color: #999999;\n\tpadding-bottom: 4px;\n}\n\n.yourSea&quot;+&quot;rchRange, .yourSearchCount, .yourSearchQuery   {\n\tfont-weight: bold;\n}\n\n.yourSearchResult .summary .&quot;+&quot;button {\n\tfont-size: 10px;\n\n\tpadding-left: 0.3em;\n\tpadding-right: 0.3em;\n}\n\n.yourSearchResult .summa&quot;+&quot;ry .chkBoxLabel {\n\tfont-size: 10px;\n\n\tpadding-right: 0.3em;\n}\n\n/*}}}*/\n/***\n!!Items Area\n***/\n/*{{{*&quot;+&quot;/\n.yourSearchResult .marked {\n\tbackground: none;\n\tfont-weight: bold;\n}\n\n.yourSearchItem {\n\tmargin-to&quot;+&quot;p: 2px;\n}\n\n.yourSearchNumber {\n\tcolor: #808080;\n}\n\n\n.yourSearchTags {\n\tcolor: #008000;\n}\n\n.yourSearc&quot;+&quot;hText {\n\tcolor: #808080;\n\tmargin-bottom: 6px;\n}\n\n/*}}}*/\n/***\n!!Footer\n***/\n/*{{{*/\n.yourSearchFoote&quot;+&quot;r {\n\tmargin-top: 8px;\n\tborder-top-width: thin;\n\tborder-top-style: solid;\n\tborder-top-color: #999999;&quot;+&quot;\n}\n\n.yourSearchFooter a:hover{\n\tbackground: none;\n\tcolor: none;\n}\n/*}}}*/\n/***\n!!Navigation Bar\n***/&quot;+&quot;\n/*{{{*/\n.yourSearchNaviBar a {\n\tfont-size: 16px;\n\tmargin-left: 4px;\n\tmargin-right: 4px;\n\tcolor: bla&quot;+&quot;ck;\n\ttext-decoration: underline;\n}\n\n.yourSearchNaviBar a:hover {\n\tbackground-color: none;\n}\n\n.yourSe&quot;+&quot;archNaviBar .prev {\n\tfont-weight: bold;\n\tcolor: blue;\n}\n\n.yourSearchNaviBar .currentPage {\n\tcolor: #&quot;+&quot;FF0000;\n\tfont-weight: bold;\n\ttext-decoration: none;\n}\n\n.yourSearchNaviBar .next {\n\tfont-weight: bold&quot;+&quot;;\n\tcolor: blue;\n}\n/*}}}*/\n&quot;;config.shadowTiddlers[&quot;YourSearchResultTemplate&quot;]=&quot;&lt;!--\n{{{\n--&gt;\n&lt;span macro=\&quot;yourSearch if found\&quot;&gt;\n&lt;!-- The Summary Header ============================&quot;+&quot;================ --&gt;\n&lt;table class=\&quot;summary\&quot; border=\&quot;0\&quot; width=\&quot;100%\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&quot;+&quot;&lt;tbody&gt;\n  &lt;tr&gt;\n\t&lt;td align=\&quot;left\&quot;&gt;\n\t\tYourSearch Result &lt;span class=\&quot;yourSearchRange\&quot; macro=\&quot;yourSearc&quot;+&quot;h itemRange\&quot;&gt;&lt;/span&gt;\n\t\t&amp;nbsp;of&amp;nbsp;&lt;span class=\&quot;yourSearchCount\&quot; macro=\&quot;yourSearch count\&quot;&gt;&lt;/span&gt;\n&quot;+&quot;\t\tfor&amp;nbsp;&lt;span class=\&quot;yourSearchQuery\&quot; macro=\&quot;yourSearch query\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n\t&lt;td class=\&quot;yourSea&quot;+&quot;rchButtons\&quot; align=\&quot;right\&quot;&gt;\n\t\t&lt;span macro=\&quot;yourSearch chkPreviewText\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;chkBoxLabel&quot;+&quot;\&quot;&gt;preview text&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch newTiddlerButton\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch openAllButton\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch lin&quot;+&quot;kButton 'YourSearch Options' options 'Configure YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch linkB&quot;+&quot;utton 'YourSearch Help' help 'Get help how to use YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch clo&quot;+&quot;seButton\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n  &lt;/tr&gt;\n&lt;/tbody&gt;&lt;/table&gt;\n\n&lt;!-- The List of Found Tiddlers =================&quot;+&quot;=========================== --&gt;\n&lt;div id=\&quot;yourSearchResultItems\&quot; itemsPerPage=\&quot;25\&quot; itemsPerPageWithPr&quot;+&quot;eview=\&quot;10\&quot;&gt;&lt;/div&gt;\n\n&lt;!-- The Footer (with the Navigation) ===========================================&quot;+&quot;= --&gt;\n&lt;table class=\&quot;yourSearchFooter\&quot; border=\&quot;0\&quot; width=\&quot;100%\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&lt;tbody&quot;+&quot;&gt;\n  &lt;tr&gt;\n\t&lt;td align=\&quot;left\&quot;&gt;\n\t\tResult page: &lt;span class=\&quot;yourSearchNaviBar\&quot; macro=\&quot;yourSearch naviBar&quot;+&quot;\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n\t&lt;td align=\&quot;right\&quot;&gt;&lt;span macro=\&quot;yourSearch version\&quot;&gt;&lt;/span&gt;, &lt;span macro=\&quot;yourSearc&quot;+&quot;h copyright\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n  &lt;/tr&gt;\n&lt;/tbody&gt;&lt;/table&gt;\n&lt;!-- end of the 'tiddlers found' case =========&quot;+&quot;================================== --&gt;\n&lt;/span&gt;\n\n\n&lt;!-- The \&quot;No tiddlers found\&quot; case =================&quot;+&quot;========================== --&gt;\n&lt;span macro=\&quot;yourSearch if not found\&quot;&gt;\n&lt;table class=\&quot;summary\&quot; border=&quot;+&quot;\&quot;0\&quot; width=\&quot;100%\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&lt;tbody&gt;\n  &lt;tr&gt;\n\t&lt;td align=\&quot;left\&quot;&gt;\n\t\tYourSearch Resu&quot;+&quot;lt: No tiddlers found for &lt;span class=\&quot;yourSearchQuery\&quot; macro=\&quot;yourSearch query\&quot;&gt;&lt;/span&gt;.\n\t&lt;/td&gt;\n\t&lt;t&quot;+&quot;d class=\&quot;yourSearchButtons\&quot; align=\&quot;right\&quot;&gt;\n\t\t&lt;span macro=\&quot;yourSearch newTiddlerButton\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch linkButton 'YourSearch Options'&quot;+&quot; options 'Configure YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch linkButton 'YourSearch Help' help&quot;+&quot; 'Get help how to use YourSearch'\&quot;&gt;&lt;/span&gt;\n\t\t&lt;span macro=\&quot;yourSearch closeButton\&quot;&gt;&lt;/span&gt;\n\t&lt;/td&gt;\n  &lt;&quot;+&quot;/tr&gt;\n&lt;/tbody&gt;&lt;/table&gt;\n&lt;/span&gt;\n\n\n&lt;!--\n}}}\n--&gt;\n&quot;;config.shadowTiddlers[&quot;YourSearchItemTemplate&quot;]=&quot;&lt;!--\n{{{\n--&gt;\n&lt;span class='yourSearchNumber' macro='foundTiddler number'&gt;&lt;/span&gt;\n&lt;span class='yourSea&quot;+&quot;rchTitle' macro='foundTiddler title'/&gt;&lt;/span&gt;&amp;nbsp;-&amp;nbsp;\n&lt;span class='yourSearchTags' macro='found&quot;+&quot;Tiddler field tags 50'/&gt;&lt;/span&gt;\n&lt;span macro=\&quot;yourSearch if previewText\&quot;&gt;&lt;div class='yourSearchText' macro='fo&quot;+&quot;undTiddler field text 250'/&gt;&lt;/div&gt;&lt;/span&gt;\n&lt;!--\n}}}\n--&gt;&quot;;config.shadowTiddlers[&quot;YourSearch&quot;]=&quot;&lt;&lt;tiddler [[YourSearch Help]]&gt;&gt;&quot;;config.shadowTiddlers[&quot;YourSearch Result&quot;]=&quot;The popup-like window displaying the result of a YourSearch query.&quot;;config.macros.search.handler=_157;var _20a=function(){if(config.macros.search.handler!=_157){alert(&quot;Message from YourSearchPlugin:\n\n\nAnother plugin has disabled the 'Your Search' features.\n\n\nYou may &quot;+&quot;disable the other plugin or change the load order of \nthe plugins (by changing the names of the tidd&quot;+&quot;lers)\nto enable the 'Your Search' features.&quot;);}};setTimeout(_20a,5000);abego.YourSearch.getStandardRankFunction=function(){return _ff;};abego.YourSearch.getRankFunction=function(){return abego.YourSearch.getStandardRankFunction();};abego.YourSearch.getCurrentTiddler=function(){return _13c;};abego.YourSearch.closeResult=function(){_12a();};abego.YourSearch.getFoundTiddlers=function(){return _f2;};abego.YourSearch.getQuery=function(){return _f3;};abego.YourSearch.onShowResult=function(_20b){highlightHack=_f3?_f3.getMarkRegExp():null;if(!_20b){_13d.setItems(_f6());}
if(!_124){_124=createTiddlyElement(document.body,&quot;div&quot;,_121,&quot;yourSearchResult&quot;);}else{if(_124.parentNode!=document.body){document.body.appendChild(_124);}}
_146();highlightHack=null;};})();}
//%/
</pre>
</div>
<div title="dateChooserPlugin" modifier="YourName" created="200805221355" modified="200805221358" tags="systemConfig excludeSearch excludeLists">
<pre>//{{{
//For demonstration purposes only
// A port of a plugin by Simon Baird to use DatePicker library
//requires DatePicker: http://svn.tiddlywiki.org/Trunk/contributors/SaqImtiaz/libraries/DatePicker.js

// some additions by Simon Baird

if (DatePicker){
    merge(config.macros, {
        dateChooser: {
            handler: function(place,macroName,params,wikifier,paramString,tiddler) {
    
                var useTiddler = tiddler;
                if (params[0])
                    useTiddler = store.fetchTiddler(params[0]);
    
                var curVal = useTiddler.fields['mgtd_date'] || undefined;
                var startDate = curVal ? Date.convertFromYYYYMMDDHHMM(curVal) : null;

                var dateBox = createTiddlyElement(place,'input',null,'dateBox');            

                var dateFormat = config.mGTD.getOptTxt('ticklerdateformat');
				var defaultDateFormat = 'ddd, DD-mmm-YY';
				if (!dateFormat) {
					// makes it nicer for upgraders who don't have a format set
					dateFormat = defaultDateFormat;
					config.mGTD.setOptTxt('ticklerdateformat', defaultDateFormat);
				}
                dateBox.value = startDate ? startDate.formatString(dateFormat) : '(set date)';
    
                var callback = function(el,objDate){
                    el.value = objDate.formatString(dateFormat);
                    useTiddler.fields['mgtd_date'] = objDate.convertToYYYYMMDDHHMM();
					useTiddler.touch();	// see MgtdDateUtils
                }
                DatePicker.create(dateBox,startDate,callback);
            }
        },

		addDay: {
			label:   {addDay:&quot;+d&quot;, addWeek:&quot;+w&quot;,  addMonth:&quot;+m&quot;,   addYear:&quot;+y&quot;},
			tooltip: {addDay:&quot;day&quot;,addWeek:&quot;week&quot;,addMonth:&quot;month&quot;,addYear:&quot;year&quot;},
            handler: function(place,macroName,params,wikifier,paramString,tiddler) {
                var useTiddler = tiddler;
                if (params[0]) useTiddler = store.fetchTiddler(params[0]);
                var curVal = useTiddler.fields['mgtd_date'] || undefined;
                var curDate = curVal ? Date.convertFromYYYYMMDDHHMM(curVal) : new Date();    
				// ensure ticklers activate at midnight on their day since new Date() has minutes
				curDate.setHours(0);
				curDate.setMinutes(0);
				curDate.setSeconds(0); 
				// call the suitable date method. happens to match the macroname. see MgtdDateUtils. sorry for confusing code.
				curDate[macroName](1);
				createTiddlyButton(place,config.macros.addDay.label[macroName],&quot;add a &quot;+config.macros.addDay.tooltip[macroName],function() {
                    useTiddler.fields['mgtd_date'] = curDate.convertToYYYYMMDDHHMM();
					useTiddler.touch();	// see MgtdDateUtils
					return false;
				});

			}
		}
    });
}

config.macros.addWeek  = config.macros.addDay;
config.macros.addMonth = config.macros.addDay;
config.macros.addYear  = config.macros.addDay;
//}}}
</pre>
</div>
<div title="systemConfig" modifier="MPTW" created="200805101525" modified="200805101525" tags="excludeSearch" taggly.excerpts="descr" taggly.sortby="created" taggly.sortorder="desc">
<pre></pre>
</div>
<div title="Важно" modifier="YourName" created="200805221358" modified="200805251113" tags="Context" changecount="1">
<pre></pre>
</div>
<div title="Доработать" modifier="YourName" created="200805252134" tags="Context Personal" changecount="1">
<pre></pre>
</div>
<div title="Копилка" modifier="YourName" created="200807030101" modified="200809090144" changecount="2">
<pre>- Управление лазерной указкой. Фишка: указка &quot;светит&quot; сквозь экран, если смотреть угол падения и продолжать рисование уже в кадре
- CMC-based приложение для Faceboook/vkontakte
- http://www.catonmat.net/blog/code-reuse-in-google-chrome-browser/
- http://www.mozilla.org/projects/nspr/

!Идеи для флешки:
- зонтик и защита от дождя
- ездящие ящики и аппарат обменник
- m3  домашний доктор
- m3 идельаная пара
- match pair?</pre>
</div>
<div title="На_будущее" modifier="YourName" created="200805252134" modified="200805252137" tags="Context Personal" changecount="2">
<pre></pre>
</div>
<div title="Никто" modifier="YourName" created="200805251110" modified="200805251110" tags="Contact Personal" changecount="2">
<pre></pre>
</div>
<div title="Основное" modifier="YourName" created="200805252153" tags="Area Personal" changecount="1">
<pre></pre>
</div>
<div title="Поправить" modifier="YourName" created="200805221358" modified="200805252134" tags="Context" changecount="2">
<pre></pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->
<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[
//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

// Adaptors
config.adaptors = {};
config.defaultAdaptor = null;

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkIncrementalSearch: true,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	chkDisplayInstrumentation: false,
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8",
	txtTheme: ""
	};
config.optionsDesc = {};

// List of notification functions to be called when certain tiddlers are changed or deleted
config.notifyTiddlers = [
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that shouldn't really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["save","sync","importTask","tweak","upgrade","plugins"];

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {defaultView: "text"},
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "http://www.tiddlywiki.com/upgrade/",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {type: "popup"},
	jump: {type: "popup"},
	syncing: {type: "popup"},
	fields: {type: "popup"}
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: config.userAgent.indexOf("gecko") != -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(config.browser.isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
	browsers: [
		function() {return config.browser.isIE;},
		function() {return true;}
	],
	currBrowser: null,
	codes: {
		downTriangle: ["\u25BC","\u25BE"],
		downArrow: ["\u2193","\u2193"],
		bentArrowLeft: ["\u2190","\u21A9"],
		bentArrowRight: ["\u2192","\u21AA"]
	}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>'
};

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.tasks,{
	save: {text: "save", tooltip: "Save your changes to this TiddlyWiki", action: saveChanges},
	sync: {text: "sync", tooltip: "Synchronise changes with other TiddlyWiki files and servers", content: '<<sync>>'},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
	upgrade: {text: "upgrade", tooltip: "Upgrade TiddlyWiki core code", content: '<<upgrade>>'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
	txtUserName: "Username for signing your edits",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkAnimate: "Enable animations",
	chkSaveBackups: "Keep backup file when saving changes",
	chkAutoSave: "Automatically save changes",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	txtBackupFolder: "Name of folder to use for backups",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<\%0>>",
	macroErrorDetails: "Error while executing macro <<\%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.backstage = {
	open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
	close: {text: "close", tooltip: "Close the backstage area"},
	prompt: "backstage: ",
	decal: {
		edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
	});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
	sizeTemplates:
		[
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
		]});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.options,{
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
			{name: 'Name', field: 'name', title: "Name", type: 'String'}
			],
		rowClasses: [
			{className: 'lowlight', field: 'lowlight'}
			]}
	});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.toolbar,{
	moreLabel: "more",
	morePrompt: "Reveal further commands"
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	openError: "There were problems fetching the tiddlywiki file",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.upgrade,{
	wizardTitle: "Upgrade TiddlyWiki core code",
	step1Title: "Update or repair this TiddlyWiki to the latest release",
	step1Html: "You are about to upgrade to the latest release of the TiddlyWiki core code (from <a href='%0' class='externalLink' target='_blank'>%1</a>). Your content will be preserved across the upgrade.<br><br>Note that core upgrades have been known to interfere with older plugins. If you run into problems with the upgraded file, see <a href='http://www.tiddlywiki.org/wiki/CoreUpgrades' class='externalLink' target='_blank'>http://www.tiddlywiki.org/wiki/CoreUpgrades</a>",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
	});

merge(config.macros.sync,{
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Server Type', field: 'serverType', title: "Server type", type: 'String'},
			{name: 'Server Host', field: 'serverHost', title: "Server host", type: 'String'},
			{name: 'Server Workspace', field: 'serverWorkspace', title: "Server workspace", type: 'String'},
			{name: 'Status', field: 'status', title: "Synchronisation status", type: 'String'},
			{name: 'Server URL', field: 'serverUrl', title: "Server URL", text: "View", type: 'Link'}
			],
		rowClasses: [
			],
		buttons: [
			{caption: "Sync these tiddlers", name: 'sync'}
			]},
	wizardTitle: "Synchronize with external servers and files",
	step1Title: "Choose the tiddlers you want to synchronize",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	syncLabel: "sync",
	syncPrompt: "Sync these tiddlers",
	hasChanged: "Changed while unplugged",
	hasNotChanged: "Unchanged while unplugged",
	syncStatusList: {
		none: {text: "...", color: "transparent"},
		changedServer: {text: "Changed on server", color: '#80ff80'},
		changedLocally: {text: "Changed while unplugged", color: '#80ff80'},
		changedBoth: {text: "Changed while unplugged and on server", color: '#ff8080'},
		notFound: {text: "Not found on server", color: '#ffff80'},
		putToServer: {text: "Saved update on server", color: '#ff80ff'},
		gotFromServer: {text: "Retrieved update from server", color: '#80ffff'}
		}
	});

merge(config.macros.annotations,{
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.commands.syncing,{
	text: "syncing",
	tooltip: "Control synchronisation of this tiddler with a server or external file",
	currentlySyncing: "<div>Currently syncing via <span class='popupHighlight'>'%0'</span> to:</"+"div><div>host: <span class='popupHighlight'>%1</span></"+"div><div>workspace: <span class='popupHighlight'>%2</span></"+"div>", // Note escaping of closing <div> tag
	notCurrentlySyncing: "Not currently syncing",
	captionUnSync: "Stop synchronising this tiddler",
	chooseServer: "Synchronise this tiddler with another server:",
	currServerMarker: "\u25cf ",
	notCurrServerMarker: "  "});

merge(config.commands.fields,{
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
			],
		rowClasses: [
			],
		buttons: [
			]}});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "GettingStarted",
	MainMenu: "GettingStarted",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "http://www.tiddlywiki.com/",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>',
	ToolbarCommands: "|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields syncing permalink references jump|\n|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|"});

merge(config.annotations,{
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
	});

//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = (config.browser.isSafari || config.browser.isOpera) && (document.location.toString().substr(0,4) != "http");

// Starting up
function main()
{
	var t10,t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	loadShadowTiddlers();
	t2 = new Date();
	store.loadFromDiv("storeArea","store",true);
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	showBackstage = !readOnly;
	var pluginProblem = loadPlugins();
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	story.switchTheme(config.options.txtTheme);
	invokeParamifier(params,"onconfig");
	t6 = new Date();
	store.notifyAll();
	t7 = new Date();
	restart();
	refreshDisplay();
	t8 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	for(var m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	t9 = new Date();
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2-t1) + " ms");
		displayMessage("LoadFromDiv " + (t3-t2) + " ms");
		displayMessage("LoadPlugins " + (t5-t4) + " ms");
		displayMessage("Notify " + (t7-t6) + " ms");
		displayMessage("Restart " + (t8-t7) + " ms");
		displayMessage("Macro init " + (t9-t8) + " ms");
		displayMessage("Total: " + (t10-t0) + " ms");
	}
	startingUp = false;
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		var tiddlers = store.filterTiddlers(store.getTiddlerText("DefaultTiddlers"));
		story.displayTiddlers(null,tiddlers);
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
	delete shadows;
}

function loadPlugins()
{
	if(safeMode)
		return false;
	var tiddlers = store.getTaggedTiddlers("systemConfig");
	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i=0; i<nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name;
		if(n)
			map[n] = p;
		n = p.Source;
		if(n)
			map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done)
			return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i=0; i<reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i=0; i<nPlugins; i++)
		visit(installedPlugins[i]);
	for(i=0; i<toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text)
						window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigForce"))
		return verifyTail(plugin,true,config.messages.pluginForced);
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0]) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1]) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2]) - version.revision;
		if(w > 0)
			return verifyTail(plugin,false,config.messages.pluginVersionError);
		}
	return true;
}

function isPluginEnabled(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable"))
		return verifyTail(plugin,false,config.messages.pluginDisabled);
	return true;
}

function verifyTail(plugin,result,message)
{
	plugin.log.push(message);
	return result;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler)
			m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
		else
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURIComponent(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var t=1; t<params.length; t++) {
		var p = config.paramifiers[params[t].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[t].value);
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v) {
		if(!readOnly || store.tiddlerExists(v) || store.isShadowTiddler(v))
			story.displayTiddler("bottom",v,null,false,null);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		var tagged = store.getTaggedTiddlers(v,"title");
		story.displayTiddlers(null,tagged,null,false,null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly) {
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(v) {
		story.switchTheme(v);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},

	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if(s=="bgcolor")
				s = "backgroundColor";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1 || link.indexOf("#")!=-1) {
			return true;
		}
		return false;
	}

};

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					var theRow = createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow");
					theRow.onmouseover = function() {addClass(this,"hoverRow");};
					theRow.onmouseout = function() {removeClass(this,"hoverRow");};
					this.rowHandler(w,theRow,prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType, baseType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			if(!baseType)
				baseType = listType;
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target,listType));
				}
			} else if(listType!=baseType && listLevel==1) {
				w.nextMatch -= lookaheadMatch[0].length;
				return;
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
	element: "pre",
	handler: function(w)
	{
		switch(w.matchText) {
		case "/*{{{*/\n": // CSS
			this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\/\*\}\}\}\*\/$\n?)/mg;
			break;
		case "{{{\n": // monospaced block
			this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/mg;
			break;
		case "//{{{\n": // plugin
			this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\/\/\}\}\}$\n?)/mg;
			break;
		case "<!--{{{-->\n": //template
			this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^<!--\}\}\}-->$\n?)/mg;
			break;
		default:
			break;
		}
		config.formatterHelpers.enclosedTextHelper.call(this,w);
	}
},

{
	name: "wikifyComment",
	match: "^(?:/\\*\\*\\*|<!---)\\n",
	handler: function(w)
	{
		var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
		w.subWikifyTerm(w.output,termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.unWikiLink+"?"+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchText.substr(0,1) == config.textPrimitives.unWikiLink) {
			w.outputText(w.output,w.matchStart+1,w.nextMatch);
			return;
		}
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				addClass(e,"imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3]) {
				img.title = lookaheadMatch[3];
				img.setAttribute("alt",lookaheadMatch[3]);
			}
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "characterFormat",
	match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "''":
			w.subWikifyTerm(w.output.appendChild(document.createElement("strong")),/('')/mg);
			break;
		case "//":
			w.subWikifyTerm(createTiddlyElement(w.output,"em"),/(\/\/)/mg);
			break;
		case "__":
			w.subWikifyTerm(createTiddlyElement(w.output,"u"),/(__)/mg);
			break;
		case "^^":
			w.subWikifyTerm(createTiddlyElement(w.output,"sup"),/(\^\^)/mg);
			break;
		case "~~":
			w.subWikifyTerm(createTiddlyElement(w.output,"sub"),/(~~)/mg);
			break;
		case "--":
			w.subWikifyTerm(createTiddlyElement(w.output,"strike"),/(--)/mg);
			break;
		case "{{{":
			var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
				w.nextMatch = lookaheadRegExp.lastIndex;
			}
			break;
		}
	}
},

{
	name: "customFormat",
	match: "@@|\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "@@":
			var e = createTiddlyElement(w.output,"span");
			var styles = config.formatterHelpers.inlineCssHelper(w);
			if(styles.length == 0)
				e.className = "marked";
			else
				config.formatterHelpers.applyCssHelper(e,styles);
			w.subWikifyTerm(e,/(@@)/mg);
			break;
		case "{{":
			lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch) {
				w.nextMatch = lookaheadRegExp.lastIndex;
				e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
				w.subWikifyTerm(e,/(\}\}\})/mg);
			}
			break;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\\\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
	if(tiddler) {
		if(!format)
			format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers) {
				if(format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for(i in config.parsers) {
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
			}
		}
	}
	return formatter;
}

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "") {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		wikifier.subWikify(output);
	}
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
	var e = createTiddlyElement(document.body,"pre");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		if(!tiddler)
			tiddler = new Tiddler("temp");
		var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikify(e);
		html = e.innerHTML;
		removeNode(e);
	}
	return html;
}

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}

function wikifyPlainText(text,limit,tiddler)
{
	if(limit > 0)
		text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "") {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = getPlainText(e);
	removeNode(e);
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	try {
		if(terminator)
			this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

//--
//-- Macro definitions
//--

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	createTiddlyElement(place,"span",null,null,text);
};

config.macros.version.handler = function(place)
{
	createTiddlyElement(place,"span",null,null,formatVersion());
};

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] ? params[0] : "all";
	var list = document.createElement("ul");
	place.appendChild(list);
	if(this[type].prompt)
		createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for(var t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		createTiddlyLink(li,typeof results[t] == "string" ? results[t] : results[t].title,true);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
};

config.macros.list.filter.handler = function(params)
{
	var filter = params[1];
	var results = [];
	if(filter) {
		var tiddlers = store.filterTiddlers(filter);
		for(var t=0; t<tiddlers.length; t++)
			results.push(tiddlers[t].title);
	}
	return results;
};

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
	}
};

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] ? params[0] : "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	var dateFormat = params[2] ? params[2] : this.dateFormat;
	for(var t=tiddlers.length-1; t>=last; t--) {
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay) {
			var ul = document.createElement("ul");
			place.appendChild(ul);
			createTiddlyElement(ul,"li",null,"listTitle",tiddler[field].formatString(dateFormat));
			lastDay = theDay;
		}
		createTiddlyElement(ul,"li",null,"listLink").appendChild(createTiddlyLink(place,tiddler.title,true));
	}
};

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("name",null,true,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] ? names[1] : null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className);
	if(!args) {
		wrapper.setAttribute("refresh","content");
		wrapper.setAttribute("tiddler",tiddlerName);
	}
	var text = store.getTiddlerText(tiddlerName);
	if(text) {
		var stack = config.macros.tiddler.tiddlerStack;
		if(stack.indexOf(tiddlerName) !== -1)
			return;
		stack.push(tiddlerName);
		try {
			var n = args ? Math.min(args.length,9) : 0;
			for(var i=0; i<n; i++) {
				var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
				text = text.replace(placeholderRE,args[i]);
			}
			config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
		} finally {
			stack.pop();
		}
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName,params)
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0],null,params[1],params[2]);
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([tiddler.title]));
	for(var t=0; t<tiddler.tags.length; t++) {
		createTagButton(createTiddlyElement(ul,"li"),tiddler.tags[t],tiddler.title);
		if(t<tiddler.tags.length-1)
			createTiddlyText(ul,sep);
	}
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	ul.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([title,tagged.length]));
	for(var t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(ul,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(ul,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place,macroName,params)
{
	if(!readOnly)
		createTiddlyButton(place,params[0] || this.label,params[1] || this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev)
{
	var e = ev ? ev : window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,null,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var c = cookie ? cookie : "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var panel = wikifier ? createTiddlyElement(place,"div",null,"gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	params = paramString.parseParams("color");
	var locolors = [], hicolors = [];
	for(var t=2; t<params.length; t++) {
		var c = new RGB(params[t].value);
		if(params[t].name == "snap") {
			hicolors[hicolors.length-1] = c;
		} else {
			locolors.push(c);
			hicolors.push(c);
		}
	}
	drawGradient(panel,params[1].value != "vert",locolors,hicolors);
	if(wikifier)
		wikifier.subWikify(panel,">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var names = params[0].split(".");
		var lookupMessage = function(root,nameIndex) {
				if(names[nameIndex] in root) {
					if(nameIndex < names.length-1)
						return (lookupMessage(root[names[nameIndex]],nameIndex+1));
					else
						return root[names[nameIndex]];
				} else
					return null;
			};
		var m = lookupMessage(config,0);
		if(m == null)
			m = lookupMessage(window,0);
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};


config.macros.view.views = {
	text: function(value,place,params,wikifier,paramString,tiddler) {
		highlightify(value,place,highlightHack,tiddler);
	},
	link: function(value,place,params,wikifier,paramString,tiddler) {
		createTiddlyLink(place,value,true);
	},
	wikified: function(value,place,params,wikifier,paramString,tiddler) {
		if(params[2])
			value=params[2].unescapeLineBreaks().format([value]);
		wikify(value,place,highlightHack,tiddler);
	},
	date: function(value,place,params,wikifier,paramString,tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value) {
			var type = params[1] ? params[1] : config.macros.view.defaultView;
			var handler = config.macros.view.views[type];
			if(handler)
				handler(value,place,params,wikifier,paramString,tiddler);
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	var rows = params[1] || 0;
	var defVal = params[2] || '';
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		var e,v;
		if(field != "text" && !rows) {
			e = createTiddlyElement(null,"input");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			e.setAttribute("edit",field);
			e.setAttribute("type","text");
			e.value = store.getValue(tiddler,field) || defVal;
			e.setAttribute("size","40");
			e.setAttribute("autocomplete","off");
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			e = createTiddlyElement(wrapper2,"textarea");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			e.value = v = store.getValue(tiddler,field) || defVal;
			rows = rows ? rows : 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
		return e;
	}
};

config.macros.tagChooser.onClick = function(ev)
{
	var e = ev ? ev : window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags();
	if(tags.length == 0)
		createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
	for(var t=0; t<tags.length; t++) {
		var tag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag",tags[t][0]);
		tag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev)
{
	var e = ev ? ev : window.event;
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",tiddler.title);
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var title = tiddler ? tiddler.title : null;
	var a = title ? config.annotations[title] : null;
	if(!tiddler || !title || !a)
		return;
	var text = a.format([title]);
	wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	for(var t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields","");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal ? "true" : "false");
	if(tags.length > 0)
		btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	if(customFields !== "")
		btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined)
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		var now = new Date();
		title = now.formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string")
		story.getTiddlerField(title,"text").value = text.format([title]);
	for(var t=0;t<tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick,"searchButton");
	var txt = createTiddlyElement(place,"input",null,"txtOptionInput searchField");
	if(params[0])
		txt.value = params[0];
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev)
{
	var e = ev ? ev : window.event;
	switch(e.keyCode) {
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			config.macros.search.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(config.macros.search.timeout)
					clearTimeout(config.macros.search.timeout);
				var txt = this;
				config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
			}
		} else {
			if(config.macros.search.timeout)
				clearTimeout(config.macros.search.timeout);
		}
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,"tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			removeNode(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
		}
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,className)
{
	if(typeof commandName != "string") {
		var c = null;
		for(var t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var cmd;
			switch(command.type) {
				case "popup":
					cmd = this.onClickPopup;
					break;
				case "command":
				default:
					cmd = this.onClickCommand;
					break;
			}
			var btn = createTiddlyButton(null,text,tooltip,cmd);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			if(className)
				addClass(btn,className);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyText ? command.readOnlyText : command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev)
{
	var e = ev ? ev : window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev)
{
	var e = ev ? ev : window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getAttribute("tiddler");
	var tiddler = store.fetchTiddler(title);
	popup.setAttribute("tiddler",title);
	command.handlePopup(popup,title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,className,event)
{
	var children = place.getElementsByTagName("a");
	for(var t=0; t<children.length; t++) {
		var c = children[t];
		if(hasClass(c,className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev)
{
	var e = this.nextSibling;
	e.style.display = "inline";
	removeNode(this);
	return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++) {
		var c = params[t];
		switch(c) {
			case '>':
				var btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
				addClass(btn,"moreCommand");
				var e = createTiddlyElement(place,"span",null,"moreCommand");
				e.style.display = "none";
				place = e;
				break;
			default:
				var className = "";
				switch(c.substr(0,1)) {
					case "+":
						className = "defaultCommand";
						c = c.substr(1);
						break;
					case "-":
						className = "cancelCommand";
						c = c.substr(1);
						break;
				}
				if(c in config.commands)
					this.createCommand(place,c,tiddler,className);
				break;
		}
	}
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.closeTiddler(title,true);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
	story.focusTiddler(title,config.options.txtEditorFocus||"text");
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if(config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if(deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup,title)
{
	var references = store.getReferringTiddlers(title);
	var c = false;
	for(var r=0; r<references.length; r++) {
		if(references[r].title != title && !references[r].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
			c = true;
		}
	}
	if(!c)
		createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
	story.forEachTiddler(function(title,element) {
		createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
		});
};

config.commands.syncing.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var serverType = tiddler.getServerType();
	var serverHost = tiddler.fields['server.host'];
	var serverWorkspace = tiddler.fields['server.workspace'];
	if(!serverWorkspace)
		serverWorkspace = "";
	if(serverType) {
		var e = createTiddlyElement(popup,"li",null,"popupMessage");
		e.innerHTML = config.commands.syncing.currentlySyncing.format([serverType,serverHost,serverWorkspace]);
	} else {
		createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.notCurrentlySyncing);
	}
	if(serverType) {
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var btn = createTiddlyButton(createTiddlyElement(popup,"li"),this.captionUnSync,null,config.commands.syncing.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type","");
	}
	createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
	createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.chooseServer);
	var feeds = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<feeds.length; t++) {
		var f = feeds[t];
		var feedServerType = store.getTiddlerSlice(f.title,"Type");
		if(!feedServerType)
			feedServerType = "file";
		var feedServerHost = store.getTiddlerSlice(f.title,"URL");
		if(!feedServerHost)
			feedServerHost = "";
		var feedServerWorkspace = store.getTiddlerSlice(f.title,"Workspace");
		if(!feedServerWorkspace)
			feedServerWorkspace = "";
		var caption = f.title;
		if(serverType == feedServerType && serverHost == feedServerHost && serverWorkspace == feedServerWorkspace) {
			caption = config.commands.syncing.currServerMarker + caption;
		} else {
			caption = config.commands.syncing.notCurrServerMarker + caption;
		}
		btn = createTiddlyButton(createTiddlyElement(popup,"li"),caption,null,config.commands.syncing.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type",feedServerType);
		btn.setAttribute("server.host",feedServerHost);
		btn.setAttribute("server.workspace",feedServerWorkspace);
	}
};

config.commands.syncing.onChooseServer = function(e)
{
	var tiddler = this.getAttribute("tiddler");
	var serverType = this.getAttribute("server.type");
	if(serverType) {
		store.addTiddlerFields(tiddler,{
			'server.type': serverType,
			'server.host': this.getAttribute("server.host"),
			'server.workspace': this.getAttribute("server.workspace")
			});
	} else {
		store.setValue(tiddler,'server',null);
	}
	return false;
};

config.commands.fields.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var fields = {};
	store.forEachField(tiddler,function(tiddler,fieldName,value) {fields[fieldName] = value;},true);
	var items = [];
	for(var t in fields) {
		items.push({field: t,value: fields[t]});
	}
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if(items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup,"div",null,null,this.emptyText);
};

//--
//-- Tiddler() object
//--

function Tiddler(title)
{
	this.title = title;
	this.text = "";
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
	var f = {};
	for(i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	c = c ? parseInt(c) : 0;
	this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function()
{
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changeCount = this.fields['changecount'];
	if(changeCount === undefined)
		changeCount = 0;
	return changeCount > 0;
};

// Return the tiddler as an RSS item
Tiddler.prototype.toRssItem = function(uri)
{
	var s = [];
	s.push("<title" + ">" + this.title.htmlEncode() + "</title" + ">");
	s.push("<description>" + wikifyStatic(this.text,null,this).htmlEncode() + "</description>");
	for(var t=0; t<this.tags.length; t++)
		s.push("<category>" + this.tags[t] + "</category>");
	s.push("<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
	s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
	return s.join("\n");
};

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + this.toRssItem(uri) + "\n</item>";
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)
{
	this.assign(title,text,modifier,modified,tags,created,fields);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(this.text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(this.text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(this.text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var modifier = this.modifier;
	if(!modifier)
		modifier = config.messages.subtitleUnknown;
	var modified = this.modified;
	if(modified)
		modified = modified.toLocaleString();
	else
		modified = config.messages.subtitleUnknown;
	return config.messages.tiddlerLinkTooltip.format([this.title,modifier,modified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

Tiddler.prototype.getServerType = function()
{
	var serverType = null;
	if(this.fields && this.fields['server.type'])
		serverType = this.fields['server.type'];
	if(!serverType)
		serverType = this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType])
		serverType = null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType] : null;
};

//--
//-- TiddlyWiki() object contains Tiddler()s
//--

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for(var i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return typeof config.shadowTiddlers[title] == "string";
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0,pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		if(!section)
			return tiddler.text;
		var re = new RegExp("(^!{1,6}" + section.escapeRegExp() + "[ \t]*\n)","mg");
		re.lastIndex = 0;
		var match =  re.exec(tiddler.text);
		if(match) {
			var t = tiddler.text.substr(match.index+match[1].length);
			var re2 = /^!/mg;
			re2.lastIndex = 0;
			match = re2.exec(t); //# search for the next heading
			if(match)
				t = t.substr(0,match.index-1);//# don't include final \n
			return t;
		}
		return defaultText;
	}
	if(this.isShadowTiddler(title))
		return config.shadowTiddlers[title];
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.slicesRE = /(?:[\'\/]*~?([\.\w]+)[\'\/]*\:[\'\/]*\s*(.*?)\s*$)|(?:\|[\'\/]*~?([\.\w]+)\:?[\'\/]*\|\s*(.*?)\s*\|)/gm;

// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	do {
		var m = this.slicesRE.exec(text);
		if(m) {
			if(m[1])
				slices[m[1]] = m[2];
			else
				slices[m[3]] = m[4];
		}
	} while(m);
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var r = {};
	for(var t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"[[" + match[1] + "]]",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		this.incChangeCount(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		return;
	merge(tiddler.fields,fields);
	tiddler.changed();
	this.incChangeCount(title);
	this.notify(title,true);
	this.setDirty(true);
};

TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		created = created ? created : tiddler.created; // Preserve created date
		this.deleteTiddler(title);
	} else {
		created = created ? created : modified;
		tiddler = new Tiddler();
	}
	tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);
	this.addTiddler(tiddler);
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	var posDiv = locateStoreArea(text);
	if(!posDiv)
		return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return store.getSaver().externalize(store);
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag,match)
{
	var candidates = this.reverseLookup("tags",excludeTag,!!match);
	var results = [];
	for(var t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Returns a list of all tags in use
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
// Returns an array of arrays where [tag][0] is the name of the tag and [tag][1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			var n = true;
			for(var c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					n = false;
					results[c][1]++;
				}
			}
			if(n && excludeTag) {
				var t = store.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					n = false;
			}
			if(n)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++) {
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;
		for(var n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers) {
		if(typeof config.shadowTiddlers[t] == "string")
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter)
{
	var results = [];
	if(filter) {
		var tiddler;
		var re = /([^\s\[\]]+)|(?:\[([ \w]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;
		var match = re.exec(filter);
		while(match) {
			if(match[1] || match[4]) {
				var title = match[1] ? match[1] : match[4];
				tiddler = this.fetchTiddler(title);
				if(tiddler) {
					results.pushUnique(tiddler);
				} else if(store.isShadowTiddler(title)) {
					tiddler = new Tiddler();
					tiddler.set(title,store.getTiddlerText(title));
					results.pushUnique(tiddler);
				}
			} else if(match[2]) {
				switch(match[2]) {
					case "tag":
						var matched = this.getTaggedTiddlers(match[3]);
						for(var m = 0; m < matched.length; m++)
							results.pushUnique(matched[m]);
						break;
					case "sort":
						results = this.sortTiddlers(results,match[3]);
						break;
				}
			}
			match = re.exec(filter);
		}
	}
	return results;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers,field)
{
	var asc = +1;
	switch(field.substr(0,1)) {
		case "-":
			asc = -1;
			// Note: this fall-through is intentional
		case "+":
			field = field.substr(1);
			break;
	}
	if(TiddlyWiki.standardFieldAccess[field])
		tiddlers.sort(function(a,b) {return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);});
	else
		tiddlers.sort(function(a,b) {return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);});
	return tiddlers;
};
// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by '.'
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp('^'+fieldName+'\\.');
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	fieldName = fieldName.toLowerCase();
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	var n,result;
	for(n in t.fields) {
		result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(n in TiddlyWiki.standardFieldAccess) {
		if(n == "tiddler")
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			continue;
		result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
		if(result)
			return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

function Story(containerId,idPrefix)
{
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		return this.idPrefix + title;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.forEachTiddler = function(fn)
{
	var place = this.getContainer();
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
	}
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,tiddler,template,animate,unused,customFields,toggle)
{
	var title = (tiddler instanceof Tiddler)? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle)
			this.closeTiddler(title,true);
		else
			this.refreshTiddler(title,template,false,customFields);
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.tiddlerId(title),"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields",customFields);
	place.insertBefore(tiddlerElem,before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title,customFields,tiddlerElem);
	this.refreshTiddler(title,template,false,customFields,defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,tiddlerElem)
{
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : (fields ? fields : {});
	var serverType = tiddler.getServerType();
	var host = tiddler.fields['server.host'];
	var workspace = tiddler.fields['server.workspace'];
	if(!serverType || !host)
		return null;
	var sm = new SyncMachine(serverType,{
			start: function() {
				return this.openHost(host,"openWorkspace");
			},
			openWorkspace: function() {
				return this.openWorkspace(workspace,"getTiddler");
			},
			getTiddler: function() {
				return this.getTiddler(title,"onGetTiddler");
			},
			onGetTiddler: function(context) {
				var tiddler = context.tiddler;
				if(tiddler && tiddler.text) {
					var downloaded = new Date();
					if(!tiddler.created)
						tiddler.created = downloaded;
					if(!tiddler.modified)
						tiddler.modified = tiddler.created;
					store.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields,true,tiddler.created);
					autoSaveChanges();
				}
				delete this;
				return true;
			},
			error: function(message) {
				displayMessage("Error loading missing tiddler from %0: %1".format([host,message]));
			}
		});
	sm.go();
	return config.messages.loadingMissingTiddler.format([title,serverType,host,workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					text = defaultText ? defaultText : text;
					var fields = customFields ? customFields.decodeHashMap() : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			tiddlerElem.innerHTML = this.getTemplateForTiddler(title,template,tiddler);
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(tiddlerElem,"isTag");
			else
				removeClass(tiddlerElem,"isTag");
			if(store.tiddlerExists(title)) {
				removeClass(tiddlerElem,"shadow");
				removeClass(tiddlerElem,"missing");
			} else {
				addClass(tiddlerElem,store.isShadowTiddler(title) ? "shadow" : "missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
			forceReflow();
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fields = customFields.decodeHashMap();
	var w = document.createElement("div");
	w.style.display = "none";
	place.appendChild(w);
	for(var t in fields) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t]);
		w.appendChild(e);
		e.setAttribute("edit",t);
	}
};

Story.prototype.refreshAllTiddlers = function(force)
{
	var place = this.getContainer();
	var e = place.firstChild;
	if(!e)
		return;
	this.refreshTiddler(e.getAttribute("tiddler"),force ? null : e.getAttribute("template"),true);
	while((e = e.nextSibling) != null)
		this.refreshTiddler(e.getAttribute("tiddler"),force ? null : e.getAttribute("template"),true);
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	if(window.addClass instanceof Function)
		addClass(this,"selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	if(window.removeClass instanceof Function)
		removeClass(this,"selected");
};

Story.prototype.onTiddlerDblClick = function(ev)
{
	var e = ev ? ev : window.event;
	var theTarget = resolveTarget(e);
	if(theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	} else {
		return false;
	}
};

Story.prototype.onTiddlerKeyPress = function(ev)
{
	var e = ev ? ev : window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
		case 9: // Tab
			if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
				replaceSelection(target,String.fromCharCode(9));
				consume = true;
			}
			if(config.isOpera) {
				target.onblur = function() {
					this.focus();
					this.onblur = null;
				};
			}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey) {
				blurElement(this);
				config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
				consume = true;
			}
			break;
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
			consume = true;
			break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = this.getTiddler(title);
	var e = null;
	if(tiddlerElem != null) {
		var children = tiddlerElem.getElementsByTagName("*");
		for(var t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem != null && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = story.getTiddlerField(title,field);

	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	Story.prototype.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem != null) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
		else {
			removeNode(tiddlerElem);
			forceReflow();
		}
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem != null)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem != null)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ?	 text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	this.displayTiddlers(null,matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = this.getTiddler(title);
	if(e != null) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		var tiddler = store.fetchTiddler(title);
		if(!tiddler)
			return false;
		for(var n in fields) {
			if(store.getValue(title,n) != fields[n])
				return true;
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem != null) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title ? fields.title : title;
		if(!store.tiddlerExists(newTitle))
			newTitle = newTitle.trim();
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				return null;
		}
		if(newTitle != title)
			this.closeTiddler(newTitle,false);
		tiddlerElem.id = this.tiddlerId(newTitle);
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		if(!store.tiddlerExists(newTitle))
			minorUpdate = false;
		var newDate = new Date();
		var extendedFields = store.tiddlerExists(newTitle) ? store.fetchTiddler(newTitle).fields : (newTitle!=title && store.tiddlerExists(title) ? store.fetchTiddler(title).fields : {});
		for(var n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				extendedFields[n] = fields[n];
		}
		var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields);
		autoSaveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

Story.prototype.switchTheme = function(theme)
{
	if(safeMode)
		return;

	isAvailable = function(title) {
		var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
		if(s!=-1)
			title = title.substr(0,s);
		return store.tiddlerExists(title) || store.isShadowTiddler(title);
	};

	getSlice = function(theme,slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme,slice+"ReadOnly") || store.getTiddlerSlice(theme,"Web"+slice);
		r = r || store.getTiddlerSlice(theme,slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator)==0)
			r = theme + r;
		return isAvailable(r) ? r : slice;
	};

	replaceNotification = function(i,name,theme,slice) {
		var newName = getSlice(theme,slice);
		if(name!=newName && store.namedNotifications[i].name==name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	for(var i=0; i<config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
		case "PageTemplate":
			config.refresherData.pageTemplate = replaceNotification(i,config.refresherData.pageTemplate,theme,name);
			break;
		case "StyleSheet":
			removeStyleSheet(config.refresherData.styleSheet);
			config.refresherData.styleSheet = replaceNotification(i,config.refresherData.styleSheet,theme,name);
			break;
		case "ColorPalette":
			config.refresherData.colorPalette = replaceNotification(i,config.refresherData.colorPalette,theme,name);
			break;
		default:
			break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme,"ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme,"EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate!=pt || config.tiddlerTemplates[vi]!=vt || config.tiddlerTemplates[ei]!=et) {
			refreshAll();
			story.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet,"",10),config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOptionCookie("txtTheme");
	}
};

Story.prototype.getTiddler = function(title)
{
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function()
{
	return document.getElementById(this.containerId());
};

//--
//-- Backstage
//--

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = document.getElementById("backstageToolbar");
		this.button = document.getElementById("backstageButton");
		this.button.style.display = "block";
		var t = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
						function (e) {backstage.show(); return false;},null,"backstageShow");
		t = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
						function (e) {backstage.hide(); return false;},null,"backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		this.cloak.onmousedown = function(e) {
			backstage.switchTab(null);
		};
		createTiddlyText(this.toolbar,cmb.prompt);
		for(t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
			btn.setAttribute("task",taskName);
			addClass(btn,task.action ? "backstageAction" : "backstageTask");
			}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			var p = [
				{style: "left", start: findWindowWidth(), end: 0, template: "%0px"}
			];
			anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
		} else {
			backstage.area.style.left = "0px";
		}
		this.showButton.style.display = "none";
		this.hideButton.style.display = "block";
		config.options.chkBackstage = true;
		saveOptionCookie("chkBackstage");
		addClass(this.content,"backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			this.switchTab(null);
		} else {
			backstage.toolbar.style.left = "0px";
			if(anim && config.options.chkAnimate) {
				var p = [
					{style: "left", start: 0, end: findWindowWidth(), template: "%0px"}
				];
				var c = function(element,properties) {backstage.area.style.display = "none";};
				anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
			} else {
				this.area.style.display = "none";
			}
			this.showButton.style.display = "block";
			this.hideButton.style.display = "none";
			config.options.chkBackstage = false;
			saveOptionCookie("chkBackstage");
			removeClass(this.content,"backstageVisible");
		}
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		displayMessage(task);
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e)
			{
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
			}
		if(tabName == backstage.currTabName)
			return;
		if(backstage.currTabElem) {
			removeClass(this.currTabElem,"backstageSelTab");
		}
		if(tabElem && tabName) {
			backstage.preparePanel();
			addClass(tabElem,"backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null);
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findWindowHeight() + "px";
		backstage.cloak.style.display = "block";
		removeChildren(backstage.panelBody);
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			var p = [
				{style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}
			];
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		backstage.currTabName = null;
		backstage.currTabElem = null;
		if(anim && config.options.chkAnimate) {
			var p = [
				{style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
				{style: "display", atEnd: "none"}
			];
			var c = function(element,properties) {backstage.cloak.style.display = "none";};
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
		 } else {
			backstage.panel.style.display = "none";
			backstage.cloak.style.display = "none";
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly) {
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	var place = wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e)
{
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
	wizard.addStep(this.step1Title,this.step1Html);
	var s = wizard.getElement("selTypes");
	for(var t in config.adaptors) {
		var e = createTiddlyElement(s,"option",null,null,config.adaptors[t].serverLabel ? config.adaptors[t].serverLabel : t);
		e.value = t;
	}
	if(config.defaultAdaptor)
		s.value = config.defaultAdaptor;
	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(t in feeds) {
		e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	wizard.setValue("feeds",feeds);
	s.onchange = config.macros.importTiddlers.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = config.macros.importTiddlers.onBrowseChange;
	fileInput.onkeyup = config.macros.importTiddlers.onBrowseChange;
	wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: config.macros.importTiddlers.onOpen}]);
};

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = {};
	var tagged = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<tagged.length; t++) {
		var title = tagged[t].title;
		var serverType = store.getTiddlerSlice(title,"Type");
		if(!serverType)
			serverType = "file";
		feeds[title] = {title: title,
						url: store.getTiddlerSlice(title,"URL"),
						workspace: store.getTiddlerSlice(title,"Workspace"),
						workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
						tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
						serverType: serverType,
						description: store.getTiddlerSlice(title,"Description")};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName",f.serverType);
		wizard.setValue("feedHost",f.url);
		wizard.setValue("feedWorkspace",f.workspace);
		wizard.setValue("feedWorkspaceList",f.workspaceList);
		wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = "file://" + this.value;
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return false;
};

config.macros.importTiddlers.onOpen = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType];
	wizard.setValue("adaptor",adaptor);
	wizard.setValue("serverType",serverType);
	wizard.setValue("host",url);
	var ret = adaptor.openHost(url,null,wizard,config.macros.importTiddlers.onOpenHost);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	var ret = adaptor.getWorkspaceList(context,wizard,config.macros.importTiddlers.onGetWorkspaceList);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context",context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length==1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		var ret = context.adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);
		if(ret !== true)
			displayMessage(ret);
		wizard.setValue("workspace",workspace);
		wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);
		return;
	}
	wizard.addStep(config.macros.importTiddlers.step2Title,config.macros.importTiddlers.step2Html);
	var s = wizard.getElement("selWorkspace");
	s.onchange = config.macros.importTiddlers.onWorkspaceChange;
	for(var t=0; t<context.workspaces.length; t++) {
		var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
		e.value = context.workspaces[t].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace",null,false,true);
		for(var n=1; n<list.length; n++) {
			if(context.workspaces.findByField("title",list[n].value) == null) {
				e = createTiddlyElement(s,"option",null,null,list[n].value);
				e.value = list[n].value;
			}
		}
	}
	if(workspace) {
		t = wizard.getElement("txtWorkspace");
		t.value = workspace;
	}
	wizard.setButtons([{caption: config.macros.importTiddlers.openLabel, tooltip: config.macros.importTiddlers.openPrompt, onClick: config.macros.importTiddlers.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
	var wizard = new Wizard(this);
	var t = wizard.getElement("txtWorkspace");
	t.value  = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace",workspace);
	var context = wizard.getValue("context");
	var ret = adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var ret = adaptor.getTiddlerList(context,wizard,config.macros.importTiddlers.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
	if(context.status !== true) {
		wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.errorGettingTiddlerList);
		return;
	}
	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var n=0; n<context.tiddlers.length; n++) {
			var tiddler = context.tiddlers[n];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	// Display the listview
	wizard.addStep(config.macros.importTiddlers.step3Title,config.macros.importTiddlers.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,listedTiddlers,config.macros.importTiddlers.listViewTemplate);
	wizard.setValue("listView",listView);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = config.macros.importTiddlers.generateSystemServerName(wizard);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel},
			{caption: config.macros.importTiddlers.importLabel, tooltip: config.macros.importTiddlers.importPrompt, onClick:  config.macros.importTiddlers.doImport}
		]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(config.macros.importTiddlers.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = config.macros.importTiddlers.serverSaveTemplate.format([serverType,host,workspace]);
	store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,config.macros.importTiddlers.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		config.macros.importTiddlers.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync",chkSync);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = new Array();
	var t;
	for(t=0; t<rowNames.length; t++) {
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0) {
		if(!confirm(config.macros.importTiddlers.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}
	wizard.addStep(config.macros.importTiddlers.step4Title.format([rowNames.length]),config.macros.importTiddlers.step4Html);
	for(t=0; t<rowNames.length; t++) {
		var link = document.createElement("div");
		createTiddlyLink(link,rowNames[t],true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(link,place);
	}
	wizard.setValue("remainingImports",rowNames.length);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}
		],config.macros.importTiddlers.statusDoingImport);
	for(t=0; t<rowNames.length; t++) {
		var context = {};
		context.allowSynchronous = true;
		var inbound = adaptor.getTiddler(rowNames[t],context,wizard,config.macros.importTiddlers.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title,'server',null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous)
		store.notify(tiddler.title,true);
	var remainingImports = wizard.getValue("remainingImports")-1;
	wizard.setValue("remainingImports",remainingImports);
	if(remainingImports == 0) {
		if(context.isSynchronous) {
			store.notifyAll();
			refreshDisplay();
		}
		wizard.setButtons([
				{caption: config.macros.importTiddlers.doneLabel, tooltip: config.macros.importTiddlers.donePrompt, onClick: config.macros.importTiddlers.onClose}
			],config.macros.importTiddlers.statusDoneImport);
		autoSaveChanges();
	}
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	w.addStep(this.step1Title,this.step1Html.format([this.source,this.source]));
	w.setButtons([{caption: this.upgradeLabel, tooltip: this.upgradePrompt, onClick: this.onClickUpgrade}]);
};

config.macros.upgrade.onClickUpgrade = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(window.location.protocol != "file:") {
		alert(me.errorCantUpgrade);
		return false;
	}	
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}
	var localPath = getLocalPath(document.location.toString());
	var backupPath = getBackupPath(localPath,me.backupExtension);
	w.setValue("backupPath",backupPath);
	w.setButtons([],me.statusPreparingBackup);
	var original = loadOriginal(localPath);
	w.setButtons([],me.statusSavingBackup);
	var backup = config.browser.isIE ? ieCopyFile(backupPath,localPath) : saveFile(backupPath,original);
	if(backup != true) {
		w.setButtons([],me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}
	w.setButtons([],me.statusLoadingCore);
	var load = loadRemoteFile(me.source,me.onLoadCore,w);
	if(typeof load == "string") {
		w.setButtons([],me.errorLoadingCore);
		alert(me.errorLoadingCore);
		return false;
	}
	return false;
};

config.macros.upgrade.onLoadCore = function(status,params,responseText,url,xhr)
{
	var me = config.macros.upgrade;
	var w = params;
	var errMsg;
	if(!status)
		errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer)
		errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([],errMsg);
		alert(errMsg);
		return;
	}
	var onStartUpgrade = function(e) {
		w.setButtons([],me.statusSavingCore);
		var localPath = getLocalPath(document.location.toString());
		saveFile(localPath,responseText);
		w.setButtons([],me.statusReloadingCore);
		var backupPath = w.getValue("backupPath");
		var newLoc = document.location.toString() + '?time=' + new Date().convertToYYYYMMDDHHMM()  + '#upgrade:[[' + encodeURI(backupPath) + ']]';
		window.setTimeout(function () {window.location = newLoc;},10)
	};
	var step2 = [me.step2Html_downgrade,me.step2Html_restore,me.step2Html_upgrade][compareVersions(version,newVer) + 1];
	w.addStep(me.step2Title,step2.format([formatVersion(newVer),formatVersion(version)]));
	w.setButtons([{caption: me.startLabel, tooltip: me.startPrompt, onClick: onStartUpgrade},{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}]);
};

config.macros.upgrade.onCancel = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title,me.step3Html);
	w.setButtons([]);
	return false;
}

config.macros.upgrade.extractVersion = function(upgradeFile)
{
	var re = /^var version = \{title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return  m ? {title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])} : null;
};

function upgradeFrom(path)
{
	var importStore = new TiddlyWiki();
	var tw = loadFile(path);
	if(window.netscape !== undefined)
		tw = convertUTF8ToUnicode(tw);
	importStore.importTiddlyWiki(tw);
	importStore.forEachTiddler(function(title,tiddler) {
		if(!store.getTiddler(title)) {
			store.addTiddler(tiddler);
		}
	});
	refreshDisplay();
	saveChanges(); //# To create appropriate Markup* sections
	alert(config.messages.upgradeDone.format([formatVersion()]));
	window.location = window.location.toString().substr(0,window.location.toString().lastIndexOf('?'));
}

//--
//-- Sync macro
//--

// Synchronisation handlers
config.syncers = {};

// Sync state.
var currSync = null;

// sync macro
config.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!wikifier.isStatic)
		this.startSync(place);
};

config.macros.sync.startSync = function(place)
{
	if(currSync)
		config.macros.sync.cancelSync();
	currSync = {};
	currSync.syncList = this.getSyncableTiddlers();
	this.createSyncTasks();
	this.preProcessSyncableTiddlers();
	var wizard = new Wizard();
	currSync.wizard = wizard;
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	currSync.listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);
	this.processSyncableTiddlers();
	wizard.setButtons([
			{caption: this.syncLabel, tooltip: this.syncPrompt, onClick: this.doSync}
		]);
};

config.macros.sync.getSyncableTiddlers = function()
{
	var list = [];
	store.forEachTiddler(function(title,tiddler) {
		var syncItem = {};
		syncItem.serverType = tiddler.getServerType();
		syncItem.serverHost = tiddler.fields['server.host'];
		syncItem.serverWorkspace = tiddler.fields['server.workspace'];
		syncItem.tiddler = tiddler;
		syncItem.title = tiddler.title;
		syncItem.isTouched = tiddler.isTouched();
		syncItem.selected = syncItem.isTouched;
		syncItem.syncStatus = config.macros.sync.syncStatusList[syncItem.isTouched ? "changedLocally" : "none"];
		syncItem.status = syncItem.syncStatus.text;
		if(syncItem.serverType && syncItem.serverHost)
			list.push(syncItem);
		});
	list.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	return list;
};

config.macros.sync.preProcessSyncableTiddlers = function()
{
	for(var t=0; t<currSync.syncList.length; t++) {
		si = currSync.syncList[t];
		var ti = si.syncTask.syncMachine.generateTiddlerInfo(si.tiddler);
		si.serverUrl = ti.uri;
	}
};

config.macros.sync.processSyncableTiddlers = function()
{
	for(var t=0; t<currSync.syncList.length; t++) {
		si = currSync.syncList[t];
		si.rowElement.style.backgroundColor = si.syncStatus.color;
	}
};

config.macros.sync.createSyncTasks = function()
{
	currSync.syncTasks = [];
	for(var t=0; t<currSync.syncList.length; t++) {
		var si = currSync.syncList[t];
		var r = null;
		for(var st=0; st<currSync.syncTasks.length; st++) {
			var cst = currSync.syncTasks[st];
			if(si.serverType == cst.serverType && si.serverHost == cst.serverHost && si.serverWorkspace == cst.serverWorkspace)
				r = cst;
		}
		if(r == null) {
			si.syncTask = this.createSyncTask(si);
			currSync.syncTasks.push(si.syncTask);
		} else {
			si.syncTask = r;
			r.syncItems.push(si);
		}
	}
};

config.macros.sync.createSyncTask = function(syncItem)
{
	var st = {};
	st.serverType = syncItem.serverType;
	st.serverHost = syncItem.serverHost;
	st.serverWorkspace = syncItem.serverWorkspace;
	st.syncItems = [syncItem];
	st.syncMachine = new SyncMachine(st.serverType,{
		start: function() {
			return this.openHost(st.serverHost,"openWorkspace");
		},
		openWorkspace: function() {
			return this.openWorkspace(st.serverWorkspace,"getTiddlerList");
		},
		getTiddlerList: function() {
			return this.getTiddlerList("onGetTiddlerList");
		},
		onGetTiddlerList: function(context) {
			var tiddlers = context.tiddlers;
			for(var t=0; t<st.syncItems.length; t++) {
				var si = st.syncItems[t];
				var f = tiddlers.findByField("title",si.title);
				if(f !== null) {
					if(tiddlers[f].fields['server.page.revision'] > si.tiddler.fields['server.page.revision']) {
						si.syncStatus = config.macros.sync.syncStatusList[si.isTouched ? 'changedBoth' : 'changedServer'];
					}
				} else {
					si.syncStatus = config.macros.sync.syncStatusList.notFound;
				}
				config.macros.sync.updateSyncStatus(si);
			}
		},
		getTiddler: function(title) {
			return this.getTiddler(title,"onGetTiddler");
		},
		onGetTiddler: function(context) {
			var tiddler = context.tiddler;
			var syncItem = st.syncItems.findByField("title",tiddler.title);
			if(syncItem !== null) {
				syncItem = st.syncItems[syncItem];
				store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
				syncItem.syncStatus = config.macros.sync.syncStatusList.gotFromServer;
				config.macros.sync.updateSyncStatus(syncItem);
			}
		},
		putTiddler: function(tiddler) {
			return this.putTiddler(tiddler,"onPutTiddler");
		},
		onPutTiddler: function(context) {
			var title = context.title;
			var syncItem = st.syncItems.findByField("title",title);
			if(syncItem !== null) {
				syncItem = st.syncItems[syncItem];
				store.resetTiddler(title);
				syncItem.syncStatus = config.macros.sync.syncStatusList.putToServer;
				config.macros.sync.updateSyncStatus(syncItem);
			}
		}
	});
	st.syncMachine.go();
	return st;
};

config.macros.sync.updateSyncStatus = function(syncItem)
{
	var e = syncItem.colElements["status"];
	removeChildren(e);
	createTiddlyText(e,syncItem.syncStatus.text);
	syncItem.rowElement.style.backgroundColor = syncItem.syncStatus.color;
};

config.macros.sync.doSync = function(e)
{
	var rowNames = ListView.getSelectedRows(currSync.listView);
	for(var t=0; t<currSync.syncList.length; t++) {
		var si = currSync.syncList[t];
		if(rowNames.indexOf(si.title) != -1) {
			config.macros.sync.doSyncItem(si);
		}
	}
	return false;
};

config.macros.sync.doSyncItem = function(syncItem)
{
	var r = true;
	var sl = config.macros.sync.syncStatusList;
	switch(syncItem.syncStatus) {
		case sl.changedServer:
			r = syncItem.syncTask.syncMachine.go("getTiddler",syncItem.title);
			break;
		case sl.notFound:
		case sl.changedLocally:
		case sl.changedBoth:
			r = syncItem.syncTask.syncMachine.go("putTiddler",syncItem.tiddler);
			break;
		default:
			break;
	}
	if(r !== true)
		displayMessage("Error in doSyncItem: " + r);
};

config.macros.sync.cancelSync = function()
{
	currSync = null;
};

function SyncMachine(serverType,steps)
{
	this.serverType = serverType;
	this.adaptor = new config.adaptors[serverType];
	this.steps = steps;
}

SyncMachine.prototype.go = function(step,context)
{
	var r = context ? context.status : null;
	if(typeof r == "string") {
		this.invokeError(r);
		return r;
	}
	var h = this.steps[step ? step : "start"];
	if(!h)
		return null;
	r = h.call(this,context);
	if(typeof r == "string")
		this.invokeError(r);
	return r;
};

SyncMachine.prototype.invokeError = function(message)
{
	if(this.steps.error)
		this.steps.error(message);
};

SyncMachine.prototype.openHost = function(host,nextStep)
{
	var me = this;
	return me.adaptor.openHost(host,null,null,function(context) {me.go(nextStep,context);});
};

SyncMachine.prototype.getWorkspaceList = function(nextStep)
{
	var me = this;
	return me.adaptor.getWorkspaceList(null,null,function(context) {me.go(nextStep,context);});
};

SyncMachine.prototype.openWorkspace = function(workspace,nextStep)
{
	var me = this;
	return me.adaptor.openWorkspace(workspace,null,null,function(context) {me.go(nextStep,context);});
};

SyncMachine.prototype.getTiddlerList = function(nextStep)
{
	var me = this;
	return me.adaptor.getTiddlerList(null,null,function(context) {me.go(nextStep,context);});
};

SyncMachine.prototype.generateTiddlerInfo = function(tiddler)
{
	return this.adaptor.generateTiddlerInfo(tiddler);
};

SyncMachine.prototype.getTiddler = function(title,nextStep)
{
	var me = this;
	return me.adaptor.getTiddler(title,null,null,function(context) {me.go(nextStep,context);});
};

SyncMachine.prototype.putTiddler = function(tiddler,nextStep)
{
	var me = this;
	return me.adaptor.putTiddler(tiddler,null,null,function(context) {me.go(nextStep,context);});
};

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	removeChildren(listWrapper);
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null) {
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
		}
	}
	for(t=0; t<plugins.length; t++) {
		p = plugins[t];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
	}
	if(plugins.length == 0) {
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
	} else {
		var listView = ListView.create(listWrapper,plugins,this.listViewTemplate,this.onSelectCommand);
		wizard.setValue("listView",listView);
		wizard.setButtons([
				{caption: config.macros.plugins.removeLabel, tooltip: config.macros.plugins.removePrompt, onClick:  config.macros.plugins.doRemoveTag},
				{caption: config.macros.plugins.deleteLabel, tooltip: config.macros.plugins.deletePrompt, onClick:  config.macros.plugins.doDelete}
			]);
	}
};

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var t=0; t<rowNames.length; t++)
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
	}
};

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(t=0; t<rowNames.length; t++) {
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true);
			}
		}
	}
};

//--
//-- Message area
//--

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(linkText) {
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
	} else {
		e.appendChild(document.createTextNode(text));
	}
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		removeChildren(msgArea);
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},

	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		if(force != null || changeList == null || changeList.indexOf(title) != -1) {
			removeChildren(e);
			wikify(store.getTiddlerText(title,title),e,null,store.fetchTiddler(title));
			return true;
		} else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++) {
		var e = nodes[c], type = null;
		if(e.getAttribute  && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
	}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e) {
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
				}
				invokeMacro(e,macro,params,null,tiddler);
			}
		}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title)
{
	var stash = createTiddlyElement(document.body,"div");
	stash.style.display = "none";
	var display = story.getContainer();
	var nodes,t;
	if(display) {
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");

	isAvailable = function(title) {
		var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
		if(s!=-1)
			title = title.substr(0,s);
		return store.tiddlerExists(title) || store.isShadowTiddler(title);
	};
	if(!title || !isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable
	html = store.getRecursiveTiddlerText(title,null,10);
	wrapper.innerHTML = html;
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div",story.containerId());
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	removeNode(stash);
}

function refreshDisplay(hint)
{
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e,hint);
	}
}

function refreshPageTitle()
{
	document.title = getPageTitle();
}

function getPageTitle()
{
	var st = wikifyPlain("SiteTitle");
	var ss = wikifyPlain("SiteSubtitle");
	return st + ((st == "" || ss == "") ? "" : " - ") + ss;
}

function refreshStyles(title,doc)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc ? doc : document);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Options stuff
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? "true" : "false";},
		set: function(name,value) {config.options[name] = value == "true";}
	}
};

function loadOptionsCookie()
{
	if(safeMode)
		return;
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++) {
		var p = cookies[c].indexOf("=");
		if(p != -1) {
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			var optType = name.substr(0,3);
			if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
				config.optionHandlers[optType].set(name,value);
		}
	}
}

function saveOptionCookie(name)
{
	if(safeMode)
		return;
	var c = name + "=";
	var optType = name.substr(0,3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].get)
		c += config.optionHandlers[optType].get(name);
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

function encodeCookie(s)
{
	return escape(manualConvertUnicodeToUTF8(s));
}

function decodeCookie(s)
{
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,"")));});
}


config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
	var typeInfo = config.macros.option.types[type];
	var c = document.createElement(typeInfo.elementType);
	if(typeInfo.typeValue)
		c.setAttribute("type",typeInfo.typeValue);
	c[typeInfo.eventName] = typeInfo.onChange;
	c.setAttribute("option",opt);
	if(className)
		c.className = className;
	else
		c.className = typeInfo.className;
	if(config.optionsDesc[opt])
		c.setAttribute("title",config.optionsDesc[opt]);
	place.appendChild(c);
	if(desc != "no")
		createTiddlyText(place,config.optionsDesc[opt] ? config.optionsDesc[opt] : opt);
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e)
{
	var opt = this.getAttribute("option");
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType);
		}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: "input",
		valueField: "value",
		eventName: "onkeyup",
		className: "txtOptionInput",
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: "input",
		valueField: "checked",
		eventName: "onclick",
		className: "chkOptionInput",
		typeValue: "checkbox",
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType)
{
	config.options[opt] = value;
	saveOptionCookie(opt);
	var nodes = document.getElementsByTagName(elementType);
	for(var t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute("option");
		if(opt == optNode)
			nodes[t][valueField] = value;
		}
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var opt = (params[1] && params[1].name == "anon") ? params[1].value : getParam(params,"name",null);
	var className = (params[2] && params[2].name == "anon") ? params[2].value : getParam(params,"class",null);
	var desc = getParam(params,"desc","no");
	var type = opt.substr(0,3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var showUnknown = getParam(params,"showUnknown","no");
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var chkUnknown = wizard.getElement("chkUnknown");
	chkUnknown.checked = showUnknown == "yes";
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	wizard.setValue("listWrapper",listWrapper);
	this.refreshOptions(listWrapper,showUnknown == "yes");
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{
	var opts = [];
	for(var n in config.options) {
		var opt = {};
		opt.option = "";
		opt.name = n;
		opt.lowlight = !config.optionsDesc[n];
		opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
		if(!opt.lowlight || showUnknown)
			opts.push(opt);
	}
	opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	var listview = ListView.create(listWrapper,opts,this.listViewTemplate);
	for(n=0; n<opts.length; n++) {
		var type = opts[n].name.substr(0,3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[n].colElements['option'],type,opts[n].name,null,"no");
		}
	}
};

config.macros.options.onChangeUnknown = function(e)
{
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue("listWrapper");
	removeChildren(listWrapper);
	config.macros.options.refreshOptions(listWrapper,this.checked);
	return false;
};

//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
	}
}

function updateLanguageAttribute(s)
{
	if(config.locale) {
		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
		var m = mRE.exec(s);
		if(m) {
			var t = m[1];
			if(m[2])
				t += ' xml:lang="' + config.locale + '"';
			if(m[3])
				t += ' lang="' + config.locale + '"';
			t += ">";
			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
		}
	}
	return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + convertUnicodeToUTF8(store.getRecursiveTiddlerText(tiddlerName,"")) + "\n");
}

function updateOriginal(original,posDiv)
{
	if(!posDiv)
		posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
				convertUnicodeToUTF8(store.allTiddlersAsHtml()) + "\n" +
				original.substr(posDiv[1]);
	var newSiteTitle = convertUnicodeToUTF8(getPageTitle()).htmlEncode();
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
	revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
	revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
	revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
	return revised;
}

function locateStoreArea(original)
{
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty,tiddlers);
}

function loadOriginal(localPath)
{
	return loadFile(localPath);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	var t0 = new Date();
	var originalPath = document.location.toString();
	if(originalPath.substr(0,5) != "file:") {
		alert(config.messages.notFileUrlError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return;
	}
	saveMain(localPath,original,posDiv);
	if(config.options.chkSaveBackups)
		saveBackup(localPath,original);
	if(config.options.chkSaveEmptyTemplate)
		saveEmpty(localPath,original,posDiv);
	if(config.options.chkGenerateAnRssFeed)
		saveRss(localPath);
	if(config.options.chkDisplayInstrumentation)
		displayMessage("saveChanges " + (new Date()-t0) + " ms");
}

function saveMain(localPath,original,posDiv)
{
	var save;
	try {
		var revised = updateOriginal(original,posDiv);
		save = saveFile(localPath,revised);
	} catch (ex) {
		showException(ex);
	}
	if(save) {
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
	} else {
		alert(config.messages.mainFailed);
	}
}

function saveBackup(localPath,original)
{
	var backupPath = getBackupPath(localPath);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(backup)
		displayMessage(config.messages.backupSaved,"file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath,original,posDiv)
{
	var emptyPath,p;
	if((p = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0,p) + "/";
	else if((p = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0,p) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";
	var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath,empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved,"file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

function saveRss(localPath)
{
	var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
	if(saveFile(rssPath,convertUnicodeToUTF8(generateRss())))
		displayMessage(config.messages.rssSaved,"file://" + rssPath);
	else
		alert(config.messages.rssFailed);
}

function getLocalPath(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath,title,extension)
{
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + slash + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + ".";
	if(title)
		backupPath += title.replace(/[\\\/\*\?\":<> ]/g,"_") + ".";
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension ? extension : "html");
	return backupPath;
}

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlain("SiteTitle").htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for(var t=tiddlers.length-1; t>=n; t--) {
		s.push("<item>\n" + tiddlers[t].toRssItem(u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}


//--
//-- Filesystem code
//--

function convertUTF8ToUnicode(u)
{
	return window.netscape == undefined ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return (fin.length > 0) ? s+fin : s;
}

function convertUnicodeToUTF8(s)
{
	if(window.netscape == undefined)
		return manualConvertUnicodeToUTF8(s);
	else
		return mozConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
	var re = /[^\u0000-\u007F]/g ;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

function copyFile(dest,source)
{
	return config.browser.isIE ? ieCopyFile(dest,source) : false;
}

function saveFile(fileUrl,content)
{
	var r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	return r;
}

function loadFile(fileUrl)
{
	var r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

function ieCreatePath(path)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	var pos = path.lastIndexOf("\\");
	if(pos!=-1)
		path = path.substring(0, pos+1);

	var scan = [];
	scan.push(path);
	var i = 0;
	do {
		var parent = fso.GetParentFolderName(scan[i++]);
		if(fso.FolderExists(parent))
			break;
		scan.push(parent);
	} while(true);

	for(i=scan.length-1;i>=0;i--) {
		if(!fso.FolderExists(scan[i]))
			fso.CreateFolder(scan[i]);
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x20|0x02,00004,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,00004,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			var contents = sInputStream.read(sInputStream.available());
			sInputStream.close();
			inputStream.close();
			return contents;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	if(i > 0)
		return url.substring(i-1);
	return url;
}

function javaSaveFile(filePath,content)
{
	try {
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
	} catch(ex) {
	}
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	try {
		if(document.applets["TiddlySaver"])
			return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
	} catch(ex) {
	}
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
	} catch(ex) {
		return null;
	}
	return content.join("\n");
}

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor()
{
	this.host = null;
	this.store = null;
	return this;
}

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.prototype.setContext = function(context,userParams,callback)
{
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = FileAdaptor.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

FileAdaptor.fullHostName = function(host)
{
	if(!host)
		return '';
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	return host;
};

FileAdaptor.minHostName = function(host)
{
	return host ? host.replace(/^http:\/\//,'').replace(/\/$/,'') : '';
};

// Open the specified host
FileAdaptor.prototype.openHost = function(host,context,userParams,callback)
{
	this.host = host;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {context.callback(context,userParams);},10);
	return true;
};

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText))
			context.statusText = config.messages.invalidFileError.format([url]);
	}
	context.complete(context,context.userParams);
};

// Get the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.workspaces = [{title:"(default)"}];
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Open the specified workspace
FileAdaptor.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
	this.workspace = workspace;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback,filter)
{
	context = this.setContext(context,userParams,callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		var ret = context.complete(context,context.userParams);
	} else {
		ret = loadRemoteFile(context.host,FileAdaptor.loadTiddlyWikiCallback,context);
		if(typeof ret != "string")
			ret = true;
	}
	return ret;
};

FileAdaptor.getTiddlerListComplete = function(context,userParams)
{
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title,tiddler) {context.tiddlers.push(tiddler);});
		}
		for(var i=0; i<context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = FileAdaptor.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
	var info = {};
	info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
	return info;
};

// Retrieve a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	return context.adaptor.store ?
		context.complete(context,context.userParams) :
		loadRemoteFile(context.host,FileAdaptor.loadTiddlyWikiCallback,context);
};

FileAdaptor.getTiddlerComplete = function(context,userParams)
{
	var t = context.adaptor.store.fetchTiddler(context.title);
	t.fields['server.type'] = FileAdaptor.serverType;
	t.fields['server.host'] = FileAdaptor.minHostName(context.host);
	t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
	context.tiddler = t;
	context.status = true;
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context,userParams);
	} else {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.close = function()
{
	delete this.store;
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- Remote HTTP requests
//--

function loadRemoteFile(url,callback,params)
{
	return doHttp("GET",url,null,null,null,null,callback,params,null);
}

// HTTP status codes
var httpStatus = {
	OK: 200,
	ContentCreated: 201,
	NoContent: 204,
	MultiStatus: 207,
	Unauthorized: 401,
	Forbidden: 403,
	NotFound: 404,
	MethodNotAllowed: 405
};

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	var x = getXMLHttpRequest();
	if(!x)
		return "Can't create XMLHttpRequest object";
	x.onreadystatechange = function() {
		try {
			var status = x.status;
		} catch(ex) {
			status = false;
		}
		if(x.readyState == 4 && callback && (status !== undefined)) {
			if([0, httpStatus.OK, httpStatus.ContentCreated, httpStatus.NoContent, httpStatus.MultiStatus].contains(status))
				callback(true,params,x.responseText,url,x);
			else
				callback(false,params,null,url,x);
			x.onreadystatechange = function(){};
			x = null;
		}
	};
	if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	try {
		if(!allowCache)
			url = url + (url.indexOf("?") < 0 ? "?" : "&") + "nocache=" + Math.random();
		x.open(type,url,true,username,password);
		if(data)
			x.setRequestHeader("Content-Type", contentType ? contentType : "application/x-www-form-urlencoded");
		if(x.overrideMimeType)
			x.setRequestHeader("Connection", "close");
		if(headers) {
			for(var n in headers)
				x.setRequestHeader(n,headers[n]);
		}
		x.setRequestHeader("X-Requested-With", "TiddlyWiki " + formatVersion());
		x.send(data);
	} catch(ex) {
		return exceptionText(ex);
	}
	return x;
}

function getXMLHttpRequest()
{
	try {
		var x = new XMLHttpRequest(); // Modern
	} catch(ex) {
		try {
			x = new ActiveXObject("Msxml2.XMLHTTP"); // IE 6
		} catch (ex2) {
			return null;
		}
	}
	return x;
}

//--
//-- TiddlyWiki-specific utility functions
//--

formatVersion = function(v)
{
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision + (v.beta ? " (beta " + v.beta + ")" : "");
};

compareVersions = function(v1,v2)
{
	var a = ["major","minor","revision"];
	for(var i = 0; i<a.length; i++) {
		var x1 = v1[a[i]] || 0;
		var x2 = v2[a[i]] || 0;
		if(x1<x2)
			return 1;
		if(x1>x2)
			return -1;
	}
	x1 = v1.beta || 9999;
	x2 = v2.beta || 9999;
	if(x1<x2)
		return 1;
	return x1 > x2 ? -1 : 0;
};

function createTiddlyButton(parent,text,tooltip,action,className,id,accessKey,attribs)
{
	var btn = document.createElement("a");
	if(action) {
		btn.onclick = action;
		btn.setAttribute("href","javascript:;");
	}
	if(tooltip)
		btn.setAttribute("title",tooltip);
	if(text)
		btn.appendChild(document.createTextNode(text));
	btn.className = className ? className : "button";
	if(id)
		btn.id = id;
	if(attribs) {
		for(var n in attribs) {
			btn.setAttribute(n,attribs[n]);
		}
	}
	if(parent)
		parent.appendChild(btn);
	if(accessKey)
		btn.setAttribute("accessKey",accessKey);
	return btn;
}

function createTiddlyLink(place,title,includeText,className,isStatic,linkedFromTiddler,noToggle)
{
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,className);
	var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	if(noToggle)
		btn.setAttribute("noToggle","true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields",fields);
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			classes.pushUnique("shadow");
		} else {
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
			classes.remove("shadow");
		}
	}
	if(typeof config.annotations[title]=="string")
		subTitle = config.annotations[title];
	return {classes: classes.join(" "),subTitle: subTitle};
}

function createExternalLink(place,url)
{
	var link = document.createElement("a");
	link.className = "externalLink";
	link.href = url;
	link.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	place.appendChild(link);
	return link;
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev)
{
	var e = ev ? ev : window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f,config.defaultCustomFields,true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target,title,null,true,null,fields,toggling);
	}
	clearMessage();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler,title,tooltip)
{
	var btn = createTiddlyButton(place,title||tag,(tooltip||config.views.wikified.tag.tooltip).format([tag]),onClickTag);
	btn.setAttribute("tag",tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler",excludeTiddler);
	return btn;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev)
{
	var e = ev ? ev : window.event;
	var popup = Popup.create(this);
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = store.getTaggedTiddlers(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev)
{
	var e = ev ? ev : window.event;
	var tag = this.getAttribute("tag");
	var tagged = store.getTaggedTiddlers(tag);
	story.displayTiddlers(this,tagged);
	return false;
}

function onClickError(ev)
{
	var e = ev ? ev : window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	for(var t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		if(options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
	if(tiddler.text) {
		createTiddlyLink(place,caption,true);
		var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place,caption);
	}
}

function onClickTiddlyPopup(ev)
{
	var e = ev ? ev : window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this,"div","popupTiddler");
		wikify(tiddler.text,popup,null,tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
	for(p in src) {
		if(!preserveExisting || dst[p] === undefined)
			dst[p] = src[p];
	}
	return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description ? e.description : e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

function glyph(name)
{
	var g = config.glyphs;
	var b = g.currBrowser;
	if(b == null) {
		b = 0;
		while(!g.browsers[b]() && b < g.browsers.length-1)
			b++;
		g.currBrowser = b;
	}
	if(!g.codes[name])
		return "";
	return g.codes[name][b];
}


//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() //# Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
	switch(style) {
		case "-tw-vertScroll":
			window.scrollTo(findScrollX(),value);
			break;
		case "-tw-horizScroll":
			window.scrollTo(value,findScrollY());
			break;
		default:
			element.style[style] = value;
			break;
	}
};

Morpher.prototype.stop = function()
{
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element,p.style,p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
	var currTime = Number(new Date());
	progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template ? p.template : "%0";
			switch(p.format) {
				case undefined:
				case "style":
					var v = p.start + (p.end-p.start) * progress;
					this.assignStyle(this.element,p.style,template.format([v]));
					break;
				case "color":
					break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
	var e = createTiddlyElement(document.body,"div",null,"zoomer");
	createTiddlyElement(e,"div",null,null,text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
		{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
		{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
		{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
		{style: 'fontSize', start: 8, end: 24, template: '%0pt'}
	];
	var c = function(element,properties) {removeNode(element);};
	return new Morpher(e,config.animDuration,p,c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement,unused)
{
	var p = [
		{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}
	];
	return new Morpher(targetElement,config.animDuration,p);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
	element.style.overflow = 'hidden';
	if(opening)
		element.style.height = '0px'; // Resolves a Firefox flashing bug
	element.style.display = 'block';
	var left = findPosX(element);
	var width = element.scrollWidth;
	var height = element.scrollHeight;
	var winWidth = findWindowWidth();
	var p = [];
	var c = null;
	if(opening) {
		p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
		p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
		p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
	} else {
		p.push({style: 'height', start: height, end: 0, template: '%0px'});
		p.push({style: 'display', atEnd: 'none'});
		p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
		p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
		switch(deleteMode) {
			case "all":
				c = function(element,properties) {removeNode(element);};
				break;
			case "children":
				c = function(element,properties) {removeChildren(element);};
				break;
		}
	}
	return new Morpher(element,config.animDuration,p,c);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,theClass)
{
	var stackPosition = this.find(root,"popup");
	Popup.remove(stackPosition+1);
	var popup = createTiddlyElement(document.body,elem ? elem : "ol","popup",theClass ? theClass : "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(ev)
{
	var e = ev ? ev : window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign,halign,offset)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup,valign,halign,offset);
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,valign,halign,offset)
{
	if(!offset)
		var offset = {x:0,y:0};
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == 'right') ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == 'top') ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == 'right')
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e)
{
	var pos = -1;
	for (var t=this.stack.length-1; t>=0; t--) {
		if(isDescendant(e,this.stack[t].popup))
			pos = i;
	}
	return pos;
};

Popup.remove = function(pos)
{
	if(!pos) var pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		removeNode(p.popup);
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem)
{
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value)
{
	if(this.formElem)
		this.formElem[name] = value;
};

Wizard.prototype.getValue = function(name)
{
	return this.formElem ? this.formElem[name] : null;
};

Wizard.prototype.createWizard = function(place,title)
{
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
};

Wizard.prototype.clear = function()
{
	removeChildren(this.bodyElem);
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
	removeChildren(this.footElem);
	for(var t=0; t<buttonInfo.length; t++) {
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		insertSpacer(this.footElem);
		}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem,"span",null,"status",status);
	}
};

Wizard.prototype.addStep = function(stepTitle,html)
{
	removeChildren(this.bodyElem);
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className ? className : "listView twtable");
	var thead = createTiddlyElement(table,"thead");
	var r = createTiddlyElement(thead,"tr");
	for(var t=0; t<listTemplate.columns.length; t++) {
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader)
			colType.createHeader(c,columnTemplate,t);
	}
	var tbody = createTiddlyElement(table,"tbody");
	for(var rc=0; rc<listObject.length; rc++) {
		rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(c=0; c<listTemplate.rowClasses.length; c++) {
			if(rowObject[listTemplate.rowClasses[c].field])
				addClass(r,listTemplate.rowClasses[c].className);
		}
		rowObject.rowElement = r;
		rowObject.colElements = {};
		for(var cc=0; cc<listTemplate.columns.length; cc++) {
			c = createTiddlyElement(r,"td");
			columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem)
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
			rowObject.colElements[field] = c;
		}
	}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons) {
		for(t=0; t<listTemplate.buttons.length; t++) {
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e) {
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for(var t=0; t<checkboxes.length; t++) {
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if(rn) {
				callback(cb,rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				wikify(v,place,null,null);
		}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined && v.title)
				createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
		}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var t = 0;
				while(t<config.messages.sizeTemplates.length-1 && v<config.messages.sizeTemplates[t].unit)
					t++;
				createTiddlyText(place,config.messages.sizeTemplates[t].template.format([Math.round(v/config.messages.sizeTemplates[t].unit)]));
			}
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createTiddlyText(createExternalLink(place,v),c ? c : v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				for(var t=0; t<v.length; t++) {
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
				}
			}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
			}
		}
};

//--
//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
//--

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return c;
};

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	for(var i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	for(var t=0; t<this.length; t++) {
		if(this[t][field] == value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	for(var i=0; i<items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	for(var i = 0; i<items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique === false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

if(!Array.prototype.map) {
Array.prototype.map = function(fn,thisObj)
{
	var scope = thisObj || window;
	var a = [];
	for(var i=0, j=this.length; i < j; ++i) {
		a.push(fn.call(scope,this[i],i,this));
	}
	return a;
};}

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1) {
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
String.prototype.toJSONString = function()
{
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval)
					n = window.eval(n);
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
	var p = this.parseParams("list",null,true,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++) {
		if(p[t].value)
			n.pushUnique(p[t].value,unique);
	}
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end)
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var results = [];
		for(var t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
	var fields = this.parseParams("anon","",false);
	var r = {};
	for(var t=1; t<fields.length; t++)
		r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
	var r = [];
	for(var t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix)
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	t = t.replace(/TZD/g,(tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60),2) + ':' + String.zeroPad(atz % 60,2));
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return this.getFullYear() + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4);
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	var hh = d.substr(8,2) || "00";
	var mm = d.substr(10,2) || "00";
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(hh,10),
			parseInt(mm,10),0,0));
};


//--
//-- Crypto functions and associated conversion routines
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	var be=Array();
	var len=Math.floor(str.length/4);
	var i, j;
	for(i=0, j=0; i<len; i++, j+=4) {
		be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
	}
	while(j<str.length) {
		be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
		j++;
	}
	return be;
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	var str='';
	for(var i=0;i<be.length*32;i+=8)
		str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
	return str;
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	var hex='0123456789ABCDEF';
	var str='';
	for(var i=0;i<be.length*4;i++)
		str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
	return str;
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return Crypto.be32sToHex(Crypto.sha1Str(str));
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return Crypto.sha1(Crypto.strToBe32s(str),str.length);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	// Add 32-bit integers, wrapping at 32 bits
	function add32(a,b)
	{
		var lsw=(a&0xFFFF)+(b&0xFFFF);
		var msw=(a>>16)+(b>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	}
	function AA(a,b,c,d,e)
	{
		b=(b>>>27)|(b<<5);
		var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
		var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	}
	function RR(w,j)
	{
		var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
		return (n>>>31)|(n<<1);
	}

	var len=blen*8;
	x[len>>5] |= 0x80 << (24-len%32);
	x[((len+64>>9)<<4)+15]=len;
	var w=Array(80);

	var k1=0x5A827999;
	var k2=0x6ED9EBA1;
	var k3=0x8F1BBCDC;
	var k4=0xCA62C1D6;

	var h0=0x67452301;
	var h1=0xEFCDAB89;
	var h2=0x98BADCFE;
	var h3=0x10325476;
	var h4=0xC3D2E1F0;

	for(var i=0;i<x.length;i+=16) {
		var j=0;
		var t;
		var a=h0;
		var b=h1;
		var c=h2;
		var d=h3;
		var e=h4;
		while(j<16) {
			w[j]=x[i+j];
			t=AA(e,a,d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
		}
		while(j<20) {
			w[j]=RR(w,j);
			t=AA(e,a,d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
		}
		while(j<40) {
			w[j]=RR(w,j);
			t=AA(e,a,b^c^d,w[j],k2);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
		}
		while(j<60) {
			w[j]=RR(w,j);
			t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
		}
		while(j<80) {
			w[j]=RR(w,j);
			t=AA(e,a,b^c^d,w[j],k4);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
		}
		h0=add32(h0,a);
		h1=add32(h1,b);
		h2=add32(h2,c);
		h3=add32(h3,d);
		h4=add32(h4,e);
	}
	return [h0,h1,h2,h3,h4];
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	return "#" + ("0" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function drawGradient(place,horiz,locolors,hicolors)
{
	if(!hicolors)
		hicolors = locolors;
	for(var t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var p = t/100*(locolors.length-1);
		bar.style.backgroundColor = hicolors[Math.floor(p)].mix(locolors[Math.ceil(p)],p-Math.floor(p)).toString();
	}
}

function createTiddlyText(parent,text)
{
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,parent);
	return cb;
}

function createTiddlyElement(parent,element,id,className,text,attribs)
{
	var e = document.createElement(element);
	if(className != null)
		e.className = className;
	if(id != null)
		e.setAttribute("id",id);
	if(text != null)
		e.appendChild(document.createTextNode(text));
	if(attribs) {
		for(var n in attribs) {
			e.setAttribute(n,attribs[n]);
		}
	}
	if(parent != null)
		parent.appendChild(e);
	return e;
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj['e'+type+fn] = fn;
		obj[type+fn] = function(){obj['e'+type+fn](window.event);};
		obj.attachEvent('on'+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent('on'+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}

function addClass(e,className)
{
	var currClass = e.className.split(" ");
	if(currClass.indexOf(className) == -1)
		e.className += " " + className;
}

function removeClass(e,className)
{
	var currClass = e.className.split(" ");
	var i = currClass.indexOf(className);
	while(i != -1) {
		currClass.splice(i,1);
		i = currClass.indexOf(className);
	}
	e.className = currClass.join(" ");
}

function hasClass(e,className)
{
	if(e.className) {
		if(e.className.split(" ").indexOf(className) != -1)
			return true;
	}
	return false;
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name ? name : "tagName";
	relative = relative ? relative : "parentNode";
	if(name == "className") {
		while(e && !hasClass(e,value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

// Prevent an event from bubbling
function stopEvent(e)
{
	var ev = e ? e : window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	var text = "";
	if(e.innerText)
		text = e.innerText;
	else if(e.textContent)
		text = e.textContent;
	return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth ? window.innerWidth : document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight ? window.innerHeight : document.documentElement.clientHeight;
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX ? window.scrollX : document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY ? window.scrollY : document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e != null && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Remove all children of a node
function removeChildren(e)
{
	while(e && e.hasChildNodes())
		removeNode(e.firstChild);
}

// Remove a node and all it's children
function removeNode(e)
{
	scrubNode(e);
	e.parentNode.removeChild(e);
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
	if(!config.browser.isIE)
		return;
	var att = e.attributes;
	if(att) {
		for(var t=0; t<att.length; t++) {
			var n = att[t].name;
			if(n !== 'style' && (typeof e[n] === 'function' || (typeof e[n] === 'object' && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id,doc)
{
	if(!id)
		id = "customStyleSheet";
	if(!doc)
		doc = document;
	var n = doc.getElementById(id);
	if(doc.createStyleSheet) {
		// Test for IE's non-standard createStyleSheet method
		if(n)
			n.parentNode.removeChild(n);
		// This failed without the &nbsp;
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
	} else {
		if(n) {
			n.replaceChild(doc.createTextNode(s),n.firstChild);
		} else {
			n = doc.createElement("style");
			n.type = "text/css";
			n.id = id;
			n.appendChild(doc.createTextNode(s));
			doc.getElementsByTagName("head")[0].appendChild(n);
		}
	}
}

function removeStyleSheet(id)
{
	var e = document.getElementById(id);
	if(e)
		e.parentNode.removeChild(e);
}

// Force the browser to do a document reflow when needed to workaround browser bugs
function forceReflow()
{
	if(config.browser.isGecko) {
		setStylesheet("body {top:0px;margin-top:0px;}","forceReflow");
		setTimeout(function() {setStylesheet("","forceReflow");},1);
	}
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split('\n').length;
		var thisline = e.value.substr(0,e.selectionStart).split('\n').length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart('character', -text.length);
				range.select();
			}
		}
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = "";
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e,ancestor)
{
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(safeMode && store.isShadowTiddler(title))
		return;
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var tiddlers = [];
	for(var t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var tiddlers = store.getTiddlers("title");
	for(var t = 0; t < tiddlers.length; t++) {
		if(!tiddlers[t].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[t]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if(node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMM(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMM(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var attrs = node.attributes;
	for(var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.options.chkUsePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if(typeof value != "string")
					value = "";
				if(!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created;
		var modified = tiddler.modified;
		var attributes = tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && created == version.date) ? "" :' created="' + created.convertToYYYYMMDDHHMM() + '"';
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() +'"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return ('<div %0="%1"%2%3>%4</'+'div>').format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};

//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
